<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>eulfedora.models &mdash; OpenEmory 2.2.8-dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.2.8-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="OpenEmory 2.2.8-dev documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenEmory 2.2.8-dev documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for eulfedora.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># file eulfedora/models.py</span>
<span class="c1">#</span>
<span class="c1">#   Copyright 2010,2011 Emory University Libraries</span>
<span class="c1">#</span>
<span class="c1">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#   you may not use this file except in compliance with the License.</span>
<span class="c1">#   You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#       http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#   See the License for the specific language governing permissions and</span>
<span class="c1">#   limitations under the License.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">URIRef</span><span class="p">,</span> <span class="n">Graph</span> <span class="k">as</span> <span class="n">RdfGraph</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="kn">import</span> <span class="n">ElementMaker</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">eulxml</span> <span class="kn">import</span> <span class="n">xmlmap</span>
<span class="kn">from</span> <span class="nn">eulfedora.api</span> <span class="kn">import</span> <span class="n">ResourceIndex</span>
<span class="kn">from</span> <span class="nn">eulfedora.rdfns</span> <span class="kn">import</span> <span class="n">model</span> <span class="k">as</span> <span class="n">modelns</span><span class="p">,</span> <span class="n">relsext</span> <span class="k">as</span> <span class="n">relsextns</span><span class="p">,</span> <span class="n">fedora_rels</span>
<span class="kn">from</span> <span class="nn">eulfedora.util</span> <span class="kn">import</span> <span class="n">parse_xml_object</span><span class="p">,</span> <span class="n">parse_rdf</span><span class="p">,</span> <span class="n">RequestFailed</span><span class="p">,</span> \
    <span class="n">datetime_to_fedoratime</span><span class="p">,</span> <span class="n">force_bytes</span><span class="p">,</span> <span class="n">force_text</span>
<span class="kn">from</span> <span class="nn">eulfedora.xml</span> <span class="kn">import</span> <span class="n">ObjectDatastreams</span><span class="p">,</span> <span class="n">ObjectProfile</span><span class="p">,</span> <span class="n">DatastreamProfile</span><span class="p">,</span> \
    <span class="n">NewPids</span><span class="p">,</span> <span class="n">ObjectHistory</span><span class="p">,</span> <span class="n">ObjectMethods</span><span class="p">,</span> <span class="n">DsCompositeModel</span><span class="p">,</span> <span class="n">FoxmlDigitalObject</span><span class="p">,</span> \
    <span class="n">DatastreamHistory</span>
<span class="kn">from</span> <span class="nn">eulxml.xmlmap.dc</span> <span class="kn">import</span> <span class="n">DublinCore</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DatastreamObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Object to ease accessing and updating a datastream belonging to a Fedora</span>
<span class="sd">    object.  Handles datastream content as well as datastream profile information.</span>
<span class="sd">    Content and datastream info are only pulled from Fedora when content and info</span>
<span class="sd">    fields are accessed.</span>

<span class="sd">    Intended to be used with :class:`DigitalObject` and intialized</span>
<span class="sd">    via :class:`Datastream`.</span>

<span class="sd">    Initialization parameters:</span>
<span class="sd">        :param obj: the :class:`DigitalObject` that this datastream belongs to.</span>
<span class="sd">        :param id: datastream id</span>
<span class="sd">        :param label: default datastream label</span>
<span class="sd">        :param mimetype: default datastream mimetype</span>
<span class="sd">        :param versionable: default configuration for datastream versioning</span>
<span class="sd">        :param state: default configuration for datastream state</span>
<span class="sd">            (default: A [active])</span>
<span class="sd">        :param format: default configuration for datastream format URI</span>
<span class="sd">        :param control_group: default configuration for datastream control group</span>
<span class="sd">            (default: M [managed])</span>
<span class="sd">        :param checksum: default configuration for datastream checksum</span>
<span class="sd">        :param checksum_type: default configuration for datastream checksum type</span>
<span class="sd">            (default: MD5)</span>
<span class="sd">        :param as_of_date: load a historical version of this datastream as of</span>
<span class="sd">            a particular date time. (Note that historical datastream versions</span>
<span class="sd">            are for access only, and cannot be saved.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_mimetype</span> <span class="o">=</span> <span class="s2">&quot;application/octet-stream&quot;</span>

    <span class="n">ds_location</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&#39;&#39;&#39;Datastream content location: set this attribute to a URI that</span>
<span class="sd">    Fedora can resolve (e.g., http:// or file://) in order to add or</span>
<span class="sd">    update datastream content from a known, accessible location,</span>
<span class="sd">    rather than posting via :attr:`content`.  If :attr:`ds_location`</span>
<span class="sd">    is set, it takes precedence over :attr:`content`.&#39;&#39;&#39;</span>

    <span class="n">as_of_date</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="s1">&#39;optional datetime for accessing a historical datastream version&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">versionable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">control_group</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checksum_type</span><span class="o">=</span><span class="s2">&quot;MD5&quot;</span><span class="p">,</span>
            <span class="n">as_of_date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">as_of_date</span> <span class="o">=</span> <span class="n">as_of_date</span>

        <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mimetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_mimetype</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
            <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="n">mimetype</span><span class="p">,</span>
            <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="n">versionable</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">format</span><span class="p">,</span>
            <span class="s1">&#39;control_group&#39;</span><span class="p">:</span> <span class="n">control_group</span><span class="p">,</span>
            <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="n">checksum</span><span class="p">,</span>
            <span class="s1">&#39;checksumType&#39;</span><span class="p">:</span> <span class="n">checksum_type</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># for unversioned datastreams, store a copy of data pulled</span>
        <span class="c1"># from fedora in case undo save is required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info_backup</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_backup</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digest</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum_modified</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Flag to indicate whether this datastream exists in fedora.</span>
        <span class="c1"># Assume false until/unless we can confirm otherwise.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="c1"># If this datastream belongs to an existing object, check</span>
            <span class="c1"># to see if the datastream actually exists.</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">ds_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># pull datastream profile information from Fedora, but only when accessed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bootstrap_info</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">getDatastreamProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">as_of_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>

    <span class="k">def</span> <span class="nf">_bootstrap_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">DatastreamProfile</span><span class="p">()</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mimetype&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">control_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;control_group&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">versionable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;versionable&#39;</span><span class="p">]</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">checksum_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;checksumType&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">profile</span>

    <span class="k">def</span> <span class="nf">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Pull datastream content from Fedora and return it as a string, but</span>
        <span class="c1"># only when accessed. Note that this will load the entire datastream</span>
        <span class="c1"># contents into memory as a string. This is probably a bad idea for</span>
        <span class="c1"># large files. Thus:</span>
        <span class="c1"># TODO: Once we have an eulfedora.api call that returns</span>
        <span class="c1"># iterable chunks of datastream content, we need to either update</span>
        <span class="c1"># this property or add another to expose that iterable chunk</span>
        <span class="c1"># functionality at this layer.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bootstrap_content</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getDatastreamDissemination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">asOfDateTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">as_of_date</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_content</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="c1"># calculate and store a digest of the current datastream text content</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_digest</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span>

    <span class="k">def</span> <span class="nf">_set_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c1"># if datastream is not versionable, grab contents before updating</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">content</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_content</span><span class="p">,</span> <span class="n">_set_content</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
        <span class="sd">&#39;&#39;&#39;contents of the datastream; for existing datastreams,</span>
<span class="sd">        content is only pulled from Fedora when first requested, and</span>
<span class="sd">        cached after first access; can be used to set or update</span>
<span class="sd">        datastream contents by means of text content or a file-like</span>
<span class="sd">        object.  For example, if you have a :class:`DigitalObject`</span>
<span class="sd">        subclass with a :class:`FileDatastream` defined as ``image``::</span>

<span class="sd">            with open(filename) as imgfile:</span>
<span class="sd">                myobj.image.content = imgfile</span>

<span class="sd">        For an alternate method to set datastream content, see</span>
<span class="sd">        :attr:`ds_location`.&#39;&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="c1"># convert output of getDatastreamDissemination into the expected content type</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_bootstrap_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_content_as_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># used for serializing inline xml datastreams at ingest</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_raw_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return datastream content in the appropriate format to be saved to Fedora</span>
        <span class="c1"># (normally, either a string or a file); used for serializing</span>
        <span class="c1"># managed datastreams for ingest and save and generating a hash</span>
        <span class="c1"># NOTE: if you override so this does not return a string, you may</span>
        <span class="c1"># also need to override _content_digest and/or isModified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;serialize&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">force_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">serialize</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">force_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if either the datastream content or profile fields have changed</span>
<span class="sd">        and should be saved to Fedora.</span>

<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: only check content digest if locally cached content is set</span>
        <span class="c1"># (content already pulled or new content set); otherwise this</span>
        <span class="c1"># results in pulling content down to checksum it !</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="ow">or</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_digest</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest</span>

    <span class="k">def</span> <span class="nf">_content_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># generate a hash of the content so we can easily check if it has changed and should be saved</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content</span><span class="p">()</span>
        <span class="c1"># handle case where datastream is empty or does not yet exist</span>
        <span class="k">if</span> <span class="n">raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">force_bytes</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="c1">### access to datastream profile fields; tracks if changes are made for saving to Fedora</span>

    <span class="k">def</span> <span class="nf">_get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">label</span>

    <span class="k">def</span> <span class="nf">_set_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">label</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_label</span><span class="p">,</span> <span class="n">_set_label</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;datastream label&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mimetype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">mimetype</span>

    <span class="k">def</span> <span class="nf">_set_mimetype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">mimetype</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_mimetype</span><span class="p">,</span> <span class="n">_set_mimetype</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;datastream mimetype&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_versionable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">versionable</span>

    <span class="k">def</span> <span class="nf">_set_versionable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">versionable</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">versionable</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_versionable</span><span class="p">,</span> <span class="n">_set_versionable</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s2">&quot;boolean; indicates if Fedora is configured to version the datastream&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">state</span>

    <span class="k">def</span> <span class="nf">_set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">state</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_state</span><span class="p">,</span> <span class="n">_set_state</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;datastream state (Active/Inactive/Deleted)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span>

    <span class="k">def</span> <span class="nf">_set_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">format</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_format</span><span class="p">,</span> <span class="n">_set_format</span><span class="p">,</span> <span class="s2">&quot;datastream format URI&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">checksum</span>

    <span class="k">def</span> <span class="nf">_set_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checksum_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">checksum</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_checksum</span><span class="p">,</span> <span class="n">_set_checksum</span><span class="p">,</span> <span class="s2">&quot;datastream checksum&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_checksumType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">checksum_type</span>

    <span class="k">def</span> <span class="nf">_set_checksumType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">checksum_type</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">checksum_type</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_checksumType</span><span class="p">,</span> <span class="n">_set_checksumType</span><span class="p">,</span> <span class="s2">&quot;datastream checksumType&quot;</span><span class="p">)</span>

    <span class="c1"># read-only info properties</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">control_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">control_group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">created</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">created</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Size of the datastream content&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># FIXME: not actually available in datastreamProfile !!</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">modified</span>

    <span class="k">def</span> <span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE: last_modified may actually be the &#39;created&#39; date for</span>
        <span class="c1"># the current version of the datastream.</span>

        <span class="c1"># FIXME: **preliminary** actual last-modified, since the above does not</span>
        <span class="c1"># actually work - should probably cache ds history...</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">()</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">created</span>  <span class="c1"># fedora returns most recent first</span>

    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get history/version information for this datastream and</span>
<span class="sd">        return as an instance of</span>
<span class="sd">        :class:`~eulfedora.xml.DatastreamHistory`.&#39;&#39;&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getDatastreamHistory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">DatastreamHistory</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logmessage</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save datastream content and any changed datastream profile</span>
<span class="sd">        information to Fedora.</span>

<span class="sd">        :rtype: boolean for success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_of_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Saving is not implemented for datastream versions&#39;</span><span class="p">)</span>

        <span class="n">save_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;dsLabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mimetype</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mimetype</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;versionable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionable</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;dsState&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;formatURI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum_modified</span><span class="p">:</span>
                    <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum_type</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;checksumType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum_type</span>
            <span class="c1"># FIXME: should be able to handle checksums</span>
        <span class="c1"># NOTE: as of Fedora 3.2, updating content without specifying mimetype fails (Fedora bug?)</span>
        <span class="k">if</span> <span class="s1">&#39;mimeType&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">save_opts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if datastreamProfile has not been pulled from fedora, use configured default mimetype</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mimetype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;mimeType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mimetype&#39;</span><span class="p">]</span>

        <span class="c1"># if datastream location has been set, use that for content</span>
        <span class="c1"># otherwise, use local content (if any)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;dsLocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_location</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_content</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="c1"># if not versionable, make a backup to back out changes if object save fails</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">()</span>
            <span class="c1"># if this datastream already exists, use modifyDatastream API call</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">modifyDatastream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">logMessage</span><span class="o">=</span><span class="n">logmessage</span><span class="p">,</span> <span class="o">**</span><span class="n">save_opts</span><span class="p">)</span>
            <span class="c1"># expects 200 ok</span>
            <span class="n">success</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if this datastream does not yet exist, add it</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">addDatastream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">controlGroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;control_group&#39;</span><span class="p">],</span>
                    <span class="n">logMessage</span><span class="o">=</span><span class="n">logmessage</span><span class="p">,</span> <span class="o">**</span><span class="n">save_opts</span><span class="p">)</span>
            <span class="c1"># expects 201 created</span>
            <span class="n">success</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
            <span class="c1"># clean-up required for object info after adding a new datastream</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># update exists flag - if add succeeded, the datastream exists now</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c1"># if the datastream content is a file-like object, clear it out</span>
                <span class="c1"># (we don&#39;t want to attempt to save the current file contents again,</span>
                <span class="c1"># particularly since the file is not guaranteed to still be open)</span>
                <span class="k">if</span> <span class="s1">&#39;content&#39;</span> <span class="ow">in</span> <span class="n">save_opts</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">save_opts</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_content_modified</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="c1"># update modification indicators</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checksum_modified</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_digest</span><span class="p">()</span>
            <span class="c1"># clear out ds location</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_location</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">success</span>      <span class="c1"># msg ?</span>

    <span class="k">def</span> <span class="nf">_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">getDatastreamProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info_backup</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dsLabel&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                             <span class="s1">&#39;mimeType&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">mimetype</span><span class="p">,</span>
                             <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">versionable</span><span class="p">,</span>
                             <span class="s1">&#39;dsState&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                             <span class="s1">&#39;formatURI&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                             <span class="s1">&#39;checksumType&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">checksum_type</span><span class="p">,</span>
                             <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">checksum</span><span class="p">}</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getDatastreamDissemination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_backup</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>

    <span class="k">def</span> <span class="nf">undo_last_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logMessage</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Undo the last change made to the datastream content and profile, effectively</span>
<span class="sd">        reverting to the object state in Fedora as of the specified timestamp.</span>

<span class="sd">        For a versioned datastream, this will purge the most recent datastream.</span>
<span class="sd">        For an unversioned datastream, this will overwrite the last changes with</span>
<span class="sd">        a cached version of any content and/or info pulled from Fedora.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: currently not clearing any of the object caches and backups</span>
        <span class="c1"># of fedora content and datastream info, as it is unclear what (if anything)</span>
        <span class="c1"># should be cleared</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionable</span><span class="p">:</span>
            <span class="c1"># if this is a versioned datastream, get datastream history</span>
            <span class="c1"># and purge the most recent version</span>
            <span class="n">last_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">()</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">created</span>  <span class="c1"># fedora returns most recent first</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">purgeDatastream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                <span class="n">datetime_to_fedoratime</span><span class="p">(</span><span class="n">last_save</span><span class="p">),</span>
                                                <span class="n">logMessage</span><span class="o">=</span><span class="n">logMessage</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for an unversioned datastream, update with any content and info</span>
            <span class="c1"># backups that were pulled from Fedora before any modifications were made</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_backup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_backup</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_backup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info_backup</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">modifyDatastream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">logMessage</span><span class="o">=</span><span class="n">logMessage</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>

    <span class="k">def</span> <span class="nf">get_chunked_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">4096</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generator that returns the datastream content in chunks, so</span>
<span class="sd">        larger datastreams can be used without reading the entire</span>
<span class="sd">        contents into memory.&#39;&#39;&#39;</span>

        <span class="c1"># get the datastream dissemination, but return the actual http response</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getDatastreamDissemination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>  <span class="n">asOfDateTime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">as_of_date</span><span class="p">)</span>
        <span class="c1"># read and yield the response in chunks</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunksize</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">validate_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if this datastream has a valid checksum in Fedora, by</span>
<span class="sd">        running the :meth:`REST_API.compareDatastreamChecksum` API</span>
<span class="sd">        call.  Returns a boolean based on the checksum valid</span>
<span class="sd">        response from Fedora.</span>

<span class="sd">        :param date: (optional) check the datastream validity at a</span>
<span class="sd">            particular date/time (e.g., for versionable datastreams)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">compareDatastreamChecksum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                               <span class="n">asOfDateTime</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
        <span class="n">dsprofile</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">DatastreamProfile</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dsprofile</span><span class="o">.</span><span class="n">checksum_valid</span>


<span class="k">class</span> <span class="nc">Datastream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Datastream descriptor to simplify configuration and access to datastreams</span>
<span class="sd">    that belong to a particular :class:`DigitalObject`.</span>

<span class="sd">    When accessed, will initialize a :class:`DatastreamObject` and cache it on</span>
<span class="sd">    the :class:`DigitalObject` that it belongs to.</span>

<span class="sd">    Example usage::</span>

<span class="sd">        class MyDigitalObject(DigitalObject):</span>
<span class="sd">            text = Datastream(&quot;TEXT&quot;, &quot;Text content&quot;, defaults={&#39;mimetype&#39;: &#39;text/plain&#39;})</span>

<span class="sd">    All other configuration defaults are passed on to the :class:`DatastreamObject`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_datastreamClass</span> <span class="o">=</span> <span class="n">DatastreamObject</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastream_args</span> <span class="o">=</span> <span class="n">defaults</span>

        <span class="c1">#self.label = label</span>
        <span class="c1">#self.datastream_defaults = defaults</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">dscache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datastreamClass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">datastream_args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_mimetype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datastream_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mimetype&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mimetype</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mimetype</span>
        <span class="n">ds_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datastreamClass</span>
        <span class="k">return</span> <span class="n">ds_cls</span><span class="o">.</span><span class="n">default_mimetype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_format_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datastream_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># set and delete not implemented on datastream descriptor</span>
    <span class="c1"># - delete would only make sense for optional datastreams, not yet needed</span>
    <span class="c1"># - saving updated content to fedora handled by datastream object</span>


<span class="k">class</span> <span class="nc">XmlDatastreamObject</span><span class="p">(</span><span class="n">DatastreamObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extends :class:`DatastreamObject` in order to initialize datastream content</span>
<span class="sd">    as an instance of a specified :class:`~eulxml.xmlmap.XmlObject`.</span>

<span class="sd">    See :class:`DatastreamObject` for more details.  Has one additional parameter:</span>

<span class="sd">    :param objtype: xml object type to use for datastream content; if not specified,</span>
<span class="sd">        defaults to :class:`~eulxml.xmlmap.XmlObject`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_mimetype</span> <span class="o">=</span> <span class="s2">&quot;text/xml&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span> <span class="o">=</span> <span class="n">objtype</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XmlDatastreamObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># FIXME: override _set_content to handle setting full xml content?</span>

    <span class="k">def</span> <span class="nf">_convert_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bootstrap_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objtype</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_content_as_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">_raw_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># special case for xml datastreams:</span>
        <span class="c1"># self.content is automatically bootstrapped as a new XmlObject</span>
        <span class="c1"># - consider the datastream to have no content if the xml is empty</span>
        <span class="c1"># (which, by default, means no attributes and no text content)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> \
          <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;is_empty&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">XmlDatastreamObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_raw_content</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">XmlDatastream</span><span class="p">(</span><span class="n">Datastream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;XML-specific version of :class:`Datastream`.  Datastreams are initialized</span>
<span class="sd">    as instances of :class:`XmlDatastreamObject`.  An additional, optional</span>
<span class="sd">    parameter ``objtype`` is passed to the Datastream object to configure the</span>
<span class="sd">    type of :class:`eulxml.xmlmap.XmlObject` that should be used for datastream</span>
<span class="sd">    content.</span>

<span class="sd">    Example usage::</span>

<span class="sd">        from eulxml.xmlmap.dc import DublinCore</span>

<span class="sd">        class MyDigitalObject(DigitalObject):</span>
<span class="sd">            extra_dc = XmlDatastream(&quot;EXTRA_DC&quot;, &quot;Dublin Core&quot;, DublinCore)</span>

<span class="sd">        my_obj = repo.get_object(&quot;example:1234&quot;, type=MyDigitalObject)</span>
<span class="sd">        my_obj.extra_dc.content.title = &quot;Example object&quot;</span>
<span class="sd">        my_obj.save(logMessage=&quot;automatically setting dc title&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_datastreamClass</span> <span class="o">=</span> <span class="n">XmlDatastreamObject</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{}):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XmlDatastream</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datastream_args</span><span class="p">[</span><span class="s1">&#39;objtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objtype</span>


<span class="k">class</span> <span class="nc">RdfDatastreamObject</span><span class="p">(</span><span class="n">DatastreamObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extends :class:`DatastreamObject` in order to initialize datastream content</span>
<span class="sd">    as an `rdflib &lt;http://pypi.python.org/pypi/rdflib/&gt;`_ RDF graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_mimetype</span> <span class="o">=</span> <span class="s2">&quot;application/rdf+xml&quot;</span>
    <span class="c1"># prefixes for namespaces expected to be used in RELS-EXT</span>
    <span class="n">default_namespaces</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fedora-model&#39;</span><span class="p">:</span> <span class="s1">&#39;info:fedora/fedora-system:def/model#&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fedora-rels-ext&#39;</span><span class="p">:</span> <span class="s1">&#39;info:fedora/fedora-system:def/relations-external#&#39;</span><span class="p">,</span>
        <span class="s1">&#39;oai&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.openarchives.org/OAI/2.0/&#39;</span>
        <span class="p">}</span>

    <span class="c1"># FIXME: override _set_content to handle setting content?</span>
    <span class="k">def</span> <span class="nf">_convert_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind_prefixes</span><span class="p">(</span><span class="n">parse_rdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_bootstrap_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind_prefixes</span><span class="p">(</span><span class="n">RdfGraph</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_bind_prefixes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="c1"># bind any specified prefixes so that serialized xml will be human-readable</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">namespace</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_namespaces</span><span class="p">):</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="nf">_content_as_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">load_xmlobject_from_string</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">node</span>

    <span class="k">def</span> <span class="nf">replace_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace a uri reference everywhere it appears in the graph with</span>
<span class="sd">        another one. It could appear as the subject, predicate, or object of</span>
<span class="sd">        a statement, so for each position loop through each statement that</span>
<span class="sd">        uses the reference in that position, remove the old statement, and</span>
<span class="sd">        add the replacement. &quot;&quot;&quot;</span>

        <span class="c1"># NB: The hypothetical statement &lt;src&gt; &lt;src&gt; &lt;src&gt; will be removed</span>
        <span class="c1"># and re-added several times. The subject block will remove it and</span>
        <span class="c1"># add &lt;dest&gt; &lt;src&gt; &lt;src&gt;. The predicate block will remove that and</span>
        <span class="c1"># add &lt;dest&gt; &lt;dest&gt; &lt;src&gt;. The object block will then remove that</span>
        <span class="c1"># and add &lt;dest&gt; &lt;dest&gt; &lt;dest&gt;.</span>

        <span class="c1"># NB2: The list() call here is necessary. .triples() is a generator:</span>
        <span class="c1"># It calculates its matches as it progressively iterates through the</span>
        <span class="c1"># graph. Actively changing the graph inside the for loop while the</span>
        <span class="c1"># generator is in the middle of examining it risks invalidating the</span>
        <span class="c1"># generator and could conceivably make it Just Break, depending on</span>
        <span class="c1"># the implementation of .triples(). Wrapping .triples() in a list()</span>
        <span class="c1"># forces it to exhaust the generator, running through the entire</span>
        <span class="c1"># graph to calculate the list of matches before continuing to the</span>
        <span class="c1"># for loop.</span>

        <span class="n">subject_triples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">triples</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">subject_triples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dest</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>

        <span class="n">predicate_triples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">triples</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">predicate_triples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>

        <span class="n">object_triples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">triples</span><span class="p">((</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">src</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">object_triples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_prepare_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the RDF datastream refers to the object by the default dummy</span>
<span class="sd">        uriref then we need to replace that dummy reference with a real one</span>
<span class="sd">        before we ingest the object.&quot;&quot;&quot;</span>

        <span class="c1"># see also commentary on DigitalObject.DUMMY_URIREF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">DUMMY_URIREF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RdfDatastream</span><span class="p">(</span><span class="n">Datastream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RDF-specific version of :class:`Datastream` for accessing datastream</span>
<span class="sd">    content as an `rdflib &lt;http://pypi.python.org/pypi/rdflib/&gt;`_ RDF graph.</span>
<span class="sd">    Datastreams are initialized as instances of</span>
<span class="sd">    :class:`RdfDatastreamObject`.</span>

<span class="sd">    Example usage::</span>

<span class="sd">        from rdflib import RDFS, Literal</span>

<span class="sd">        class MyDigitalObject(DigitalObject):</span>
<span class="sd">            extra_rdf = RdfDatastream(&quot;EXTRA_RDF&quot;, &quot;an RDF graph of stuff&quot;)</span>

<span class="sd">        my_obj = repo.get_object(&quot;example:4321&quot;, type=MyDigitalObject)</span>
<span class="sd">        my_obj.extra_rdf.content.add((my_obj.uriref, RDFS.comment,</span>
<span class="sd">                                      Literal(&quot;This is an example object.&quot;)))</span>
<span class="sd">        my_obj.save(logMessage=&quot;automatically setting rdf comment&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_datastreamClass</span> <span class="o">=</span> <span class="n">RdfDatastreamObject</span>


<span class="k">class</span> <span class="nc">FileDatastreamObject</span><span class="p">(</span><span class="n">DatastreamObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extends :class:`DatastreamObject` in order to allow setting and reading</span>
<span class="sd">    datastream content as a file. To update contents, set datastream content</span>
<span class="sd">    property to a new file object. For example::</span>

<span class="sd">        class ImageObject(DigitalObject):</span>
<span class="sd">            image = FileDatastream(&#39;IMAGE&#39;, &#39;image datastream&#39;, defaults={</span>
<span class="sd">                &#39;mimetype&#39;: &#39;image/png&#39;</span>
<span class="sd">            })</span>

<span class="sd">    Then, with an instance of ImageObject::</span>

<span class="sd">        obj.image.content = open(&#39;/path/to/my/file&#39;)</span>
<span class="sd">        obj.save()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_content_modified</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_raw_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return the content in the format needed to save to Fedora</span>
        <span class="c1"># if content has not been loaded, return None (no changes)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>     <span class="c1"># return the file itself (handled by upload/save API calls)</span>

    <span class="k">def</span> <span class="nf">_convert_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="c1"># for now, using stringio to return a file-like object</span>
        <span class="c1"># NOTE: will require changes (here and in APIs) to handle large files</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># redefine content property to override set_content to set a flag when modified</span>
    <span class="k">def</span> <span class="nf">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileDatastreamObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_content</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span>

    <span class="k">def</span> <span class="nf">_set_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileDatastreamObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">content</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_content</span><span class="p">,</span> <span class="n">_set_content</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s2">&quot;contents of the datastream; only pulled from Fedora when accessed, cached after first access&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_content_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># don&#39;t attempt to create a checksum of the file content</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">isModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_modified</span>


<span class="k">class</span> <span class="nc">FileDatastream</span><span class="p">(</span><span class="n">Datastream</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;File-based content version of :class:`Datastream`.  Datastreams are</span>
<span class="sd">    initialized as instances of :class:`FileDatastreamObject`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_datastreamClass</span> <span class="o">=</span> <span class="n">FileDatastreamObject</span>


<span class="c1">### Descriptors for dealing with object relations</span>

<span class="c1"># TODO: Relation objects should probably have an intro section with a</span>
<span class="c1"># more user-friendly introduction...</span>

<span class="c1"># Relation  (list variant still TODO)</span>
<span class="c1"># ReverseRelation</span>

<span class="k">class</span> <span class="nc">Relation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This descriptor is intended for use with</span>
<span class="sd">    :class:`~eulfedora.models.DigitalObject` RELS-EXT relations, and</span>
<span class="sd">    provides get, set, and delete functionality for a single related</span>
<span class="sd">    :class:`DigitalObject` instance or literal value in the RELS-EXT</span>
<span class="sd">    of an individual object.</span>

<span class="sd">    Example use for a related object: a :class:`Relation` should be</span>
<span class="sd">    initialized with a predicate URI and optionally a subclass of</span>
<span class="sd">    :class:`~eulfedora.models.DigitalObject` that should be returned::</span>

<span class="sd">        class Page(DigitalObject):</span>
<span class="sd">            volume = Relation(relsext.isConstituentOf, type=Volume)</span>

<span class="sd">    When a :class:`Relation` is created with a type that references a</span>
<span class="sd">    :class:`DigitalObject` subclass, a corresponding</span>
<span class="sd">    :class:`ReverseRelation` will automatically be added to the</span>
<span class="sd">    related subclass.  For the example above, the fictional ``Volume``</span>
<span class="sd">    class would automatically get a ``page_set`` attribute configured</span>
<span class="sd">    with the same URI and a class of ``Page``.  Reverse property names</span>
<span class="sd">    can be customized using the ``related_name`` parameter, which is</span>
<span class="sd">    documented below and follows the basic conventions of Django\&#39;s</span>
<span class="sd">    :class:`~django.db.models.ForeignKey` model field (to which</span>
<span class="sd">    :class:`Relation` is roughly analogous).</span>

<span class="sd">    .. Note::</span>

<span class="sd">        Currently, auto-generated :class:`ReverseRelation` properties</span>
<span class="sd">        will always be initialized with ``multiple=True``, since that</span>
<span class="sd">        is the most common pattern for Fedora object relations (one to</span>
<span class="sd">        many).  Other variants may be added later, if and when use</span>
<span class="sd">        cases arise.</span>

<span class="sd">    :class:`~eulfedora.models.Relation` also supports configuring the</span>
<span class="sd">    RDF type and namespace prefixes that should be used for</span>
<span class="sd">    serialization; for example::</span>

<span class="sd">        from rdflib import XSD, URIRef</span>
<span class="sd">        from rdflib.namespace import Namespace</span>

<span class="sd">        MYNS = Namespace(URIRef(&quot;http://example.com/ns/2011/my-test-namespace/#&quot;))</span>

<span class="sd">        class MyObj(DigitalObject):</span>
<span class="sd">            total = Relation(MYNS.count, ns_prefix={&quot;my&quot;: MYNS}, rdf_type=XSD.int)</span>

<span class="sd">    This would allow us to access ``total`` as an integer on a MyObj</span>
<span class="sd">    object, e.g.::</span>

<span class="sd">        myobj.total = 3</span>

<span class="sd">    and when the RELS-EXT is serialized it will use the</span>
<span class="sd">    configured namespace prefix, e.g.:</span>

<span class="sd">    .. code-block:: xml</span>

<span class="sd">    &lt;rdf:RDF xmlns:my=&quot;xmlns:fedora-model=&quot;info:fedora/fedora-system:def/model#&quot;</span>
<span class="sd">          xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;</span>
<span class="sd">      &lt;rdf:Description rdf:about=&quot;info:fedora/myobj:1&quot;&gt;</span>
<span class="sd">        &lt;my:count rdf:datatype=&quot;http://www.w3.org/2001/XMLSchema#int&quot;&gt;3&lt;/my:count&gt;</span>
<span class="sd">      &lt;/rdf:Description&gt;</span>
<span class="sd">    &lt;/rdf:RDF&gt;</span>

<span class="sd">    .. Note::</span>

<span class="sd">        If a namespace prefix is not specified, :mod:`rfdlib` will</span>
<span class="sd">        automatically generate a namespace to produce valid output,</span>
<span class="sd">        but it may be less readable than a custom namespace.</span>


<span class="sd">    Initialization options:</span>

<span class="sd">    :param relation: the RDF predicate URI as a :class:`rdflib.URIRef`</span>
<span class="sd">    :param type: optional :class:`~eulfedora.models.DigitalObject`</span>
<span class="sd">        subclass to initialize (for object relations); use</span>
<span class="sd">        ``type=&quot;self&quot;`` to specify that the current DigitalObject</span>
<span class="sd">        class should be used (currently no reverse relation will be</span>
<span class="sd">        created for recursive relations).</span>
<span class="sd">    :param ns_prefix: optional dictionary to configure namespace</span>
<span class="sd">        prefixes to be used for serialization; key should be the</span>
<span class="sd">        desired prefix, value should be an instance of</span>
<span class="sd">        :class:`rdflib.namespace.Namespace`</span>
<span class="sd">    :param rdf_type: optional rdf type for literal values (passed</span>
<span class="sd">        to :class:`rdflib.Literal` as the datatype option)</span>
<span class="sd">    :param related_name: optional name for the auto-generated</span>
<span class="sd">        :class:`ReverseRelation` property, when the relation is to a</span>
<span class="sd">        subclass of :class:`DigitalObject`; if not specified, the</span>
<span class="sd">        related name will be ``classname_set``; a value of ``+``</span>
<span class="sd">        indicates no :class:`ReverseRelation` should be created</span>
<span class="sd">    :param related_order: optional URI for sorting related objects</span>
<span class="sd">        in the auto-generated :class:`ReverseRelation` property.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ns_prefix</span><span class="o">=</span><span class="p">{},</span> <span class="n">rdf_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">related_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">related_order</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns_prefix</span> <span class="o">=</span> <span class="n">ns_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdf_type</span> <span class="o">=</span> <span class="n">rdf_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">related_name</span> <span class="o">=</span> <span class="n">related_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">related_order</span> <span class="o">=</span> <span class="n">related_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span> <span class="o">=</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1">#  if related object has already been cached, use the cached copy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">]</span>

        <span class="c1"># otherwise: lookup, add to cache, and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span>
                                         <span class="n">predicate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span><span class="p">:</span>    <span class="c1"># don&#39;t init new object if val is None</span>
            <span class="c1"># special case: if object_type is the string &#39;self&#39;,</span>
            <span class="c1"># use the parent object class (save after the first check)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>

            <span class="c1"># need get_object wrapper method on digital object</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object_type</span><span class="p">)</span>

        <span class="c1"># if the value has &#39;toPython&#39; method (e.g., rdflib.Literal),</span>
        <span class="c1"># return the result of that conversion</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">,</span> <span class="s1">&#39;toPython&#39;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
        <span class="c1"># if any namespace prefixes were specified, bind them before adding the tuple</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns_prefix</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="c1"># TODO: do we need to check that subject matches self.object_type (if any)?</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">):</span>
            <span class="n">subject_uri</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;uriref&#39;</span><span class="p">):</span>
            <span class="n">subject_uri</span> <span class="o">=</span> <span class="n">subject</span><span class="o">.</span><span class="n">uriref</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdf_type</span><span class="p">:</span>
            <span class="n">subject_uri</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rdf_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subject_uri</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>

        <span class="c1"># set the property in the rels-ext, removing any existing</span>
        <span class="c1"># value for that property (single-value relation only, for now)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">set</span><span class="p">((</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span>
            <span class="n">subject_uri</span>
        <span class="p">))</span>

        <span class="c1"># store updated value in cache</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject</span>

    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># find the subject uri and remove from rels-ext</span>
        <span class="n">uris</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">uris</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span>
                <span class="n">uris</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">))</span>

        <span class="c1">#  if related object has been cached, delete that as well</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">relcache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uri_val</span><span class="p">]</span>



<span class="k">class</span> <span class="nc">ReverseRelation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Descriptor for use with</span>
<span class="sd">    :class:`~eulfedora.models.DigitalObject` RELS-EXT reverse</span>
<span class="sd">    relations, where the owning object is the RDF **object** of the</span>
<span class="sd">    predicate and the related object is the RDF **subject**.  This</span>
<span class="sd">    descriptor will query the Fedora</span>
<span class="sd">    :class:`~eulfedora.api.ResourceIndex` for the requested subjects,</span>
<span class="sd">    based on the configured predicate, and return resulting items.</span>

<span class="sd">    This descriptor *only* provides read access; there is no</span>
<span class="sd">    functionality for setting or deleting reverse-related objects.</span>

<span class="sd">    It is recommended to use :class:`Relation` and let the</span>
<span class="sd">    corresponding :class:`ReverseRelation` be automatically generated</span>
<span class="sd">    for you.</span>

<span class="sd">    Example use::</span>

<span class="sd">        class Volume(DigitalObject):</span>
<span class="sd">            pages = ReverseRelation(relsext.isConstituentOf, type=Page, multiple=True)</span>

<span class="sd">    :param relation: RDF relation to be used for querying to find the items</span>
<span class="sd">    :param type: object type for the related item or items</span>
<span class="sd">    :param multiple: set to true if there multiple related items, which will be returned</span>
<span class="sd">        as a list (defaults to false)</span>
<span class="sd">    :param order_by: RDF predicate to be used for sorting multiple items</span>
<span class="sd">        (must be available for query in the RIsearch, as a property of</span>
<span class="sd">        the items being returned)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relation</span> <span class="o">=</span> <span class="n">relation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">=</span> <span class="n">multiple</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="n">order_by</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># query RIsearch for subjects based on configured relation and current object</span>

        <span class="c1"># if a sort property is specified, use sparql to find *and* sort</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sparql_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT ?pid ?order</span>
<span class="s1">                WHERE {</span>
<span class="s1">                    ?pid &lt;</span><span class="si">%(rel)s</span><span class="s1">&gt; &lt;</span><span class="si">%(uri)s</span><span class="s1">&gt; .</span>
<span class="s1">                    ?pid &lt;</span><span class="si">%(sort_rel)s</span><span class="s1">&gt; ?order</span>
<span class="s1">                } ORDER BY ?order&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s1">&#39;rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span>
                    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span>
                    <span class="s1">&#39;sort_rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span>
                <span class="p">}</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">risearch</span><span class="o">.</span><span class="n">sparql_query</span><span class="p">(</span><span class="n">sparql_query</span><span class="p">)</span>
            <span class="n">uris</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

        <span class="c1"># otherwise, just do a simple SPO search to get the objects</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uris</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">risearch</span><span class="o">.</span><span class="n">get_subjects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">uriref</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_val</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span> <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">uris</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">uris</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_val</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">uris</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_init_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c1"># initialize the desired return type, based on configuration</span>
        <span class="c1"># would any reverse relation not be an object?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">val</span>


<span class="k">class</span> <span class="nc">DigitalObjectType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A metaclass for :class:`DigitalObject`.</span>

<span class="sd">    All this does for now is find Datastream objects from parent classes</span>
<span class="sd">    and those defined on the class itself and collect them into a</span>
<span class="sd">    _defined_datastreams dictionary on the class. Using this, clients (or,</span>
<span class="sd">    more likely, internal library code) can more easily introspect the</span>
<span class="sd">    datastreams defined in code for the object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_registry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">defined_attrs</span><span class="p">):</span>
        <span class="n">datastreams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">local_datastreams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">use_attrs</span> <span class="o">=</span> <span class="n">defined_attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">reverse_rels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="n">base_ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_defined_datastreams&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_ds</span><span class="p">:</span>
                <span class="n">datastreams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base_ds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_val</span> <span class="ow">in</span> <span class="n">defined_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_val</span><span class="p">,</span> <span class="n">Datastream</span><span class="p">):</span>
                <span class="n">local_datastreams</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_val</span><span class="p">,</span> <span class="n">Relation</span><span class="p">):</span>
                <span class="c1"># collect Relations in order to add reverse relations</span>
                <span class="c1"># after the class has been created</span>
                <span class="c1"># - only relations to subclasses of DigitalObject need reversing</span>
                <span class="k">if</span> <span class="n">attr_val</span><span class="o">.</span><span class="n">object_type</span> <span class="ow">and</span> <span class="n">attr_val</span><span class="o">.</span><span class="n">object_type</span> <span class="o">!=</span> <span class="n">DigitalObject</span>\
                       <span class="ow">and</span> <span class="n">attr_val</span><span class="o">.</span><span class="n">related_name</span> <span class="o">!=</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="c1"># as in Django, related_name=+ is special case</span>
                    <span class="c1"># used to indicate no reverse relation should be created</span>
                    <span class="n">reverse_rels</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_val</span>

        <span class="n">use_attrs</span><span class="p">[</span><span class="s1">&#39;_local_datastreams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_datastreams</span>

        <span class="n">datastreams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_datastreams</span><span class="p">)</span>
        <span class="n">use_attrs</span><span class="p">[</span><span class="s1">&#39;_defined_datastreams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datastreams</span>

        <span class="n">super_new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DigitalObjectType</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span>
        <span class="n">new_class</span> <span class="o">=</span> <span class="n">super_new</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">use_attrs</span><span class="p">)</span>

        <span class="n">new_class_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_class</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">new_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">DigitalObjectType</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">new_class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_class</span>

        <span class="c1"># create any ReverseRelations corresponding to Relations on</span>
        <span class="c1"># the current class</span>
        <span class="c1"># for now, assume all reverse relations are multiple</span>
        <span class="k">for</span> <span class="n">rel_name</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">reverse_rels</span><span class="p">):</span>
            <span class="c1"># don&#39;t reverse self-relations for now</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">object_type</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># TODO: look into handling this the way django handles</span>
            <span class="c1"># recursive relationships</span>

            <span class="c1"># use related name if one has been specified</span>
            <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">related_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">reverse_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">related_name</span>
            <span class="c1"># otherwise, follow Django convention and use classname_set</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reverse_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_set&#39;</span> <span class="o">%</span> <span class="n">new_class</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># add the reverse relation to the other class</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">object_type</span><span class="p">,</span> <span class="n">reverse_name</span><span class="p">,</span>
                    <span class="n">ReverseRelation</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">new_class</span><span class="p">,</span>
                                    <span class="n">multiple</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">rel</span><span class="o">.</span><span class="n">related_order</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_class</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">defined_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DigitalObjectType</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DigitalObject</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">DigitalObjectType</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single digital object in a Fedora respository, with methods and</span>
<span class="sd">    properties to easy creating, accessing, and updating a Fedora</span>
<span class="sd">    object or any of its component parts, with pre-defined datastream</span>
<span class="sd">    mappings for the standard Fedora Dublin Core</span>
<span class="sd">    (:attr:`~eulfedora.models.DigitalObject.dc`) and RELS-EXT</span>
<span class="sd">    (:attr:`~eulfedora.models.DigitalObject.rels_ext`) datastreams.</span>

<span class="sd">    .. Note::</span>

<span class="sd">      If you want idiomatic access to other datastreams, consider</span>
<span class="sd">      extending :class:`DigitalObject` and defining your own</span>
<span class="sd">      datastreams using :class:`XmlDatastream`,</span>
<span class="sd">      :class:`RdfDatastream`, or :class:`FileDatastream` as</span>
<span class="sd">      appropriate.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">default_pidspace</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Default namespace to use when generating new PIDs in</span>
<span class="sd">        :meth:`get_default_pid` (by default, calls Fedora getNextPid,</span>
<span class="sd">        which will use Fedora-configured namespace if default_pidspace</span>
<span class="sd">        is not set).&quot;&quot;&quot;</span>

    <span class="n">OWNER_ID_SEPARATOR</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="sd">&#39;&#39;&#39;Owner ID separator for multiple owners.  Should match the</span>
<span class="sd">    OWNER-ID-SEPARATOR configured in Fedora.</span>
<span class="sd">    For more detail, see https://jira.duraspace.org/browse/FCREPO-82</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">dc</span> <span class="o">=</span> <span class="n">XmlDatastream</span><span class="p">(</span><span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="s2">&quot;Dublin Core&quot;</span><span class="p">,</span> <span class="n">DublinCore</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;control_group&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.openarchives.org/OAI/2.0/oai_dc/&#39;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="sd">&#39;&#39;&#39;:class:`XmlDatastream` for the required Fedora **DC** datastream;</span>
<span class="sd">    datastream content will be automatically loaded as an instance of</span>
<span class="sd">    :class:`eulxml.xmlmap.dc.DublinCore`&#39;&#39;&#39;</span>
    <span class="n">rels_ext</span> <span class="o">=</span> <span class="n">RdfDatastream</span><span class="p">(</span><span class="s2">&quot;RELS-EXT&quot;</span><span class="p">,</span> <span class="s2">&quot;External Relations&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;control_group&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;info:fedora/fedora-system:FedoraRELSExt-1.0&#39;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="sd">&#39;&#39;&#39;:class:`RdfDatastream` for the standard Fedora **RELS-EXT** datastream&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default_pidspace</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c1"># accessed by DatastreamDescriptor to store and cache datastreams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relcache</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># used by Relation to store and cache related objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_risearch</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adhoc_datastreams</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># per-object ad-hoc datastreams parallel to per-class _defined_datastreams</span>

        <span class="k">if</span> <span class="n">default_pidspace</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_pidspace</span> <span class="o">=</span> <span class="n">default_pidspace</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># allow extending classes to make default_pidspace a custom property,</span>
                <span class="c1"># but warn if there is case of conflict</span>
                <span class="k">if</span> <span class="n">default_pidspace</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;default_pidspace&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to set requested default_pidspace </span><span class="si">%s</span><span class="s2"> (using </span><span class="si">%s</span><span class="s2"> instead)&quot;</span> \
                                <span class="o">%</span> <span class="p">(</span><span class="n">default_pidspace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_pidspace</span><span class="p">))</span>
        <span class="c1"># cache object profile, track if it is modified and needs to be saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># datastream list from fedora</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># object history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># object foxml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_xml</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># pid = None signals to create a new object, using a default pid</span>
        <span class="c1"># generation function.</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># self.get_default_pid is probably the method defined elsewhere</span>
            <span class="c1"># in this class. Barring clever hanky-panky, it should be</span>
            <span class="c1"># reliably callable.</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_pid</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> \
                 <span class="n">pid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span><span class="p">):</span>  <span class="c1"># passed a uri</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span><span class="p">):]</span>

        <span class="c1"># callable(pid) signals a function to call to obtain a pid if and</span>
        <span class="c1"># when one is needed</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
            <span class="n">create</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>

        <span class="c1"># self._create is True when we should create (ingest) this object in</span>
        <span class="c1"># fedora on first save(), False if we should assume it&#39;s already</span>
        <span class="c1"># there. Note that if pid is callable, create is always True (for</span>
        <span class="c1"># which see above)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">create</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_as_new_object</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_as_new_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cmodel</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;CONTENT_MODELS&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">modelns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span>
                                       <span class="n">URIRef</span><span class="p">(</span><span class="n">cmodel</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">risearch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Instance of :class:`eulfedora.api.ResourceIndex`, with the same root url and credentials&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_risearch</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_risearch</span> <span class="o">=</span> <span class="n">ResourceIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_risearch</span>

    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize and return a new</span>
<span class="sd">        :class:`~eulfedora.models.DigitalObject` instance from the same</span>
<span class="sd">        repository, passing along the connection credentials in use by</span>
<span class="sd">        the current object.  If type is not specified, the current</span>
<span class="sd">        DigitalObject class will be used.</span>

<span class="sd">        :param pid: pid of the object to return</span>
<span class="sd">        :param type: (optional) :class:`~eulfedora.models.DigitalObject`</span>
<span class="sd">           type to initialize and return</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;(generated pid; uningested)&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">+</span> <span class="s1">&#39; (uningested)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">force_text</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_default_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the next default pid when creating and ingesting a new</span>
<span class="sd">        DigitalObject instance without specifying a pid.  By default,</span>
<span class="sd">        calls :meth:`ApiFacade.getNextPID` with the configured class</span>
<span class="sd">        default_pidspace (if specified) as the pid namespace.</span>

<span class="sd">        If your project requires custom pid logic (e.g., object pids</span>
<span class="sd">        are based on an external pid generator), you should extend</span>
<span class="sd">        DigitalObject and override this method.&#39;&#39;&#39;</span>
        <span class="c1"># This function is used by __init__ as a default pid generator if</span>
        <span class="c1"># none is specified. If you get the urge to override it, make sure</span>
        <span class="c1"># it still works there.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_pidspace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_pidspace</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getNextPID</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">nextpids</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">NewPids</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nextpids</span><span class="o">.</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pidspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Fedora pidspace of this object&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ps</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ps</span>

    <span class="c1"># This dummy pid stuff is ugly. I&#39;d rather not need it. Every now and</span>
    <span class="c1"># then, though, something needs a PID or URI for a brand-new object</span>
    <span class="c1"># (i.e., with a callable self.pid) before we&#39;ve even had a chance to</span>
    <span class="c1"># generate one. In particular, if we want to add statements to an</span>
    <span class="c1"># object&#39;s RELS-EXT, then the the object URI needs to be the subject of</span>
    <span class="c1"># those statements. We can&#39;t just generate the PID early because we get</span>
    <span class="c1"># PIDs from ARKs, and those things stick around. Also, most objects get</span>
    <span class="c1"># RELS-EXT statements right as we create them anyway (see references to</span>
    <span class="c1"># CONTENT_MODELS in _init_as_new_object()), so calling self.pid as soon</span>
    <span class="c1"># as we need a uri would be essentially equivalent to &quot;at object</span>
    <span class="c1"># creation,&quot; which negates the whole point of lazy callable pids.</span>
    <span class="c1">#</span>
    <span class="c1"># So anyway, this DUMMY_PID gives us something we can use as a pid for</span>
    <span class="c1"># new objects, with the understanding that we have to clean it up to use</span>
    <span class="c1"># the real pid in obj._prepare_ingest(), which is called after we&#39;ve</span>
    <span class="c1"># committed to trying to ingest the object, and thus after self.pid has</span>
    <span class="c1"># been called and replaced with a real string pid. DatastreamObject</span>
    <span class="c1"># subclasses can do this in their own _prepare_ingest() methods.</span>
    <span class="c1"># RELS-EXT (and all other RDF datastreams for that matter) get that</span>
    <span class="c1"># implemented in RdfDatastreamObject above.</span>
    <span class="n">DUMMY_PID</span> <span class="o">=</span> <span class="s1">&#39;TEMP:DUMMY_PID&#39;</span>
    <span class="n">DUMMY_URIREF</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span> <span class="o">+</span> <span class="n">DUMMY_PID</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Fedora URI for this object (``info:fedora/foo:###`` form of object pid) &quot;</span>
        <span class="n">use_pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">use_pid</span><span class="p">):</span>
            <span class="n">use_pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DUMMY_PID</span>
        <span class="k">return</span> <span class="s1">&#39;info:fedora/&#39;</span> <span class="o">+</span> <span class="n">use_pid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uriref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Fedora URI for this object, as an :class:`rdflib.URIRef` URI object&quot;</span>
        <span class="k">return</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># pull object profile information from Fedora, but only when accessed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProfile</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>

    <span class="c1"># object info properties</span>
    <span class="n">label_max_size</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="s1">&#39;maximum label size allowed by fedora&#39;</span>

    <span class="k">def</span> <span class="nf">_get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">label</span>

    <span class="k">def</span> <span class="nf">_set_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c1"># Fedora object label property has a maximum of 255 characters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_max_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Attempting to set object label for </span><span class="si">%s</span><span class="s1"> to a value longer than </span><span class="si">%d</span><span class="s1"> character max (</span><span class="si">%d</span><span class="s1">); truncating&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_max_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">label_max_size</span><span class="p">]</span>

        <span class="c1"># if the new value is different, track object information modification for next save</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">label</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_label</span><span class="p">,</span> <span class="n">_set_label</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;object label&quot;</span><span class="p">)</span>

    <span class="n">owner_max_size</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="s1">&#39;maximum owner size allowed by fedora&#39;</span>

    <span class="k">def</span> <span class="nf">_get_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">owner</span>

    <span class="k">def</span> <span class="nf">_set_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_max_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Attempting to set object owner for </span><span class="si">%s</span><span class="s1"> to a value longer than </span><span class="si">%d</span><span class="s1"> character max (</span><span class="si">%d</span><span class="s1">); truncating&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_max_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

            <span class="c1"># if owner is delimited, truncate to last full value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OWNER_ID_SEPARATOR</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="c1"># find the last delimiter under the max size</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OWNER_ID_SEPARATOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_max_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

            <span class="c1"># otherwise, just truncate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_max_size</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">owner</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_owner</span><span class="p">,</span> <span class="n">_set_owner</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;object owner&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">owners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read-only list of object owners, separated by the configured</span>
<span class="sd">        :attr:`OWNER_ID_SEPARATOR`, with whitespace stripped.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OWNER_ID_SEPARATOR</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">state</span>

    <span class="k">def</span> <span class="nf">_set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">state</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_state</span><span class="p">,</span> <span class="n">_set_state</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;object state (Active/Inactive/Deleted)&quot;</span><span class="p">)</span>

    <span class="c1"># read-only info properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">created</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">created</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">modified</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:type: bool</span>

<span class="sd">        True when the object actually exists (and can be accessed by</span>
<span class="sd">        the current user) in Fedora</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If we made the object under the pretext that it doesn&#39;t exist in</span>
        <span class="c1"># fedora yet, then assume it doesn&#39;t exist in fedora yet.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># If we can get a valid object profile, regardless of its contents,</span>
        <span class="c1"># then this object exists. If not, then it doesn&#39;t.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getProfile</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_requisite_content_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;:type: bool</span>

<span class="sd">        True when the current object has the expected content models</span>
<span class="sd">        for whatever subclass of :class:`DigitalObject` it was</span>
<span class="sd">        initialized as.&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">cmodel</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;CONTENT_MODELS&#39;</span><span class="p">,</span> <span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_model</span><span class="p">(</span><span class="n">cmodel</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">getDatastreamProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information about a particular datastream belonging to this object.</span>

<span class="sd">        :param dsid: datastream id</span>
<span class="sd">        :rtype: :class:`DatastreamProfile`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: used by DatastreamObject</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getDatastream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">asOfDateTime</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">DatastreamProfile</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getHistory</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span>

    <span class="k">def</span> <span class="nf">getHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getObjectHistory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">ObjectHistory</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">changed</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">history</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">object_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Fedora object XML as an instance of :class:`FoxmlDigitalObject`.</span>
<span class="sd">        (via :meth:`REST_API. getObjectXML`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_xml</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getObjectXml</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_xml</span>

    <span class="k">def</span> <span class="nf">getObjectXml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getObjectXML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_object_xml</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">FoxmlDigitalObject</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_xml</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">audit_trail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Fedora audit trail as an instance of :class:`eulfedora.xml.AuditTrail`</span>

<span class="sd">        .. Note::</span>

<span class="sd">          Since Fedora (as of 3.5) does not make the audit trail</span>
<span class="sd">          available via an API call or as a datastream, accessing the</span>
<span class="sd">          audit trail requires loading the foxml for the object.  If</span>
<span class="sd">          an object has large, versioned XML datastreams this may be</span>
<span class="sd">          slow.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># NOTE: It would be nice to expose the audit trail so that it</span>
        <span class="c1"># looks and behaves a bit more like other datastreams (pseudo</span>
        <span class="c1"># or read-only DatastreamObject?).  At the moment, the overhead</span>
        <span class="c1"># for that doesn&#39;t seem worth the possible benefits.</span>
        <span class="c1"># Fedora may eventually expose the AUDIT info more directly:</span>
        <span class="c1">#   https://jira.duraspace.org/browse/FCREPO-635</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_xml</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_xml</span><span class="o">.</span><span class="n">audit_trail</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ingest_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Username responsible for ingesting this object into the repository,</span>
<span class="sd">        as recorded in the :attr:`audit_trail`, if available.&#39;&#39;&#39;</span>
        <span class="c1"># if there is an audit trail and it has records and the first</span>
        <span class="c1"># action is ingest, return the user</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_trail</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_trail</span><span class="o">.</span><span class="n">records</span> \
           <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_trail</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;ingest&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_trail</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">audit_trail_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;A set of all usernames recorded in the :attr:`audit_trail`,</span>
<span class="sd">        if available.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_trail</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">user</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">audit_trail</span><span class="o">.</span><span class="n">records</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">_profile</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">getProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get information about this object (label, owner, date created, etc.).</span>

<span class="sd">        :rtype: :class:`ObjectProfile`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ObjectProfile</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getObjectProfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">ObjectProfile</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span>

    <span class="k">def</span> <span class="nf">_saveProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logMessage</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;can&#39;t save profile information for a new object before it&#39;s ingested.&quot;</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">modifyObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">logMessage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="c1"># profile info is no longer different than what is in Fedora</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saved</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">saved</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logMessage</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save to Fedora any parts of this object that have been</span>
<span class="sd">        modified (including object profile attributes such as</span>
<span class="sd">        :attr:`label`, :attr:`owner`, or :attr:`state`, and any</span>
<span class="sd">        changes to datastream content or datastream properties).  If a</span>
<span class="sd">        failure occurs at any point on saving any of the parts of the</span>
<span class="sd">        object, will back out any changes that have been made and</span>
<span class="sd">        raise a :class:`DigitalObjectSaveFailure` with information</span>
<span class="sd">        about where the failure occurred and whether or not it was</span>
<span class="sd">        recoverable.</span>

<span class="sd">        If the object is new, ingest it. If object profile information has</span>
<span class="sd">        been modified before saving, this data is used in the ingest.</span>
<span class="sd">        Datastreams are initialized to sensible defaults: XML objects are</span>
<span class="sd">        created using their default constructor, and RDF graphs start</span>
<span class="sd">        empty. If they&#39;re updated before saving then those updates are</span>
<span class="sd">        included in the initial version. Datastream profile information is</span>
<span class="sd">        initialized from defaults specified in the :class:`Datastream`</span>
<span class="sd">        declaration, though it too can be overridden prior to the initial</span>
<span class="sd">        save.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_ingest</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ingest</span><span class="p">(</span><span class="n">logMessage</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_existing</span><span class="p">(</span><span class="n">logMessage</span><span class="p">)</span>

        <span class="c1">#No errors, then return true</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_save_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logMessage</span><span class="p">):</span>
        <span class="c1"># save an object that has already been ingested into fedora</span>

        <span class="c1"># - list of datastreams that should be saved</span>
        <span class="n">to_save</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span> <span class="k">for</span> <span class="n">ds</span><span class="p">,</span> <span class="n">dsobj</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">)</span> <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">isModified</span><span class="p">()]</span>
        <span class="c1"># - track successfully saved datastreams, in case roll-back is necessary</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># save modified datastreams</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">to_save</span><span class="p">:</span>
            <span class="c1"># in eulfedora 0.16 and before, add/modify datastream returned True/False</span>
            <span class="c1"># in later versions, it throws an exception</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ds_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="n">ds</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">logMessage</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RequestFailed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to save </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">ds</span><span class="p">))</span>
                <span class="n">ds_saved</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">ds_saved</span><span class="p">:</span>
                <span class="n">saved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># save datastream failed - back out any changes that have been made</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_save</span><span class="p">(</span><span class="n">saved</span><span class="p">,</span>
                                          <span class="s2">&quot;failed saving </span><span class="si">%s</span><span class="s2">, rolling back changes&quot;</span> <span class="o">%</span> <span class="n">ds</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">DigitalObjectSaveFailure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">to_save</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>

        <span class="c1"># NOTE: to_save list in exception will never include profile; should it?</span>

        <span class="c1"># FIXME: catch exceptions on save, treat same as failure to save (?)</span>

        <span class="c1"># save object profile (if needed) after all modified datastreams have been successfully saved</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">profile_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saveProfile</span><span class="p">(</span><span class="n">logMessage</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RequestFailed</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to save object profile for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
                <span class="n">profile_saved</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">profile_saved</span><span class="p">:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_save</span><span class="p">(</span><span class="n">saved</span><span class="p">,</span> <span class="s2">&quot;failed to save object profile, rolling back changes&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">DigitalObjectSaveFailure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;object profile&quot;</span><span class="p">,</span> <span class="n">to_save</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">saved</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="ow">and</span> <span class="n">profile_saved</span><span class="p">):</span>
            <span class="c1"># clear out any cached object info that is now out of date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_object_xml</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_undo_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datastreams</span><span class="p">,</span> <span class="n">logMessage</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a list of datastreams and a datetime, run undo save on all of them,</span>
<span class="sd">        and returns a list of the datastreams where the undo succeeded.</span>

<span class="sd">        :param datastreams: list of datastream ids (should be in self.dscache)</span>
<span class="sd">        :param logMessage: optional log message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ds</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">datastreams</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="n">ds</span><span class="p">]</span><span class="o">.</span><span class="n">undo_last_save</span><span class="p">(</span><span class="n">logMessage</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_prepare_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This should only ever be called on newly-created objects, and only</span>
        <span class="c1"># immediately before ingest. It&#39;s used to clean up any rough edges</span>
        <span class="c1"># left over from being hewn from raw bits (instead of loaded from</span>
        <span class="c1"># the repo, like most other DigitalObjects are). In particular, see</span>
        <span class="c1"># the comments by DigitalObject.DUMMY_PID.</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defined_datastreams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsobj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dsobj</span><span class="p">,</span> <span class="s1">&#39;_prepare_ingest&#39;</span><span class="p">):</span>
                <span class="n">dsobj</span><span class="o">.</span><span class="n">_prepare_ingest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logMessage</span><span class="p">):</span>
        <span class="n">foxml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_for_ingest</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ingest</span><span class="p">(</span><span class="n">foxml</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">logMessage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">created</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;fedora returned unexpected pid &quot;</span><span class="si">%s</span><span class="s1">&quot; when trying to &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;ingest object with pid &quot;</span><span class="si">%s</span><span class="s1">&quot; (status code: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">%</span> \
                   <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># then clean up the local object so that self knows it&#39;s dealing</span>
        <span class="c1"># with an ingested object now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info_modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># cache for datastreams that have been retrieved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relcache</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># cache for related objects that have been retrieved</span>

    <span class="k">def</span> <span class="nf">_build_foxml_for_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_doc</span><span class="p">()</span>

        <span class="n">print_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>  <span class="c1"># for easier debug</span>
            <span class="n">print_opts</span><span class="p">[</span><span class="s1">&#39;pretty_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="o">**</span><span class="n">print_opts</span><span class="p">)</span>

    <span class="n">FOXML_NS</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/fedora-system:def/foxml#&#39;</span>

    <span class="k">def</span> <span class="nf">_build_foxml_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make an lxml element builder - default namespace is foxml, display with foxml prefix</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">ElementMaker</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FOXML_NS</span><span class="p">,</span> <span class="n">nsmap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foxml&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">FOXML_NS</span><span class="p">})</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;digitalObject&#39;</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1&#39;</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;PID&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_properties</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>

        <span class="c1"># collect datastream definitions for ingest.</span>
        <span class="k">for</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defined_datastreams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsobj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsname</span><span class="p">)</span>
            <span class="n">dsnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_datastream</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dsnode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsnode</span><span class="p">)</span>

        <span class="c1"># also collect ad-hoc datastream definitions for ingest.</span>
        <span class="k">for</span> <span class="n">dsname</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adhoc_datastreams</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dsobj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsname</span><span class="p">)</span>
            <span class="n">dsnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_datastream</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dsnode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsnode</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">_build_foxml_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;objectProperties&#39;</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;info:fedora/fedora-system:def/model#state&#39;</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;VALUE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">)</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;info:fedora/fedora-system:def/model#label&#39;</span><span class="p">)</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;VALUE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">:</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">)</span>
            <span class="n">owner</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;info:fedora/fedora-system:def/model#ownerId&#39;</span><span class="p">)</span>
            <span class="n">owner</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;VALUE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span>
            <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">props</span>

    <span class="k">def</span> <span class="nf">_build_foxml_datastream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">):</span>

        <span class="c1"># if we can&#39;t construct a content node then bail before constructing</span>
        <span class="c1"># any other nodes</span>
        <span class="n">content_node</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">control_group</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
            <span class="n">content_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_inline_content</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">control_group</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="n">content_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_foxml_managed_content</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">ds_xml</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;datastream&#39;</span><span class="p">)</span>
        <span class="n">ds_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">dsid</span><span class="p">)</span>
        <span class="n">ds_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CONTROL_GROUP&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">control_group</span><span class="p">)</span>
        <span class="n">ds_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="n">ds_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;VERSIONABLE&#39;</span><span class="p">,</span> <span class="n">force_text</span><span class="p">(</span><span class="n">dsobj</span><span class="o">.</span><span class="n">versionable</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">ver_xml</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;datastreamVersion&#39;</span><span class="p">)</span>
        <span class="n">ver_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">dsid</span> <span class="o">+</span> <span class="s1">&#39;.0&#39;</span><span class="p">)</span>
        <span class="n">ver_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;MIMETYPE&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">mimetype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
            <span class="n">ver_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;FORMAT_URI&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="n">ver_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;LABEL&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># I BOTH checksum and checksum type are specified, set contentDigest.</span>
        <span class="c1"># NOTE: this is a change from eulfedora 1.1 and previous, where</span>
        <span class="c1"># a checksum type could be passed and Fedora would automatically calculate</span>
        <span class="c1"># a checksum value of the requested type; that does *not* work in</span>
        <span class="c1"># Fedora 3.8, so instead we rely on the auto-checksumming functionality.</span>
        <span class="c1"># (But also note that auto-checksumming on ingest was broken in Fedora</span>
        <span class="c1"># until Fedora 3.7 - https://jira.duraspace.org/browse/FCREPO-1047)</span>
        <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">checksum</span> <span class="ow">and</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">checksum_type</span><span class="p">:</span>
            <span class="n">digest_xml</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;contentDigest&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">checksum_type</span><span class="p">:</span>
                <span class="n">digest_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;TYPE&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">checksum_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># default to MD5 checksum if not specified</span>
                <span class="n">digest_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;TYPE&#39;</span><span class="p">,</span> <span class="s2">&quot;MD5&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">checksum</span><span class="p">:</span>
                <span class="n">digest_xml</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;DIGEST&#39;</span><span class="p">,</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">checksum</span><span class="p">)</span>
            <span class="n">ver_xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digest_xml</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dsobj</span><span class="o">.</span><span class="n">_raw_content</span><span class="p">(),</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
            <span class="c1"># Content exists, but no checksum, so log a warning.</span>
            <span class="c1"># FIXME: probably need a better way to check this.</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Datastream ingested without a passed checksum or checksum type: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">))</span>

        <span class="n">ds_xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ver_xml</span><span class="p">)</span>

        <span class="n">ver_xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_xml</span>

    <span class="k">def</span> <span class="nf">_build_foxml_inline_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">):</span>
        <span class="n">orig_content_node</span> <span class="o">=</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">_content_as_node</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">orig_content_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">content_container_xml</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;xmlContent&#39;</span><span class="p">)</span>
        <span class="n">content_container_xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orig_content_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content_container_xml</span>

    <span class="k">def</span> <span class="nf">_build_foxml_managed_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">):</span>
        <span class="n">content_uri</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">ds_location</span><span class="p">:</span>
            <span class="c1"># if datastream has a location set, use that first</span>
            <span class="n">content_uri</span> <span class="o">=</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">ds_location</span>
            <span class="n">uri_type</span> <span class="o">=</span> <span class="s1">&#39;URL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise, check for local content and upload it</span>
            <span class="n">content_s</span> <span class="o">=</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">_raw_content</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">content_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">content_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">content_s</span><span class="p">)</span>
                <span class="n">uri_type</span> <span class="o">=</span> <span class="s1">&#39;INTERNAL_ID&#39;</span>

        <span class="c1"># stop if no content was found in either location</span>
        <span class="k">if</span> <span class="n">content_uri</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">content_location</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="s1">&#39;contentLocation&#39;</span><span class="p">)</span>
        <span class="n">content_location</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;REF&#39;</span><span class="p">,</span> <span class="n">content_uri</span><span class="p">)</span>
        <span class="n">content_location</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;TYPE&#39;</span><span class="p">,</span> <span class="n">uri_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content_location</span>

    <span class="k">def</span> <span class="nf">_get_datastreams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all datastreams that belong to this object.</span>

<span class="sd">        Returns a dictionary; key is datastream id, value is an :class:`ObjectDatastream`</span>
<span class="sd">        for that datastream.</span>

<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="c1"># FIXME: should we default to the datastreams defined in code?</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: can be accessed as a cached class property via ds_list</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">listDatastreams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">dsobj</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">ObjectDatastreams</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">ds</span><span class="o">.</span><span class="n">dsid</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dsobj</span><span class="o">.</span><span class="n">datastreams</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ds_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>      <span class="c1"># NOTE: how to name to distinguish from locally configured datastream objects?</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of all datastreams that belong to this object in Fedora.</span>
<span class="sd">        Key is datastream id, value is an :class:`ObjectDatastream` for that</span>
<span class="sd">        datastream.</span>

<span class="sd">        Only retrieved when requested; cached after first retrieval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: how to make access to a versioned ds_list ?</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_datastreams</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_methods</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span>

    <span class="k">def</span> <span class="nf">get_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">listMethods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">parse_xml_object</span><span class="p">(</span><span class="n">ObjectMethods</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">sdef</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">sdef</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">sdef</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">service_definitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span>

    <span class="k">def</span> <span class="nf">getDissemination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_pid</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">return_http_response</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getDissemination</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">service_pid</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getDatastreamObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">dsobj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get any datastream on this object as a :class:`DatastreamObject`</span>
<span class="sd">        **or** add a new datastream.  If the datastream id corresponds</span>
<span class="sd">        to a predefined datastream, the configured object will be returned</span>
<span class="sd">        and the datastream object will be returned.  If type is not</span>
<span class="sd">        specified for an existing datastream, attempts to infer the</span>
<span class="sd">        appropriate subclass of datastream object to return based on the</span>
<span class="sd">        mimetype (for XML and RELS-EXT).</span>

<span class="sd">        Note that if you use this method to add new datastreams you should</span>
<span class="sd">        be sure to set all datastream metadata appropriately for your content</span>
<span class="sd">        (i.e., label, mimetype, control group, etc).</span>

<span class="sd">        :param dsid: datastream id</span>
<span class="sd">        :param dsobj_type: optional :class:`DatastreamObject` type to</span>
<span class="sd">            be returned</span>
<span class="sd">        :param as_of_date: optional datetime, used to load a historical</span>
<span class="sd">            version of the requested datastream</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># NOTE: disabling this option because it returns a Datastream instead of</span>
        <span class="c1"># a DatastreamObject, which is unexpected</span>
        <span class="c1"># if the requested datastream is a defined datastream, return it</span>
        <span class="c1"># if dsid in self._defined_datastreams:</span>
            <span class="c1"># return self._defined_datastreams[dsid]</span>

        <span class="k">if</span> <span class="n">dsid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adhoc_datastreams</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adhoc_datastreams</span><span class="p">[</span><span class="n">dsid</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dsid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="p">:</span>
            <span class="n">ds_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="p">[</span><span class="n">dsid</span><span class="p">]</span>
            <span class="c1"># FIXME: can we take advantage of Datastream descriptor? or at least use dscache ?</span>

            <span class="k">if</span> <span class="n">dsobj_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># if datastream mimetype matches one of our base datastream objects, use it</span>

                <span class="c1"># special case: rels-ext should always be loaded as rdf</span>
                <span class="k">if</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">mimeType</span> <span class="o">==</span> <span class="n">RdfDatastreamObject</span><span class="o">.</span><span class="n">default_mimetype</span> <span class="ow">or</span> \
                    <span class="n">dsid</span> <span class="o">==</span> <span class="s1">&#39;RELS-EXT&#39;</span><span class="p">:</span>
                    <span class="n">dsobj_type</span> <span class="o">=</span> <span class="n">RdfDatastreamObject</span>
                <span class="k">elif</span> <span class="n">ds_info</span><span class="o">.</span><span class="n">mimeType</span> <span class="o">==</span> <span class="n">XmlDatastreamObject</span><span class="o">.</span><span class="n">default_mimetype</span><span class="p">:</span>
                    <span class="n">dsobj_type</span> <span class="o">=</span> <span class="n">XmlDatastreamObject</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># default to base datastream object class</span>
                    <span class="n">dsobj_type</span> <span class="o">=</span> <span class="n">DatastreamObject</span>

            <span class="n">dsobj</span> <span class="o">=</span> <span class="n">dsobj_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ds_info</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="n">ds_info</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                <span class="n">as_of_date</span><span class="o">=</span><span class="n">as_of_date</span><span class="p">)</span>

            <span class="c1"># add to dscache so modifications will be saved on existing object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="n">dsid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsobj</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dsobj</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dsobj_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">dsobj_type</span> <span class="o">=</span> <span class="n">DatastreamObject</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding new datastream </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dsid</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="c1"># NOTE: label is required to initialize a new datastream object;</span>
            <span class="c1"># using dsid as label since we don&#39;t have anything else.</span>
            <span class="n">dsobj</span> <span class="o">=</span> <span class="n">dsobj_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">)</span>
            <span class="c1"># add to the adhoc datastreams so it will get ingested to fedora (if new)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_adhoc_datastreams</span><span class="p">[</span><span class="n">dsid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsobj</span>
            <span class="c1"># make available like a defined datastream object so ingest will work</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">dsobj</span><span class="p">)</span>
            <span class="c1"># add to dscache so new datastream will be saved on existing object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="n">dsid</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsobj</span>
            <span class="c1"># default modification logic should be appropriate here since the</span>
            <span class="c1"># calling program should be setting content, label, etc</span>

            <span class="k">return</span> <span class="n">dsobj</span>

    <span class="k">def</span> <span class="nf">add_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new relationship to the RELS-EXT for this object.</span>
<span class="sd">        Calls :meth:`API_M.addRelationship`.</span>

<span class="sd">        Example usage::</span>

<span class="sd">            isMemberOfCollection = &#39;info:fedora/fedora-system:def/relations-external#isMemberOfCollection&#39;</span>
<span class="sd">            collection_uri = &#39;info:fedora/foo:456&#39;</span>
<span class="sd">            object.add_relationship(isMemberOfCollection, collection_uri)</span>

<span class="sd">        :param rel_uri: URI for the new relationship</span>
<span class="sd">        :param obj: related object; can be :class:`DigitalObject` or string; if</span>
<span class="sd">                        string begins with info:fedora/ it will be treated as</span>
<span class="sd">                        a resource, otherwise it will be treated as a literal</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_uri</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">):</span>
            <span class="n">rel_uri</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">rel_uri</span><span class="p">)</span>

        <span class="n">obj_is_literal</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DigitalObject</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">obj_is_literal</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span> \
          <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span><span class="p">):</span>
            <span class="n">obj_is_literal</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># this call will change RELS-EXT, possibly creating it if it&#39;s</span>
        <span class="c1"># missing. remove any cached info we have for that datastream.</span>
        <span class="k">if</span> <span class="s1">&#39;RELS-EXT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="s1">&#39;RELS-EXT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_is_literal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">purge_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Purge a relationship from RELS-EXT for this object.</span>
<span class="sd">        Calls :meth:`API_M.purgeRelationship`.</span>

<span class="sd">        Example usage::</span>

<span class="sd">            isMemberOfCollection = &#39;info:fedora/fedora-system:def/relations-external#isMemberOfCollection&#39;</span>
<span class="sd">            collection_uri = &#39;info:fedora/foo:789&#39;</span>
<span class="sd">            object.purge_relationship(isMemberOfCollection, collection_uri)</span>

<span class="sd">        :param rel_uri: URI for the existing relationship</span>
<span class="sd">        :param obj: related object; can be :class:`DigitalObject` or string; if</span>
<span class="sd">                        string begins with info:fedora/ it will be treated as</span>
<span class="sd">                        a resource, otherwise it will be treated as a literal</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_uri</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">):</span>
            <span class="n">rel_uri</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">rel_uri</span><span class="p">)</span>

        <span class="n">obj_is_literal</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DigitalObject</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">obj_is_literal</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span> \
          <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span><span class="p">):</span>
            <span class="n">obj_is_literal</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># this call will change RELS-EXT, possibly creating it if it&#39;s</span>
        <span class="c1"># missing. remove any cached info we have for that datastream.</span>
        <span class="k">if</span> <span class="s1">&#39;RELS-EXT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="s1">&#39;RELS-EXT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">purgeRelationship</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_is_literal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">modify_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">old_object</span><span class="p">,</span> <span class="n">new_object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify a relationship from RELS-EXT for this object.  As the Fedora API-M does not contain</span>
<span class="sd">        a native &quot;modifyRelationship&quot;, this method purges an existing one, then adds a new one,</span>
<span class="sd">        pivoting on the predicate.</span>
<span class="sd">        Calls :meth:`API_M.purgeRelationship`, :meth:`API_M.addRelationship`</span>

<span class="sd">        Example usage::</span>

<span class="sd">            predicate = &#39;info:fedora/fedora-system:def/relations-external#isMemberOfCollection&#39;</span>
<span class="sd">            old_object = &#39;info:fedora/foo:456&#39;</span>
<span class="sd">            new_object = &#39;info:fedora/foo:789&#39;</span>

<span class="sd">            object.modify_relationship(predicate, old_object, new_object)</span>

<span class="sd">        :param rel_uri: URI for the existing relationship</span>
<span class="sd">        :param old_object: previous target object for relationship; can be</span>
<span class="sd">                        :class:`DigitalObject` or string; if string begins with info:fedora/ it</span>
<span class="sd">                        will be treated as a resource, otherwise it will be treated as a literal</span>
<span class="sd">        :param new_object: new target object for relationship; can be</span>
<span class="sd">                        :class:`DigitalObject` or string; if string begins with info:fedora/ it</span>
<span class="sd">                        will be treated as a resource, otherwise it will be treated as a literal</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rel_uri</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">):</span>
            <span class="n">rel_uri</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">rel_uri</span><span class="p">)</span>

        <span class="c1"># old_object</span>
        <span class="n">obj_old_is_literal</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_object</span><span class="p">,</span> <span class="n">DigitalObject</span><span class="p">):</span>
            <span class="n">old_object</span> <span class="o">=</span> <span class="n">old_object</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">obj_old_is_literal</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">old_object</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_object</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span> \
          <span class="ow">and</span> <span class="n">old_object</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span><span class="p">):</span>
            <span class="n">obj_old_is_literal</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># new_object</span>
        <span class="n">obj_new_is_literal</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_object</span><span class="p">,</span> <span class="n">DigitalObject</span><span class="p">):</span>
            <span class="n">new_object</span> <span class="o">=</span> <span class="n">new_object</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">obj_new_is_literal</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_object</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_object</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">))</span> \
          <span class="ow">and</span> <span class="n">new_object</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span><span class="p">):</span>
            <span class="n">obj_new_is_literal</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># this call will change RELS-EXT, possibly creating it if it&#39;s</span>
        <span class="c1"># missing. remove any cached info we have for that datastream.</span>
        <span class="k">if</span> <span class="s1">&#39;RELS-EXT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dscache</span><span class="p">[</span><span class="s1">&#39;RELS-EXT&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_list</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># attempt purge</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">purgeRelationship</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">old_object</span><span class="p">,</span> <span class="n">obj_old_is_literal</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># attempt add</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">new_object</span><span class="p">,</span> <span class="n">obj_new_is_literal</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># if addRelationship fails, rollback to old_object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">addRelationship</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">rel_uri</span><span class="p">,</span> <span class="n">old_object</span><span class="p">,</span> <span class="n">obj_old_is_literal</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">has_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this object subscribes to the specified content model.</span>

<span class="sd">        :param model: URI for the content model, as a string</span>
<span class="sd">                    (currently only accepted in ``info:fedora/foo:###`` format)</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># - accept DigitalObject for model?</span>
        <span class="c1"># - convert model pid to info:fedora/ form if not passed in that way?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span>
        <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
            <span class="c1"># if rels-ext can&#39;t be retrieved, confirm this object does not have a RELS-EXT</span>
            <span class="c1"># (in which case, it does not subscribe to the specified content model)</span>
            <span class="k">if</span> <span class="s2">&quot;RELS-EXT&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">modelns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">rels</span>

    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of content models the object subscribes to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span>
        <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
            <span class="c1"># if rels-ext can&#39;t be retrieved, confirm this object does not have a RELS-EXT</span>
            <span class="c1"># (in which case, it does not have any content models)</span>
            <span class="k">if</span> <span class="s2">&quot;RELS-EXT&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">rels</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">modelns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate and return a dictionary of default fields to be</span>
<span class="sd">        indexed for searching (e.g., in Solr).  Includes top-level</span>
<span class="sd">        object properties, Content Model URIs, and Dublin Core</span>
<span class="sd">        fields.</span>

<span class="sd">        This method is intended to be customized and extended in order</span>
<span class="sd">        to easily modify the fields that should be indexed for any</span>
<span class="sd">        particular type of object in any project; data returned from</span>
<span class="sd">        this method should be serializable as JSON (the current</span>
<span class="sd">        implementation uses :mod:`django.utils.simplejson`).</span>

<span class="sd">        This method was designed for use with :mod:`eulfedora.indexdata`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">index_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">owners</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="s1">&#39;content_model&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">force_text</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_models</span><span class="p">()],</span>  <span class="c1"># convert URIRefs to strings</span>
            <span class="p">}</span>

        <span class="c1"># date created/modified won&#39;t be set unless the object actually exists in Fedora</span>
        <span class="c1"># (probably the case for anything being indexed, except in tests)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="n">index_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="c1"># last_modified and created are configured as date type in sample solr Schema</span>
                <span class="c1"># using isoformat here so they can be serialized via JSON</span>
                <span class="s1">&#39;last_modified&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="c1"># datastream ids</span>
                <span class="s1">&#39;dsids&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="p">)),</span>
            <span class="p">})</span>

        <span class="n">index_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_data_descriptive</span><span class="p">())</span>
        <span class="n">index_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_data_relations</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">index_data</span>

    <span class="k">def</span> <span class="nf">index_data_descriptive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Descriptive data to be included in :meth:`index_data`</span>
<span class="sd">        output.  This implementation includes all Dublin Core fields,</span>
<span class="sd">        but should be extended or overridden as appropriate for custom</span>
<span class="sd">        :class:`~eulfedora.models.DigitalObject` classes.&#39;&#39;&#39;</span>

        <span class="n">dc_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;contributor&#39;</span><span class="p">,</span> <span class="s1">&#39;coverage&#39;</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;rights&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">dc_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dc_fields</span><span class="p">:</span>
            <span class="n">list_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_list&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">list_field</span><span class="p">:</span>
                <span class="c1"># convert xmlmap lists to straight lists so simplejson can handle them</span>
                <span class="n">dc_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">list_field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dc_data</span>

    <span class="k">def</span> <span class="nf">index_data_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Standard Fedora relations to be included in</span>
<span class="sd">        :meth:`index_data` output.  This implementation includes all</span>
<span class="sd">        standard relations included in the Fedora relations namespace,</span>
<span class="sd">        but should be extended or overridden as appropriate for custom</span>
<span class="sd">        :class:`~eulfedora.models.DigitalObject` classes.&#39;&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># NOTE: hasModel relation is handled with top-level object properties above</span>
        <span class="c1"># currently not indexing other model rels (service bindings)</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">fedora_rels</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="p">[</span><span class="n">rel</span><span class="p">]):</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">force_text</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="k">class</span> <span class="nc">ContentModel</span><span class="p">(</span><span class="n">DigitalObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fedora CModel object&quot;&quot;&quot;</span>

    <span class="n">CONTENT_MODELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;info:fedora/fedora-system:ContentModel-3.0&#39;</span><span class="p">]</span>
    <span class="n">ds_composite_model</span> <span class="o">=</span> <span class="n">XmlDatastream</span><span class="p">(</span><span class="s1">&#39;DS-COMPOSITE-MODEL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Datastream Composite Model&#39;</span><span class="p">,</span> <span class="n">DsCompositeModel</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;info:fedora/fedora-system:FedoraDSCompositeModel-1.0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;control_group&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span>
                <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="p">})</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">for_class</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">cmodels</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;CONTENT_MODELS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmodels</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has no content models&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmodels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> has </span><span class="si">%d</span><span class="s1"> content models&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmodels</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s1">&#39;Cannot construct ContentModel object for &#39;</span> <span class="o">+</span>
                              <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, which has </span><span class="si">%d</span><span class="s1"> CONTENT_MODELS (only 1 is &#39;</span> <span class="o">+</span>
                              <span class="s1">&#39;supported)&#39;</span><span class="p">)</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmodels</span><span class="p">)))</span>

        <span class="n">cmodel_uri</span> <span class="o">=</span> <span class="n">cmodels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cmodel for </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">cmodel_uri</span><span class="p">))</span>
        <span class="n">cmodel_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">cmodel_uri</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">ContentModel</span><span class="p">,</span>
                                     <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmodel_obj</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> already exists&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmodel_uri</span><span class="p">,))</span>
            <span class="k">return</span> <span class="n">cmodel_obj</span>

        <span class="c1"># otherwise the cmodel doesn&#39;t exist. let&#39;s create it.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;creating </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmodel_uri</span><span class="p">,</span> <span class="n">full_name</span><span class="p">))</span>
        <span class="n">cmodel_obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">cmodel_uri</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">ContentModel</span><span class="p">,</span>
                                     <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># XXX: should this use _defined_datastreams instead?</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_local_datastreams</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ds_composite_model</span> <span class="o">=</span> <span class="n">cmodel_obj</span><span class="o">.</span><span class="n">ds_composite_model</span><span class="o">.</span><span class="n">content</span>
            <span class="n">type_model</span> <span class="o">=</span> <span class="n">ds_composite_model</span><span class="o">.</span><span class="n">get_type_model</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">type_model</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">default_mimetype</span>
            <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">default_format_uri</span><span class="p">:</span>
                <span class="n">type_model</span><span class="o">.</span><span class="n">format_uri</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">default_format_uri</span>
        <span class="n">cmodel_obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cmodel_obj</span>


<span class="k">class</span> <span class="nc">DigitalObjectSaveFailure</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom exception class for when a save error occurs part-way through saving</span>
<span class="sd">    an instance of :class:`DigitalObject`.  This exception should contain enough</span>
<span class="sd">    information to determine where the save failed, and whether or not any changes</span>
<span class="sd">    saved before the failure were successfully rolled back.</span>

<span class="sd">    These properties are available:</span>
<span class="sd">     * obj_pid - pid of the :class:`DigitalObject` instance that failed to save</span>
<span class="sd">     * failure - string indicating where the failure occurred (either a datastream ID or &#39;object profile&#39;)</span>
<span class="sd">     * to_be_saved - list of datastreams that were modified and should have been saved</span>
<span class="sd">     * saved - list of datastreams that were successfully saved before failure occurred</span>
<span class="sd">     * cleaned - list of saved datastreams that were successfully rolled back</span>
<span class="sd">     * not_cleaned - saved datastreams that were not rolled back</span>
<span class="sd">     * recovered - boolean, True indicates all saved datastreams were rolled back</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">failure</span><span class="p">,</span> <span class="n">to_be_saved</span><span class="p">,</span> <span class="n">saved</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">failure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_be_saved</span> <span class="o">=</span> <span class="n">to_be_saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span> <span class="o">=</span> <span class="n">saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span>
        <span class="c1"># check for anything was saved before failure occurred that was *not* cleaned up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovered</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">not_cleaned</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Error saving </span><span class="si">%s</span><span class="s2"> - failed to save </span><span class="si">%s</span><span class="s2">; saved </span><span class="si">%s</span><span class="s2">; successfully backed out </span><span class="si">%s</span><span class="s2">&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_pid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">),</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span><span class="p">))</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OpenEmory 2.2.8-dev documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2011, Emory University Libraries.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>