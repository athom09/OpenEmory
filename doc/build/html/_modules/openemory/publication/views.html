<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openemory.publication.views &mdash; OpenEmory 2.2.8-dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.2.8-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="OpenEmory 2.2.8-dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenEmory 2.2.8-dev documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for openemory.publication.views</h1><div class="highlight"><pre>
<span></span><span class="c1"># file openemory/publication/views.py</span>
<span class="c1">#</span>
<span class="c1">#   Copyright 2010 Emory University General Library</span>
<span class="c1">#</span>
<span class="c1">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#   you may not use this file except in compliance with the License.</span>
<span class="c1">#   You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#       http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#   See the License for the specific language governing permissions and</span>
<span class="c1">#   limitations under the License.</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">slugify</span> <span class="kn">import</span> <span class="n">slugify</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pyPdf</span> <span class="kn">import</span> <span class="n">PdfFileReader</span><span class="p">,</span> <span class="n">PdfFileWriter</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">URIRef</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">rdflib.graph</span> <span class="kn">import</span> <span class="n">Graph</span> <span class="k">as</span> <span class="n">RdfGraph</span><span class="p">,</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.core.serializers.json</span> <span class="kn">import</span> <span class="n">DjangoJSONEncoder</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">mail_managers</span><span class="p">,</span> <span class="n">send_mail</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Sum</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseForbidden</span><span class="p">,</span> \
    <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.template.context</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">get_template</span><span class="p">,</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_http_methods</span><span class="p">,</span> <span class="n">last_modified</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">eulcommon.djangoextras.http</span> <span class="kn">import</span> <span class="n">HttpResponseSeeOtherRedirect</span>
<span class="kn">from</span> <span class="nn">eulcommon.searchutil</span> <span class="kn">import</span> <span class="n">search_terms</span>
<span class="kn">from</span> <span class="nn">eulfedora.models</span> <span class="kn">import</span> <span class="n">DigitalObjectSaveFailure</span>
<span class="kn">from</span> <span class="nn">eulfedora.rdfns</span> <span class="kn">import</span> <span class="n">relsext</span><span class="p">,</span> <span class="n">oai</span>
<span class="kn">from</span> <span class="nn">eulfedora.server</span> <span class="kn">import</span> <span class="n">Repository</span>
<span class="kn">from</span> <span class="nn">eulfedora.util</span> <span class="kn">import</span> <span class="n">RequestFailed</span><span class="p">,</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span> <span class="nn">eulfedora.views</span> <span class="kn">import</span> <span class="n">raw_datastream</span><span class="p">,</span> <span class="n">raw_audit_trail</span>
<span class="kn">from</span> <span class="nn">pyPdf.utils</span> <span class="kn">import</span> <span class="n">PdfReadError</span>
<span class="kn">from</span> <span class="nn">sunburnt</span> <span class="kn">import</span> <span class="n">sunburnt</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">EmailMultiAlternatives</span>

<span class="kn">from</span> <span class="nn">openemory.accounts.auth</span> <span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">permission_required</span>
<span class="kn">from</span> <span class="nn">openemory.common</span> <span class="kn">import</span> <span class="n">romeo</span>
<span class="kn">from</span> <span class="nn">openemory.harvest.models</span> <span class="kn">import</span> <span class="n">HarvestRecord</span>
<span class="kn">from</span> <span class="nn">openemory.publication.forms</span> <span class="kn">import</span> <span class="n">UploadForm</span><span class="p">,</span> <span class="n">AdminUploadForm</span><span class="p">,</span> \
        <span class="n">BasicSearchForm</span><span class="p">,</span> <span class="n">SearchWithinForm</span><span class="p">,</span> <span class="n">PublicationModsEditForm</span><span class="p">,</span> <span class="n">ConferenceEditForm</span><span class="p">,</span> <span class="n">PresentationEditForm</span><span class="p">,</span> <span class="n">OpenAccessProposalForm</span><span class="p">,</span> <span class="n">BookEditForm</span><span class="p">,</span> <span class="n">ReportEditForm</span><span class="p">,</span> <span class="n">ChapterEditForm</span><span class="p">,</span> <span class="n">ArticleEditForm</span><span class="p">,</span> <span class="n">PosterEditForm</span>

<span class="kn">from</span> <span class="nn">openemory.publication.models</span> <span class="kn">import</span> <span class="n">Publication</span><span class="p">,</span> <span class="n">AuthorName</span><span class="p">,</span> <span class="n">ArticleStatistics</span><span class="p">,</span> \
        <span class="n">ResearchFields</span><span class="p">,</span> <span class="n">FeaturedArticle</span><span class="p">,</span> <span class="n">Article</span>
<span class="kn">from</span> <span class="nn">openemory.util</span> <span class="kn">import</span> <span class="n">md5sum</span><span class="p">,</span> <span class="n">solr_interface</span><span class="p">,</span> <span class="n">paginate</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="mail_listserv"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.mail_listserv">[docs]</a><span class="k">def</span> <span class="nf">mail_listserv</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">fail_silently</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">html_message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sends a message to the managers, as defined by the MANAGERS setting.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">LISTSERV</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">EmailMultiAlternatives</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">EMAIL_SUBJECT_PREFIX</span><span class="p">,</span> <span class="n">subject</span><span class="p">),</span>
                <span class="n">message</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_EMAIL</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">LISTSERV</span><span class="p">],</span>
                <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">html_message</span><span class="p">:</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">attach_alternative</span><span class="p">(</span><span class="n">html_message</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">()</span></div>


<span class="c1"># solr fields we usually want for views that list articles</span>
<span class="n">PUBLICATION_VIEW_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span>
    <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;dsids&#39;</span><span class="p">,</span> <span class="s1">&#39;last_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;pmcid&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
    <span class="s1">&#39;parsed_author&#39;</span><span class="p">,</span><span class="s1">&#39;embargo_end&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;researchfield&#39;</span><span class="p">,</span>
    <span class="s1">&#39;journal_title&#39;</span><span class="p">,</span> <span class="s1">&#39;pubyear&#39;</span><span class="p">,</span> <span class="s1">&#39;withdrawn&#39;</span><span class="p">,</span><span class="s1">&#39;record_type&#39;</span><span class="p">,</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span><span class="s1">&#39;pubdate&#39;</span><span class="p">,</span><span class="s1">&#39;journal_publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;keyword&#39;</span><span class="p">]</span>

<span class="n">json_serializer</span> <span class="o">=</span> <span class="n">DjangoJSONEncoder</span><span class="p">(</span><span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="nd">@login_required</span>
<span class="nd">@require_http_methods</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="ingest"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.ingest">[docs]</a><span class="k">def</span> <span class="nf">ingest</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a new :class:`~openemory.publication.models.Article`</span>
<span class="sd">    object and ingest into the repository one of two ways:</span>

<span class="sd">      * By uploading a file from a web form.  On GET, displays the</span>
<span class="sd">        upload form.  On POST with a valid file, ingests the content</span>
<span class="sd">        into Fedora.</span>

<span class="sd">      * When a request is POSTed via AJAX, looks for a pmcid in the</span>
<span class="sd">        request to find the</span>
<span class="sd">        :class:`~openemory.harvest.models.HarvestRecord` to be</span>
<span class="sd">        ingested.  Requires site admin permissions.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># init repo with request to use logged-in user credentials for fedora access</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Collection to which all articles will belong for use with OAI</span>
        <span class="n">coll</span> <span class="o">=</span>  <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PID_ALIASES</span><span class="p">[</span><span class="s1">&#39;oe-collection&#39;</span><span class="p">])</span>

        <span class="c1"># ajax request: should pass pmcid for HarvestRecord to be ingested</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
            <span class="c1"># check that user has required permissions</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;harvest.ingest_harvestrecord&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s1">&#39;Permission Denied&#39;</span><span class="p">,</span>
                                             <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>

            <span class="c1"># TODO: when more external systems are added in addition</span>
            <span class="c1"># to Pub Meb, we will have to figure out how to identify</span>
            <span class="c1"># which system is being referenced.  Will likely have to</span>
            <span class="c1"># add to the Harvest record model.</span>

            <span class="c1"># TODO: Update so premis events are included on object</span>
            <span class="c1"># ingest, rather than requiring a secondary save?</span>
            <span class="k">if</span> <span class="s1">&#39;pmcid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;pmcid&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s1">&#39;No record specified for ingest&#39;</span><span class="p">,</span>
                                              <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">HarvestRecord</span><span class="p">,</span> <span class="n">pmcid</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;pmcid&#39;</span><span class="p">])</span>
            <span class="c1"># NOTE: possible race condition. see:</span>
            <span class="c1">#   http://www.no-ack.org/2010/07/mysql-transactions-and-django.html</span>
            <span class="c1">#   https://coderanger.net/2011/01/select-for-update/</span>
            <span class="c1">#   https://code.djangoproject.com/ticket/2705</span>
            <span class="c1"># due to the low likelihood of this happening in production and</span>
            <span class="c1"># the small impact if it does, ignoring it until the above</span>
            <span class="c1"># django ticket #2705 is released and its select_for_update()</span>
            <span class="c1"># syntax is available.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">ingestable</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s1">&#39;Record cannot be ingested&#39;</span><span class="p">,</span>
                                              <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
            <span class="n">record</span><span class="o">.</span><span class="n">mark_in_process</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># initialize a new article object from the harvest record</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">as_publication_article</span><span class="p">(</span><span class="n">repo</span><span class="o">=</span><span class="n">repo</span><span class="p">)</span>

                <span class="c1"># Add to OpenEmory Collection</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">coll</span>


                <span class="n">saved</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Ingest from harvested record PubMed Central </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                 <span class="n">record</span><span class="o">.</span><span class="n">pmcid</span><span class="p">)</span>
                <span class="c1"># Modify DC namespaces for OAI</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_prep_dc_for_oai</span><span class="p">()</span>
                <span class="n">saved</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Modified Namespaces for DC&#39;</span><span class="p">)</span>
                <span class="c1"># saved = True</span>
                <span class="k">if</span> <span class="n">saved</span><span class="p">:</span>


                    <span class="c1"># mark the database record as ingested</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">mark_ingested</span><span class="p">()</span>

                    <span class="c1">#add harvested premis event</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">init_object</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">harvest_event</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">harvested</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">pmcid</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;added harvested event&#39;</span><span class="p">)</span>

                    <span class="c1"># return a 201 Created with new location</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Ingested as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                                            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
                                            <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
                    <span class="c1"># return a location for the newly created object</span>
                    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;publication:view&#39;</span><span class="p">,</span>
                                                   <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">response</span>
            <span class="k">except</span> <span class="n">RequestFailed</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">DEFAULT_STATUS</span>
                <span class="n">record</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rf</span><span class="p">,</span>
                                    <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/plain&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

        <span class="c1"># otherwise, assume form data was POSTed and handle as upload form</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># admins (people who can &quot;review_article&quot;) have the option of</span>
            <span class="c1"># uploading their own articles or those of others. this admin</span>
            <span class="c1"># form requires them to select which role they are performing so</span>
            <span class="c1"># that we can properly reflect the legal statements they agree</span>
            <span class="c1"># to in fedora.</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">):</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">AdminUploadForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">UploadForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="c1"># LEGAL NOTE: Failure to assent (in</span>
                <span class="c1"># form.cleaned_data[&#39;assent&#39;]) is currently processed as an</span>
                <span class="c1"># invalid form. Legal counsel recommends requiring such</span>
                <span class="c1"># assent before processing file upload.</span>
                <span class="k">assert</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assent&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

                <span class="n">obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Article</span><span class="p">)</span>

                <span class="c1"># a few metadata values depend on whether the user submitted</span>
                <span class="c1"># as an author or mediated submission.</span>
                <span class="n">statement</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;legal_statement&#39;</span><span class="p">,</span> <span class="s1">&#39;AUTHOR&#39;</span><span class="p">)</span>

                <span class="c1"># TODO: move init logic into an Article class method?</span>
                <span class="c1"># TODO: remove initial dc field? set preliminary mods title from file?</span>
                <span class="n">uploaded_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
                <span class="c1"># use filename as preliminary title</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">uploaded_file</span><span class="o">.</span><span class="n">name</span>
                <span class="c1"># copy object label into dc:title</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">label</span>
                <span class="c1"># set the username of the currently-logged in user as object owner</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
                <span class="c1"># ingest as inactive (not publicly visible until author edits &amp; publishes)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
                <span class="c1"># set uploaded file as pdf datastream content</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">uploaded_file</span>
                <span class="c1"># for now, use the content type passed by the browser (even though we know it is unreliable)</span>
                <span class="c1"># eventually, we&#39;ll want to use mime magic to inspect files before ingest</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="n">uploaded_file</span><span class="o">.</span><span class="n">content_type</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">mimetype</span>

                <span class="c1"># set static MODS values that will be the same for all uploaded articles</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Article&#39;</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">create_physical_description</span><span class="p">()</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">physical_description</span><span class="o">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="s1">&#39;application/pdf&#39;</span>

                <span class="c1"># set current user as first author</span>
                <span class="k">if</span> <span class="n">statement</span> <span class="o">==</span> <span class="s1">&#39;AUTHOR&#39;</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AuthorName</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                                                                    <span class="n">family_name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                                                                    <span class="n">given_name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                                                                    <span class="n">affiliation</span><span class="o">=</span><span class="s1">&#39;Emory University&#39;</span><span class="p">))</span>

                <span class="c1"># calculate MD5 checksum for the uploaded file before ingest</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="n">md5sum</span><span class="p">(</span><span class="n">uploaded_file</span><span class="o">.</span><span class="n">temporary_file_path</span><span class="p">())</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">checksum_type</span> <span class="o">=</span> <span class="s1">&#39;MD5&#39;</span>

                <span class="c1"># Add to OpenEmory Collection</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">coll</span>


                <span class="k">try</span><span class="p">:</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;upload via OpenEmory&#39;</span><span class="p">)</span>
                    <span class="c1"># Modify DC namespaces for OAI</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_prep_dc_for_oai</span><span class="p">()</span>
                    <span class="n">saved</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;Modified Namespaces for DC&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">saved</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                            <span class="s1">&#39;Success! Your article was uploaded. Please complete the required fields in Citation Information and submit.&#39;</span><span class="p">,</span>
                            <span class="n">extra_tags</span><span class="o">=</span><span class="s1">&#39;upload&#39;</span><span class="p">)</span>
                        <span class="n">next_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;publication:edit&#39;</span><span class="p">,</span>
                                           <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">})</span>

                        <span class="c1">#add uploaded premis event</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">init_object</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">upload_event</span><span class="p">:</span>
                            <span class="c1"># LEGAL NOTE: Legal counsel recommends what we</span>
                            <span class="c1"># require assent to deposit before processing</span>
                            <span class="c1"># file upload. We do this by making the assent</span>
                            <span class="c1"># field required in the form. Thus assent here</span>
                            <span class="c1"># should always be True. We&#39;re leaving this</span>
                            <span class="c1"># check in place in case current or future code</span>
                            <span class="c1"># error accidentally changes that precondition.</span>
                            <span class="c1">#</span>
                            <span class="c1"># For the statement that the user agreed to, we</span>
                            <span class="c1"># check the form. The admin form has a required</span>
                            <span class="c1"># legal_statement that specifies this. The</span>
                            <span class="c1"># regular admin form has no such field: It only</span>
                            <span class="c1"># presents the author option.</span>
                            <span class="n">assent</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assent&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                            <span class="n">statement</span> <span class="o">=</span> <span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;legal_statement&#39;</span><span class="p">,</span> <span class="s1">&#39;AUTHOR&#39;</span><span class="p">)</span>
                                         <span class="k">if</span> <span class="n">assent</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

                            <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">uploaded</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                    <span class="n">legal_statement</span><span class="o">=</span><span class="n">statement</span><span class="p">)</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;added upload event&#39;</span><span class="p">)</span>

                        <span class="k">return</span> <span class="n">HttpResponseSeeOtherRedirect</span><span class="p">(</span><span class="n">next_url</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">RequestFailed</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
                    <span class="n">context</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># init unbound form for display</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">):</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">AdminUploadForm</span><span class="p">({</span><span class="s1">&#39;legal_statement&#39;</span><span class="p">:</span> <span class="s1">&#39;MEDIATED&#39;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">UploadForm</span><span class="p">()</span>

    <span class="n">context</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/upload.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="object_last_modified"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.object_last_modified">[docs]</a><span class="k">def</span> <span class="nf">object_last_modified</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return the last modification date for an object in Fedora, to</span>
<span class="sd">    allow for conditional processing with use with</span>
<span class="sd">    :meth:`django.views.decorators.last_modified`.&#39;&#39;&#39;</span>
    <span class="c1"># TODO: does this make sense to put in eulfedora?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">modified</span>
    <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
        <span class="k">pass</span></div>

<span class="c1"># TODO: consider renaming to get_article_or_404 for consistency with django</span>
<span class="k">def</span> <span class="nf">_get_article_for_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Publication</span><span class="p">)</span>

        <span class="c1"># TODO: if object is not published (i.e. status != &#39;A&#39;),</span>
        <span class="c1"># should probably only display to authors/admins</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>
    <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>
    <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_parse_name</span><span class="p">(</span><span class="n">terms</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    parse the terms to see if it looks like a name</span>

<span class="sd">    works with:</span>
<span class="sd">    first last</span>
<span class="sd">    first mi last</span>
<span class="sd">    last, first</span>
<span class="sd">    last, first mi</span>

<span class="sd">    :param terms: a the keyword search terms</span>

<span class="sd">    returns: a dict with:</span>
<span class="sd">    full_name (firstname lastname),</span>
<span class="sd">    first_name,</span>
<span class="sd">    last_name,</span>
<span class="sd">    last_first(lastname, firstname)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">lname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">name_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">name_parts</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">lname</span><span class="p">)</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lname</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;last_first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mi</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">mi</span> <span class="o">=</span><span class="n">name_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">lname</span><span class="p">)</span>
            <span class="c1">#when there is a middle initial it is included in first name</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lname</span>
            <span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;last_first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name_info</span>


<span class="c1"># FIXME: this needs a vary header (varies if user is logged in - session? cookie?)</span>
<span class="nd">@last_modified</span><span class="p">(</span><span class="n">object_last_modified</span><span class="p">)</span>
<div class="viewcode-block" id="view_article"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.view_article">[docs]</a><span class="k">def</span> <span class="nf">view_article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View to display an</span>
<span class="sd">    :class:`~openemory.publication.models.Article` .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;fedoraAdmin&#39;</span><span class="p">,</span>
                                     <span class="n">password</span><span class="o">=</span><span class="s1">&#39;fedoraAdmin&#39;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Publication</span><span class="p">)</span>
    
    <span class="c1"># *** SPECIAL CASE (should be semi-temporary)</span>
    <span class="c1"># (Added 12/2012; can be removed once openemory:* pids are no longer</span>
    <span class="c1"># indexed, possibly after a few months.)</span>
    <span class="c1"># Early objects were ingested with the wrong pidspace. If someone</span>
    <span class="c1"># tries to access an openemory:### pid and the corresponding</span>
    <span class="c1"># pid exists in the default pidspace, permanent redirect to the</span>
    <span class="c1"># existing object.  Otherwise, 404 as usual.</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">pidspace</span> <span class="o">==</span> <span class="s1">&#39;openemory&#39;</span><span class="p">:</span>
        <span class="n">realpid</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;openemory&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">FEDORA_PIDSPACE</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">realpid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Publication</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;publication:view&#39;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">realpid</span><span class="p">}))</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">_get_article_for_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>


    <span class="c1"># only increment stats on GET requests (i.e., not on HEAD)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;harvest.view_harvestrecord&#39;</span><span class="p">):</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">statistics</span><span class="p">()</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">num_views</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/view.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">})</span></div>


<span class="nd">@login_required</span>
<div class="viewcode-block" id="edit_metadata"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.edit_metadata">[docs]</a><span class="k">def</span> <span class="nf">edit_metadata</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View to edit the metadata for an existing</span>
<span class="sd">    :class:`~openemory.publication.models.Article` .</span>

<span class="sd">    On GET, display the form.  When valid form data is POSTed, updates</span>
<span class="sd">    thes object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># response status should be 200 unless something goes wrong</span>
    <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">_get_article_for_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span>  <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">):</span>
        <span class="c1"># not article author or reviewer - deny</span>
        <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;403.html&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)))</span>

    <span class="c1"># initial form data</span>
    <span class="n">initial_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;reviewed&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> \
                         <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">date_reviewed</span><span class="p">),</span>
        <span class="s1">&#39;featured&#39;</span> <span class="p">:</span> <span class="n">FeaturedArticle</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>

    <span class="c1"># see if current user is in the Site Admin Group</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="s1">&#39;Site Admin&#39;</span> <span class="ow">in</span>  <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
    <span class="c1"># see if article is nlm for use with modsEdit form</span>
    <span class="n">is_nlm</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">contentMetadata</span><span class="o">.</span><span class="n">exists</span>
    <span class="n">genre</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> 
    <span class="k">if</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Article&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">ArticleEditForm</span>
    <span class="k">elif</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Book&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">BookEditForm</span>
    <span class="k">elif</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Chapter&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">ChapterEditForm</span>
    <span class="k">elif</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Conference&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">ConferenceEditForm</span>
    <span class="k">elif</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Report&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">ReportEditForm</span>
    <span class="k">elif</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Poster&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">PosterEditForm</span>
    <span class="k">elif</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Presentation&quot;</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">PresentationEditForm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">ArticleEditForm</span>


    <span class="c1"># on GET, instantiate the form with existing object data (if any)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">editform</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                                   <span class="n">initial</span><span class="o">=</span><span class="n">initial_data</span><span class="p">,</span> <span class="n">make_optional</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="n">is_admin</span><span class="p">,</span> <span class="n">is_nlm</span><span class="o">=</span><span class="n">is_nlm</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>

        <span class="c1">#set obj_pid for use with featured article if user has perms to update</span>
        <span class="c1"># and the article is published</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">obj_pid</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj_pid</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># save a draft</span>
        <span class="k">if</span> <span class="s1">&#39;save-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">editform</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                       <span class="n">instance</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">make_optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">obj_pid</span><span class="p">)</span>
            
        <span class="c1"># publish</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;got here&quot;</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">editform</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span>
                                       <span class="n">instance</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">make_optional</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="n">obj_pid</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="n">is_admin</span><span class="p">,</span> <span class="n">is_nlm</span><span class="o">=</span><span class="n">is_nlm</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span>
            <span class="k">print</span> <span class="n">form</span><span class="o">.</span><span class="n">non_field_errors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">print</span> <span class="s2">&quot;got here 2&quot;</span>

            <span class="n">withdrawn</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_withdrawn</span>
            <span class="n">newly_reinstated</span> <span class="o">=</span> <span class="n">newly_withdrawn</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">form</span><span class="o">.</span><span class="n">update_instance</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;author_agreement&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
                <span class="n">new_agreement</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;author_agreement&#39;</span><span class="p">]</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">authorAgreement</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">new_agreement</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">authorAgreement</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="n">new_agreement</span><span class="o">.</span><span class="n">content_type</span>

            <span class="c1"># The pid of the Article only set if user has review perms</span>
            <span class="c1"># This is used to indicate if the featured flag should be updated or not</span>
            <span class="n">obj_pid</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c1"># if user is a reviewer, check if review/withdraw event needs to be added</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">):</span>
                <span class="c1"># if reviewed is selected, store review event</span>
                <span class="k">if</span> <span class="s1">&#39;reviewed&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;reviewed&#39;</span><span class="p">]:</span>
                    <span class="c1"># TODO: use short-form ARK when we add them.</span>
                    <span class="c1"># initialize minimal premis object info (required for validity)</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">init_object</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">)</span>
                    <span class="c1"># add the review event</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">review_event</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">reviewed</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

                        <span class="c1"># RELS-EXT attributes</span>
                        <span class="n">ark_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">ark:/25593/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PIDMAN_HOST</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">sympns</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s1">&#39;info:symplectic/symplectic-elements:def/model#&#39;</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;symp&#39;</span><span class="p">,</span> <span class="n">sympns</span><span class="p">)</span>
                        <span class="n">public_url</span> <span class="o">=</span> <span class="p">(</span><span class="n">URIRef</span><span class="p">(</span><span class="s1">&#39;info:fedora/&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">),</span> <span class="n">URIRef</span><span class="p">(</span><span class="s1">&#39;info:symplectic/symplectic-elements:def/model#hasPublicUrl&#39;</span><span class="p">),</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">ark_uri</span><span class="p">))</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">public_url</span><span class="p">)</span>

                <span class="c1"># if withdrawal/reinstatement state on the form doesn&#39;t</span>
                <span class="c1"># match the object, update the object</span>
                <span class="k">if</span> <span class="n">withdrawn</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;reinstate&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span> \
                            <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;reinstate&#39;</span><span class="p">]:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">init_object</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">reinstated</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;reinstate_reason&#39;</span><span class="p">])</span>
                        <span class="n">withdrawn</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">newly_reinstated</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;withdraw&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span> \
                            <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;withdraw&#39;</span><span class="p">]:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">init_object</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">withdrawn</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;withdraw_reason&#39;</span><span class="p">])</span>
                        <span class="n">withdrawn</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">newly_withdrawn</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c1"># TODO: update dc from MODS?</span>
            <span class="c1"># also use mods:title as object label</span>
            <span class="c1"># obj.label = obj.descMetadata.content.title</span>
            <span class="c1"># if obj.descMetadata.content.journal:</span>
            <span class="c1">#     if obj.descMetadata.content.journal.title:</span>
            <span class="c1">#         obj.descMetadata.content.journal.title = obj.descMetadata.content.journal.title.title()</span>
            <span class="c1"># FIXME: incorrect interactions between withdrawal state and</span>
            <span class="c1"># save/pub/rev state</span>

            <span class="c1"># update object state:</span>
            <span class="c1"># withdrawn objects always get inactive state</span>
            <span class="k">if</span> <span class="n">withdrawn</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="c1"># check if submitted via &quot;save&quot;, keep unpublished</span>
            <span class="k">elif</span> <span class="s1">&#39;save-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
                <span class="c1"># TODO: save probably shouldn&#39;t mark inactive, but just NOT publish</span>
                <span class="c1"># and keep inactive if previously unpublished...</span>
            <span class="c1"># submitted via &quot;publish&quot;</span>
            <span class="k">elif</span> <span class="s1">&#39;publish-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="c1"># make sure object states is active</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>

            <span class="c1"># get result message text:</span>
            <span class="c1"># check if submitted via &quot;save&quot;, keep unpublished</span>
            <span class="k">if</span> <span class="s1">&#39;save-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="p">:</span>
                <span class="n">msg_action</span> <span class="o">=</span> <span class="s1">&#39;saved&#39;</span>
            <span class="c1"># submitted via &quot;publish&quot;</span>
            <span class="k">elif</span> <span class="s1">&#39;publish-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="n">msg_action</span> <span class="o">=</span> <span class="s1">&#39;published&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;review-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="p">:</span>
                <span class="n">msg_action</span> <span class="o">=</span> <span class="s1">&#39;reviewed&#39;</span>

            <span class="k">if</span> <span class="n">newly_withdrawn</span><span class="p">:</span>
                <span class="n">msg_action</span> <span class="o">=</span> <span class="s1">&#39;withdrawn&#39;</span>
            <span class="k">elif</span> <span class="n">newly_reinstated</span><span class="p">:</span>
                <span class="n">msg_action</span> <span class="o">=</span> <span class="s1">&#39;reinstated and &#39;</span> <span class="o">+</span> <span class="n">msg_action</span>

            <span class="n">msg_action</span> <span class="o">=</span> <span class="n">msg_action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">msg_action</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># when saving a published object, calculate the embargo end date and add OAI info</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_published</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">calculate_embargo_end</span><span class="p">()</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">oai_itemID</span> <span class="o">=</span> <span class="s2">&quot;oai:ark:/25593/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">noid</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;updated metadata&#39;</span><span class="p">)</span>
                
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%(msg)s</span><span class="s1"> &lt;</span><span class="si">%(tag)s</span><span class="s1">&gt;</span><span class="si">%(label)s</span><span class="s1">&lt;/</span><span class="si">%(tag)s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> \
                            <span class="p">{</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">msg_action</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;strong&#39;</span><span class="p">})</span>
                <span class="c1"># if submitted via &#39;publish&#39; or &#39;save&#39;, redirect to article detail view</span>
                <span class="k">if</span> <span class="s1">&#39;publish-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span>  <span class="ow">or</span> <span class="s1">&#39;save-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                    <span class="c1"># redirect to article detail view</span>
                    <span class="k">return</span> <span class="n">HttpResponseSeeOtherRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;publication:view&#39;</span><span class="p">,</span>
                                               <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">}))</span>
                <span class="c1"># if submitted via &#39;review&#39;, redirect to review list</span>
                <span class="k">if</span> <span class="s1">&#39;review-record&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="p">:</span>
                    <span class="c1"># redirect to article detail view</span>
                    <span class="k">return</span> <span class="n">HttpResponseSeeOtherRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;publication:review-list&#39;</span><span class="p">))</span>

                <span class="c1"># distinguish between save/publish in success message</span>
                
                <span class="c1"># otherwise, redisplay the edit form</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">DigitalObjectSaveFailure</span><span class="p">,</span> <span class="n">RequestFailed</span><span class="p">)</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>

                <span class="k">print</span> <span class="s2">&quot;obj is not saved&quot;</span>
                <span class="c1"># do we need a different error message for DigitalObjectSaveFailure?</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">PermissionDenied</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s2">&quot;permisssions&quot;</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;You don</span><span class="se">\&#39;</span><span class="s1">t have permission to modify this object in the repository.&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;repo error&quot;</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;There was an error communicating with the repository.&#39;</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                               <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39; Please contact a site administrator.&#39;</span><span class="p">)</span>

                <span class="c1"># pass the fedora error code (if any) back in the http response</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">):</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">)</span>

        <span class="c1"># form was posted but not valid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="c1"># print form</span>
            <span class="c1"># for error in form.non_field_errors:</span>
            <span class="c1">#     print error</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;invalid_form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">context</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span>
    <span class="c1"># research fields/subjects for jquery category-autocomplete</span>
    <span class="n">context</span><span class="p">[</span><span class="s1">&#39;subject_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_serializer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">ResearchFields</span><span class="p">()</span><span class="o">.</span><span class="n">as_category_completion</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/edit.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span>
                  <span class="n">status</span><span class="o">=</span><span class="n">status_code</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_pdf"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.download_pdf">[docs]</a><span class="k">def</span> <span class="nf">download_pdf</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;View to allow access the All datastream of a</span>
<span class="sd">    :class:`openemory.publication.models.Publication` object.  Sets a</span>
<span class="sd">    content-disposition header that will prompt the file to be saved</span>
<span class="sd">    with a default title based on the object label.</span>

<span class="sd">    Returns the original Publication Mime Type with a cover page, if possible;</span>
<span class="sd">    if there is an error generating the cover page version of the PDF,</span>
<span class="sd">    the original PDF will be returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># retrieve the object so we can use it to set the download filename</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Publication</span><span class="p">)</span>
        
        <span class="c1"># if the PDF is embargoed, check that user should have access (bail out if not)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_embargoed</span><span class="p">:</span>
            <span class="c1"># only logged-in authors or site admins are allowed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;401.html&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)),</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> \
                   <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.view_embargoed&#39;</span><span class="p">)):</span>
                <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;403.html&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)))</span>

        <span class="c1"># at this point we know that we&#39;re authorized to view the pdf. bump</span>
        <span class="c1"># stats before doing the deed (but only if this is a GET)</span>
               
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;harvest.view_harvestrecord&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">statistics</span><span class="p">()</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">num_downloads</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">print</span> <span class="s2">&quot;hitting it&quot;</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># try:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">what_mime_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="c1"># try:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pdf_with_cover</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="n">slugify</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="n">extra_headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># generate a default filename based on the object</span>
                <span class="c1"># FIXME: what do we actually want here? ARK noid?</span>
                <span class="s2">&quot;Content-Disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;attachment;filename=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                <span class="c1">#&#39;Last-Modified&#39;: obj.pdf.created,</span>
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/pdf&#39;</span><span class="p">)</span>
            <span class="c1"># except:</span>
            <span class="c1">#     content = obj.zip_with_cover()</span>
            <span class="c1">#     filename = &quot;%s.zip&quot; % slugify(obj.label)</span>

            <span class="c1">#     extra_headers = {</span>
            <span class="c1">#         # generate a default filename based on the object</span>
            <span class="c1">#         # FIXME: what do we actually want here? ARK noid?</span>
            <span class="c1">#         &quot;Content-Disposition&quot;: &quot;attachment;filename=%s&quot; % filename,</span>
            <span class="c1">#         #&#39;Last-Modified&#39;: obj.pdf.created,</span>
            <span class="c1">#     }</span>
            <span class="c1">#     response = HttpResponse(content.getvalue(), content_type=&#39;application/octet-stream&#39;)</span>

            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">zip_with_cover</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.zip&quot;</span> <span class="o">%</span> <span class="n">slugify</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

            <span class="n">extra_headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># generate a default filename based on the object</span>
                <span class="c1"># FIXME: what do we actually want here? ARK noid?</span>
                <span class="s2">&quot;Content-Disposition&quot;</span><span class="p">:</span> <span class="s2">&quot;attachment;filename=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                <span class="c1">#&#39;Last-Modified&#39;: obj.pdf.created,</span>
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">)</span>
            <span class="c1"># pdf+cover depends on metadata; if descMetadata changed more recently</span>
            <span class="c1"># than pdf, use the metadata last-modified date.</span>
            <span class="c1">#if obj.descMetadata.created &gt; obj.pdf.created:</span>
            <span class="c1">#    extra_headers[&#39;Last-Modified&#39;] = obj.descMetadata.created</span>
            <span class="c1"># NOTE: could also potentially change based on cover logic changes...</span>

            <span class="c1"># FIXME: any way to calculate content-length? ETag based on pdf+mods ?</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">extra_headers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">response</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">response</span>

        <span class="c1"># except RequestFailed:</span>
        <span class="c1">#     # re-raise so we can handle it below. TODO: simplify this logic a bit</span>
        <span class="c1">#     raise</span>
        <span class="c1"># except:</span>
        <span class="c1">#     logger.warn(&#39;Exception on %s; returning without cover page&#39; % obj.pid)</span>
        <span class="c1">#     # cover page failed - fall back to pdf without</span>
        <span class="c1">#     # use generic raw datastream view from eulfedora</span>
        <span class="c1">#     return raw_datastream(request, pid, Publication.pdf.id, type=Publication,</span>
        <span class="c1">#                           repo=repo, headers=extra_headers)</span>

    <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span></div>


<span class="c1"># permission ?</span>
<div class="viewcode-block" id="view_datastream"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.view_datastream">[docs]</a><span class="k">def</span> <span class="nf">view_datastream</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Access object datastreams on</span>
<span class="sd">    :class:`openemory.publication.model.Article` objects&#39;&#39;&#39;</span>
    <span class="c1"># initialize local repo with logged-in user credentials &amp; call generic view</span>
    <span class="k">return</span> <span class="n">raw_datastream</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span></div>

<div class="viewcode-block" id="view_private_datastream"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.view_private_datastream">[docs]</a><span class="k">def</span> <span class="nf">view_private_datastream</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Access raw object datastreams accessible only to object owners and</span>
<span class="sd">    superusers.&#39;&#39;&#39;</span>
    <span class="c1"># FIXME: refactor out shared code between this and download_pdf and</span>
    <span class="c1"># possibly view_datastream</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># retrieve the object so we can use it to set the download filename</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Publication</span><span class="p">)</span>
        <span class="n">extra_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># generate a default filename based on the object</span>
            <span class="c1"># FIXME: what do we actually want here? ARK noid?</span>
            <span class="s1">&#39;Content-Disposition&#39;</span><span class="p">:</span> <span class="s2">&quot;attachment; filename=</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># use generic raw datastream view from eulfedora</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">())</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span>
               <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">raw_datastream</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">dsid</span><span class="p">,</span>
                                  <span class="n">repo</span><span class="o">=</span><span class="n">repo</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;403.html&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;401.html&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)),</span> <span class="n">status</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">RequestFailed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span></div>

<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;publication.view_admin_metadata&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="audit_trail"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.audit_trail">[docs]</a><span class="k">def</span> <span class="nf">audit_trail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Access XML audit trail on</span>
<span class="sd">        :class:`openemory.publication.model.Article` objects&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">raw_audit_trail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Publication</span><span class="p">,</span>
                           <span class="n">repo</span><span class="o">=</span><span class="n">Repository</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span></div>


<div class="viewcode-block" id="bibliographic_metadata"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.bibliographic_metadata">[docs]</a><span class="k">def</span> <span class="nf">bibliographic_metadata</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return bibliographic metadata for an article. Currently this view is</span>
<span class="sd">    used primarily to support import to EndNote, though it may be extended</span>
<span class="sd">    to support other formats in the future.&#39;&#39;&#39;</span>

    <span class="n">article</span> <span class="o">=</span> <span class="n">_get_article_for_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_article_as_ris</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_article_as_ris</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Serialize article bibliographic metadata in RIS (Research Info</span>
<span class="sd">    Systems--essentially EndNote) format.</span>

<span class="sd">    :param obj: an :class:`~openemory.publication.models.Article`</span>
<span class="sd">    :param request: an :class:`~django.http.HttpRequest` to help absolutize</span>
<span class="sd">                    the article URL, if available</span>
<span class="sd">    :returns: an :class:`~django.http.HttpResponse`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># The spec talks about the general structure of an RIS file:</span>
    <span class="c1">#   http://www.adeptscience.co.uk/kb/article/FE26</span>
    <span class="c1"># Its list of tags is woefully incomplete, though: It never defines</span>
    <span class="c1"># title, though it does use TI in an example for something that looks</span>
    <span class="c1"># sorta like a title. Using the wikipedia tag list for now:</span>
    <span class="c1">#   http://en.wikipedia.org/w/index.php?title=RIS_(file_format)&amp;oldid=461366552</span>

    <span class="c1"># NOTE: We&#39;re being explicit about using utf-8 here, so be precise about</span>
    <span class="c1"># it. Construct all strings as unicode objects, and convert to utf-8 at</span>
    <span class="c1"># the end.</span>
    <span class="n">mods</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span>

    <span class="n">header_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;Provider: Emory University Libraries&#39;</span><span class="p">)</span>
    <span class="n">header_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;Database: OpenEmory&#39;</span><span class="p">)</span>
    <span class="n">header_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;Content: text/plain; charset=&quot;utf-8&quot;&#39;</span><span class="p">)</span>

    <span class="n">reference_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Article&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - JOUR&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Book&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - BOOK&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Chapter&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - CHAP&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Conference&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - CONF&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Poster&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - POST&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Report&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - REPO&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s2">&quot;Presentation&quot;</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - PRES&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TY  - JOUR&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;TI  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;T2  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;AU  - </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span> <span class="n">author</span><span class="o">.</span><span class="n">given_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;PB  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_place</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;PP  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_place</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;JO  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;PB  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;VL  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;IS  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;SP  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;EP  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;PY  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;DA  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">edition</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;ED  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">edition</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">presentation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">presentation</span><span class="o">.</span><span class="n">presentation_place</span><span class="p">:</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;PL  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">presentation</span><span class="o">.</span><span class="n">presentation_place</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_mods_kw_as_ris_value</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># it&#39;s possible this could be empty (separate bug?)</span>
            <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;KW  - &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span> <span class="ow">and</span> <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;DO  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
        <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;LA  - &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
    <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;UR  - &#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()))</span>
    <span class="n">reference_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;ER  - &#39;</span><span class="p">)</span>

    <span class="n">header_data</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">u&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header_lines</span><span class="p">)</span>
    <span class="n">reference_data</span> <span class="o">=</span> <span class="s1">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">u&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reference_lines</span><span class="p">)</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="s1">u&#39;</span><span class="si">%s</span><span class="se">\r\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">header_data</span><span class="p">,</span> <span class="n">reference_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">response_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/x-research-info-systems&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_mods_kw_as_ris_value</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Serialize a :class:`~openemory.publication.mods.Keyword` for</span>
<span class="sd">    inclusion in an RIS file (e.g., in :func:`_article_as_ris`).&#39;&#39;&#39;</span>
    <span class="c1"># FIXME: does this really belong here?</span>
    <span class="c1"># TODO: generalize as a utility method on local mods.keyword</span>

    <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">geographic</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kw</span><span class="o">.</span><span class="n">geographic</span>
    <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">topic</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kw</span><span class="o">.</span><span class="n">topic</span>
    <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kw</span><span class="o">.</span><span class="n">title</span>
    <span class="k">if</span> <span class="n">kw</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<div class="viewcode-block" id="site_index"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.site_index">[docs]</a><span class="k">def</span> <span class="nf">site_index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Site index page, including 10 most viewed and 10 recently</span>
<span class="sd">    published articles.&#39;&#39;&#39;</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
    <span class="c1"># FIXME: this is very similar logic to summary view</span>
    <span class="c1"># (should be consolidated)</span>
    <span class="c1"># common query options for both searches</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_model</span><span class="o">=</span><span class="n">Publication</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> \
                            <span class="o">.</span><span class="n">field_limit</span><span class="p">(</span><span class="n">PUBLICATION_VIEW_FIELDS</span><span class="p">)</span>

    <span class="c1"># find def viewed content</span>
    <span class="c1"># - get distinct list of pids (no matter what year), and aggregate views</span>
    <span class="c1"># - make sure article has at least 1 download to be listed</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">ArticleStatistics</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;pid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span> \
               <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">all_views</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;num_views&#39;</span><span class="p">),</span> <span class="n">all_downloads</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;num_downloads&#39;</span><span class="p">))</span> \
               <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">all_views__gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> \
               <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-all_views&#39;</span><span class="p">)</span> \
               <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;all_views&#39;</span><span class="p">,</span> <span class="s1">&#39;all_downloads&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="c1"># list of pids in most-viewed order</span>
    <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pids</span><span class="p">:</span>
        <span class="c1"># build a Solr OR query to retrieve browse details on most viewed records</span>
        <span class="n">pid_filter</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">Q</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
            <span class="n">pid_filter</span> <span class="o">|=</span> <span class="n">solr</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">most_viewed</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pid_filter</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="c1"># re-sort the solr results according to stats order</span>
        <span class="n">most_viewed</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">most_viewed</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">pids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]),</span>
                                                              <span class="n">pids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">most_viewed</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># find ten most recently modified articles that are published on the site</span>
    <span class="c1"># FIXME: this logic is not quite right</span>
    <span class="c1"># (does not account for review/edit after initial publication)</span>
    <span class="n">recent</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="s1">&#39;-last_modified&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="c1"># patch download &amp; view counts into solr results</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
            <span class="n">pidstats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">pids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pid</span><span class="p">)]</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidstats</span><span class="p">[</span><span class="s1">&#39;all_views&#39;</span><span class="p">]</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;downloads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidstats</span><span class="p">[</span><span class="s1">&#39;all_downloads&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;downloads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># patch download &amp; view counts into solr result</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">most_viewed</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span>
        <span class="n">pidstats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">pids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pid</span><span class="p">)]</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidstats</span><span class="p">[</span><span class="s1">&#39;all_views&#39;</span><span class="p">]</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;downloads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidstats</span><span class="p">[</span><span class="s1">&#39;all_downloads&#39;</span><span class="p">]</span>

    <span class="c1">#Featured Article</span>
    <span class="n">featured_article_pids</span> <span class="o">=</span> <span class="n">FeaturedArticle</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="c1"># random sort</span>
    <span class="k">if</span> <span class="n">featured_article_pids</span><span class="p">:</span>
        <span class="n">featured_article_pid</span> <span class="o">=</span> <span class="n">featured_article_pids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>

        <span class="c1"># Get the featured article from Solr</span>
        <span class="n">featured_article</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">featured_article_pid</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span>\
        <span class="n">field_limit</span><span class="p">([</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">featured_article</span><span class="p">:</span>
            <span class="c1"># Get the first item in the returned Solr array</span>
            <span class="n">featured_article</span> <span class="o">=</span> <span class="n">featured_article</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no articles are returned from Solr</span>
            <span class="n">featured_article</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">featured_article</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/site_index.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;recent_uploads&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">,</span> <span class="s1">&#39;most_viewed&#39;</span><span class="p">:</span> <span class="n">most_viewed</span><span class="p">,</span> <span class="s1">&#39;featured&#39;</span><span class="p">:</span> <span class="n">featured_article</span><span class="p">})</span></div>

<div class="viewcode-block" id="summary"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.summary">[docs]</a><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Publication summary page with a list of most downloaded and</span>
<span class="sd">    most recent content.&#39;&#39;&#39;</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
    <span class="c1"># common query options for both searches</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_model</span><span class="o">=</span><span class="n">Publication</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">,</span>
                            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> \
                            <span class="o">.</span><span class="n">field_limit</span><span class="p">(</span><span class="n">PUBLICATION_VIEW_FIELDS</span><span class="p">)</span>

    <span class="c1"># find ten most recently modified articles that are published on the site</span>
    <span class="c1"># FIXME: this logic is not quite right</span>
    <span class="c1"># (does not account for review/edit after initial publication)</span>
    <span class="n">recent</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="s1">&#39;-last_modified&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="c1"># find most downloaded content</span>
    <span class="c1"># - get distinct list of pids (no matter what year), and aggregate downloads</span>
    <span class="c1"># - make sure article has at least 1 download to be listed</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">ArticleStatistics</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;pid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span> \
               <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">all_downloads</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;num_downloads&#39;</span><span class="p">))</span> \
               <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">all_downloads__gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> \
               <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-all_downloads&#39;</span><span class="p">)</span> \
               <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;all_downloads&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>

    <span class="c1"># FIXME: we should probably explicitly exclude embargoed documents</span>
    <span class="c1"># from a &quot;top downloads&quot; list...</span>

    <span class="c1"># if we don&#39;t have any stats in the system yet, just return an empty list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">most_dl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># otherwise, use stats results to get article info from solr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># list of pids in most-viewed order</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
        <span class="c1"># build a Solr OR query to retrieve browse details on most viewed records</span>
        <span class="n">pid_filter</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">Q</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
            <span class="n">pid_filter</span> <span class="o">|=</span> <span class="n">solr</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">most_dl</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pid_filter</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="c1"># re-sort the solr results according to stats order</span>
        <span class="n">most_dl</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">most_dl</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">pids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]),</span>
                                                              <span class="n">pids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/summary.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;most_downloaded&#39;</span><span class="p">:</span> <span class="n">most_dl</span><span class="p">,</span> <span class="s1">&#39;newest&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">})</span></div>


<div class="viewcode-block" id="departments"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.departments">[docs]</a><span class="k">def</span> <span class="nf">departments</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;List department names based on article information in solr,</span>
<span class="sd">    grouped by division name.&#39;&#39;&#39;</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">content_model</span><span class="o">=</span><span class="n">Publication</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">facet_by</span><span class="p">(</span><span class="s1">&#39;division_dept_id&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">div_depts</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">facet_counts</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">[</span><span class="s1">&#39;division_dept_id&#39;</span><span class="p">]</span>

    <span class="n">depts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">total</span> <span class="ow">in</span> <span class="n">div_depts</span><span class="p">:</span>
        <span class="n">dept</span> <span class="o">=</span> <span class="n">Publication</span><span class="o">.</span><span class="n">split_department</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">dept</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
        <span class="n">depts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dept</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/departments.html&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;departments&#39;</span><span class="p">:</span> <span class="n">depts</span><span class="p">})</span></div>


<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">BasicSearchForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
    <span class="n">search_within</span> <span class="o">=</span> <span class="n">SearchWithinForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>

    <span class="c1"># restrict to active (published) articles only</span>
    <span class="n">cm_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">}</span>

    <span class="n">item_terms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">people_terms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span>
            <span class="n">item_terms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">search_terms</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span>
            <span class="n">people_terms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">search_terms</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span>


    <span class="c1">#add additional filtering keyword terms from within search</span>
    <span class="n">within_filter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">search_within</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">search_within</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;within_keyword&#39;</span><span class="p">]:</span>
            <span class="n">within_keyword</span> <span class="o">=</span> <span class="n">search_within</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;within_keyword&#39;</span><span class="p">]</span>
            <span class="n">past_within_keyword</span> <span class="o">=</span> <span class="n">search_within</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;past_within_keyword&#39;</span><span class="p">]</span>
            <span class="n">past_within_keyword</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">past_within_keyword</span><span class="p">,</span> <span class="n">within_keyword</span><span class="p">)</span> <span class="c1"># combine the filters together</span>
            <span class="n">past_within_keyword</span> <span class="o">=</span> <span class="n">past_within_keyword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">search_within</span> <span class="o">=</span> <span class="n">SearchWithinForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="n">keyword</span><span class="p">,</span> <span class="s1">&#39;past_within_keyword&#39;</span> <span class="p">:</span><span class="n">past_within_keyword</span><span class="p">})</span>
            <span class="n">within_filter</span> <span class="o">=</span> <span class="n">search_terms</span><span class="p">(</span><span class="n">past_within_keyword</span><span class="p">)</span> <span class="c1"># now has the new terms added</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">cm_filter</span><span class="p">)</span>
    <span class="n">people_q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">record_type</span><span class="o">=</span><span class="s1">&#39;accounts_esdperson&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item_terms</span><span class="p">:</span>
        <span class="n">name_info</span> <span class="o">=</span> <span class="n">_parse_name</span><span class="p">(</span><span class="n">item_terms</span><span class="p">)</span>
        <span class="c1"># if it looks like a name search search only for that person in author name list</span>
        <span class="k">if</span> <span class="n">name_info</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;last_first&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">item_terms</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">cm_filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">within_filter</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">within_filter</span><span class="p">)</span>
        <span class="n">item_terms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">within_filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">people_terms</span><span class="p">:</span>
        <span class="c1"># if it looks like a name search search only for that person in dir name</span>
        <span class="c1"># fall back to searching first and last name fields</span>
        <span class="k">if</span> <span class="n">name_info</span><span class="p">:</span>
            <span class="n">people_q</span> <span class="o">=</span> <span class="n">people_q</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">directory_name</span><span class="o">=</span><span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">people_q</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">people_q</span> <span class="o">=</span> <span class="n">people_q</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">],</span> <span class="n">last_name</span><span class="o">=</span><span class="n">name_info</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">people_q</span> <span class="o">=</span> <span class="n">people_q</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">name_text</span><span class="o">=</span><span class="n">people_terms</span><span class="p">)</span>

    <span class="c1"># url opts for pagination &amp; basis for removing active filters</span>
    <span class="n">urlopts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># filter/facet  (display name =&gt; solr field)</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;pubyear&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Author&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;creator_facet&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Subject&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;researchfield_facet&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;journal&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Journal&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;journal_title_facet&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Keyword&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;keyword&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;affiliation&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Author affiliation&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;affiliations_facet&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="s1">&#39;department&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="s1">&#39;Author department&#39;</span><span class="p">,</span> <span class="s1">&#39;solr&#39;</span><span class="p">:</span> <span class="s1">&#39;department_shortname_facet&#39;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">display_filters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">active_filters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">)</span>
    <span class="c1"># filter the solr search based on any facets in the request</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
        <span class="c1"># For multi-valued fields (author, subject), we could have multiple</span>
        <span class="c1"># filters on the same field; treat all facet fields as lists.</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">]):</span>
            <span class="c1"># filter the current solr query</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;solr&#39;</span><span class="p">]:</span> <span class="n">val</span><span class="p">})</span>
            <span class="n">people_q</span> <span class="o">=</span> <span class="n">people_q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;solr&#39;</span><span class="p">]:</span> <span class="n">val</span><span class="p">})</span>

            <span class="c1"># add to list of active filters</span>
            <span class="n">active_filters</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="c1"># also add to list for user display &amp; removal</span>
            <span class="c1"># - copy the urlopts and remove the current value</span>
            <span class="n">unfacet_urlopts</span> <span class="o">=</span> <span class="n">urlopts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="n">unfacet_urlopts</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">])</span>
            <span class="n">val_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">unfacet_urlopts</span><span class="o">.</span><span class="n">setlist</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">],</span> <span class="n">val_list</span><span class="p">)</span>
            <span class="c1"># - tuple of display value and url to remove this filter</span>
            <span class="n">display_filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">,</span> <span class="n">unfacet_urlopts</span><span class="o">.</span><span class="n">urlencode</span><span class="p">()))</span>

    <span class="c1"># Update solr query to return values &amp; counts for configured facet fields</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">facet_by</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;solr&#39;</span><span class="p">],</span> <span class="n">mincount</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># NOTE: may also want to specify a limit; possibly also higher mincount</span>

    <span class="c1"># facets currently are not available through paginated result object;</span>
    <span class="c1">#  - to get them, run the query without returning any rows</span>
    <span class="n">facet_result</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">facet_fields</span> <span class="o">=</span> <span class="n">facet_result</span><span class="o">.</span><span class="n">facet_counts</span><span class="o">.</span><span class="n">facet_fields</span>

    <span class="c1"># add highlighting &amp; relevance ranking</span>
    <span class="n">highlight_fields</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;fulltext&#39;</span><span class="p">,</span> <span class="s1">&#39;keyword&#39;</span><span class="p">,</span> <span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">highlight_fields</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="s1">&#39;-score&#39;</span><span class="p">)</span>
    <span class="c1"># for the paginated version, limit to display fields + score</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">show_pages</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                   <span class="n">q</span><span class="o">.</span><span class="n">field_limit</span><span class="p">(</span><span class="n">PUBLICATION_VIEW_FIELDS</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

    <span class="n">facets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">facets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># convert facets for display to user;</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;solr&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">facet_fields</span> <span class="ow">and</span> <span class="n">facet_fields</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;solr&#39;</span><span class="p">]]:</span>
            <span class="n">show_facets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># skip any display facet values that are already in effect</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">facet_fields</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;solr&#39;</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">active_filters</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">]]:</span>
                    <span class="n">show_facets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show_facets</span><span class="p">:</span>
                <span class="n">facet</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;queryarg&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;queryarg&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">show_facets</span>
                <span class="p">}</span>
                <span class="n">facets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">facet</span><span class="p">)</span>

    <span class="n">people</span> <span class="o">=</span> <span class="n">people_q</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/search-results.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="n">people</span><span class="p">,</span>
            <span class="s1">&#39;search_terms&#39;</span><span class="p">:</span> <span class="n">item_terms</span><span class="p">,</span>
            <span class="s1">&#39;show_pages&#39;</span><span class="p">:</span> <span class="n">show_pages</span><span class="p">,</span>
            <span class="c1">#used to compare against the embargo_end date</span>
            <span class="s1">&#39;now&#39;</span> <span class="p">:</span>  <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="s1">&#39;url_params&#39;</span><span class="p">:</span> <span class="n">urlopts</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(),</span>
            <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="n">facets</span><span class="p">,</span>
            <span class="s1">&#39;active_filters&#39;</span><span class="p">:</span> <span class="n">display_filters</span><span class="p">,</span>
            <span class="s1">&#39;search_within&#39;</span><span class="p">:</span> <span class="n">search_within</span><span class="p">,</span>
        <span class="p">})</span>


<div class="viewcode-block" id="browse_field"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.browse_field">[docs]</a><span class="k">def</span> <span class="nf">browse_field</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Browse a list of values for a specific field, e.g. authors,</span>
<span class="sd">    subjects, or journal titles.  Displays a list of values for the</span>
<span class="sd">    specified field with a count for the number of articles associated</span>
<span class="sd">    with the particular author, subject, or journal, and a link to a</span>
<span class="sd">    search for articles with the specified field and value.</span>

<span class="sd">    :param field: Expected to be one of **authors**, **subjects**, or</span>
<span class="sd">      **journals**</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
    <span class="n">field_to_facet</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;authors&#39;</span><span class="p">:</span>      <span class="s1">&#39;creator_sorting&#39;</span><span class="p">,</span>
        <span class="s1">&#39;subjects&#39;</span><span class="p">:</span>     <span class="s1">&#39;researchfield_sorting&#39;</span><span class="p">,</span>
        <span class="s1">&#39;journals&#39;</span><span class="p">:</span>     <span class="s1">&#39;journal_title_sorting&#39;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_to_facet</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">Http404</span>
    <span class="n">facet</span> <span class="o">=</span> <span class="n">field_to_facet</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
    <span class="c1"># mode used for page display and generating search link</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

    <span class="c1">#prefix for alpha sorted browse by</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">facet_by</span><span class="p">(</span><span class="n">facet</span><span class="p">,</span> <span class="n">mincount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="nb">filter</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">facets</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">facet_counts</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">[</span><span class="n">facet</span><span class="p">]</span>

    <span class="c1">#removes name from field for proper presentation</span>
    <span class="n">facets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;publication/browse.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span>
        <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="n">facets</span><span class="p">,</span>
        <span class="p">})</span></div>

<span class="n">SOLR_SUGGEST_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;author_affiliation&#39;</span><span class="p">,</span> <span class="s1">&#39;funder&#39;</span><span class="p">,</span> <span class="s1">&#39;keyword&#39;</span><span class="p">]</span>
<span class="n">SUGGEST_FUNCTIONS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># filled in below</span>

<span class="k">def</span> <span class="nf">suggest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">SOLR_SUGGEST_FIELDS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">suggest_from_solr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">SUGGEST_FUNCTIONS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SUGGEST_FUNCTIONS</span><span class="p">[</span><span class="n">field</span><span class="p">](</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

<div class="viewcode-block" id="suggest_from_solr"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.suggest_from_solr">[docs]</a><span class="k">def</span> <span class="nf">suggest_from_solr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Suggest terms based on a specified field and term prefix, using</span>
<span class="sd">    Solr facets.  Returns a JSON response with the 15 most common</span>
<span class="sd">    matching terms in the requested field with the specified prefix.</span>

<span class="sd">    .. Note::</span>

<span class="sd">        Due to the current implementation and the limitations of facet</span>
<span class="sd">        querying in Solr, the search term is case-sensitive and only</span>
<span class="sd">        matches at the beginning of the string.</span>

<span class="sd">    Return format is suitable for use with `JQuery UI Autocomplete`_</span>
<span class="sd">    widget.</span>

<span class="sd">    .. _JQuery UI Autocomplete: http://jqueryui.com/demos/autocomplete/</span>

<span class="sd">    :param request: the http request passed to the original view</span>
<span class="sd">        method (used to retrieve the search term)</span>

<span class="sd">    :param field: the name of the field to query in Solr (without the</span>
<span class="sd">        *_facet* portion).  Currently supported fields:</span>
<span class="sd">        **author_affiliation**, **funder**, **journal_publisher**,</span>
<span class="sd">        **keyword**</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">term</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
    <span class="c1"># generate solr facet field name</span>
    <span class="n">facet_field</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_facet&#39;</span> <span class="o">%</span> <span class="n">field</span>
    <span class="c1"># query all documents but don&#39;t actually return any of them</span>
    <span class="n">facetq</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># return the 15 most common terms in the requested facet field</span>
    <span class="c1"># with a specified prefix</span>
    <span class="n">facetq</span> <span class="o">=</span> <span class="n">facetq</span><span class="o">.</span><span class="n">facet_by</span><span class="p">(</span><span class="n">facet_field</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">term</span><span class="p">,</span>
                                       <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
                                       <span class="n">limit</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">facets</span> <span class="o">=</span> <span class="n">facetq</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">facet_counts</span><span class="o">.</span><span class="n">facet_fields</span>

    <span class="c1"># generate a dictionary to return via json with label (facet value</span>
    <span class="c1"># + count), and actual value to use</span>
    <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">facet</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">facet</span><span class="p">}</span>
                   <span class="k">for</span> <span class="n">facet</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">[</span><span class="n">facet_field</span><span class="p">]</span>
                   <span class="p">]</span>
    <span class="k">return</span>  <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json_serializer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">suggestions</span><span class="p">),</span>
                         <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">journal_suggestion_data</span><span class="p">(</span><span class="n">journal</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">journal</span><span class="o">.</span><span class="n">publisher_romeo</span> <span class="ow">or</span>
                            <span class="s1">&#39;unknown publisher&#39;</span><span class="p">),</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s1">&#39;issn&#39;</span><span class="p">:</span> <span class="n">journal</span><span class="o">.</span><span class="n">issn</span><span class="p">,</span>
        <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="n">journal</span><span class="o">.</span><span class="n">publisher_romeo</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">suggest_journal_title</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">journals</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_journal_title</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;starts&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">term</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="n">journal_suggestion_data</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span> <span class="k">for</span> <span class="n">journal</span> <span class="ow">in</span> <span class="n">journals</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json_serializer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">suggestions</span><span class="p">),</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
<span class="n">SUGGEST_FUNCTIONS</span><span class="p">[</span><span class="s1">&#39;journal_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suggest_journal_title</span>

<span class="k">def</span> <span class="nf">publisher_suggestion_data</span><span class="p">(</span><span class="n">publisher</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">publisher</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
                 <span class="k">if</span> <span class="n">publisher</span><span class="o">.</span><span class="n">alias</span> <span class="k">else</span>
                 <span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;romeo_id&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;preprint&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;archiving&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">preprint_archiving</span><span class="p">,</span>
                <span class="s1">&#39;restrictions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">publisher</span><span class="o">.</span><span class="n">preprint_restrictions</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="s1">&#39;postprint&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;archiving&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">postprint_archiving</span><span class="p">,</span>
                <span class="s1">&#39;restrictions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">publisher</span><span class="o">.</span><span class="n">postprint_restrictions</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="s1">&#39;pdf&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;archiving&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">pdf_archiving</span><span class="p">,</span>
                <span class="s1">&#39;restrictions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">publisher</span><span class="o">.</span><span class="n">pdf_restrictions</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">suggest_journal_publisher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">publishers</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_publisher_name</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="n">publisher_suggestion_data</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span> <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json_serializer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">suggestions</span><span class="p">),</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
<span class="n">SUGGEST_FUNCTIONS</span><span class="p">[</span><span class="s1">&#39;journal_publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suggest_journal_publisher</span>

<span class="k">def</span> <span class="nf">publisher_details</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s1">&#39;romeo_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
        <span class="n">publisher</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_publisher_id</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;romeo_id&#39;</span><span class="p">],</span>
                <span class="n">versions</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
        <span class="n">publishers</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_publisher_name</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">publishers</span><span class="p">:</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">publishers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">publisher</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">publisher_suggestion_data</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json_serializer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>

<span class="nd">@permission_required</span><span class="p">(</span><span class="s1">&#39;publication.review_article&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="review_queue"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.review_queue">[docs]</a><span class="k">def</span> <span class="nf">review_queue</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;List published but unreviewed articles so admins can review</span>
<span class="sd">    metadata.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">review_date__any</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="c1"># restrict to active (published) articles only</span>
    <span class="c1"># q = solr.query().exclude(review_date__any=False)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">show_pages</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="c1"># for article in results.object_list:</span>
    <span class="c1">#     print article.genre</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;publication/review-queue.html&#39;</span>
    <span class="c1"># for ajax requests, only display the inner content</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;publication/snippets/review-queue.html&#39;</span>


    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span> <span class="s1">&#39;show_pages&#39;</span><span class="p">:</span> <span class="n">show_pages</span><span class="p">,</span>
        <span class="p">})</span></div>

<div class="viewcode-block" id="open_access_fund"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.views.open_access_fund">[docs]</a><span class="k">def</span> <span class="nf">open_access_fund</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A form for submitting an OA Fund Proposal</span>
<span class="sd">    &#39;&#39;&#39;</span>
    

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;http://sco.library.emory.edu/open-access-publishing/oa-funding-support/oa-form.html&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenEmory 2.2.8-dev documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2011, Emory University Libraries.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>