<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openemory.publication.models &mdash; OpenEmory 2.2.8-dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.2.8-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="OpenEmory 2.2.8-dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenEmory 2.2.8-dev documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for openemory.publication.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># file openemory/publication/models.py</span>
<span class="c1">#</span>
<span class="c1">#   Copyright 2010 Emory University General Library</span>
<span class="c1">#</span>
<span class="c1">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#   you may not use this file except in compliance with the License.</span>
<span class="c1">#   You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#       http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#   See the License for the specific language governing permissions and</span>
<span class="c1">#   limitations under the License.</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">eulfedora.server</span> <span class="kn">import</span> <span class="n">Repository</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">django.template.defaultfilters</span> <span class="kn">import</span> <span class="n">slugify</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">get_template</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">eulfedora.models</span> <span class="kn">import</span> <span class="n">FileDatastream</span><span class="p">,</span> \
     <span class="n">XmlDatastream</span><span class="p">,</span> <span class="n">Relation</span>
<span class="kn">from</span> <span class="nn">eulfedora.util</span> <span class="kn">import</span> <span class="n">RequestFailed</span><span class="p">,</span> <span class="n">parse_rdf</span>
<span class="kn">from</span> <span class="nn">eulfedora.indexdata.util</span> <span class="kn">import</span> <span class="n">pdf_to_text</span>
<span class="kn">from</span> <span class="nn">openemory.publication.symp_import</span> <span class="kn">import</span> <span class="n">OESympImportPublication</span><span class="p">,</span> \
    <span class="n">SympDate</span><span class="p">,</span> <span class="n">SympPerson</span><span class="p">,</span> <span class="n">SympRelation</span><span class="p">,</span> <span class="n">SympWarning</span>
<span class="kn">from</span> <span class="nn">openemory.util</span> <span class="kn">import</span> <span class="n">pdf_to_text</span>
<span class="kn">from</span> <span class="nn">eulfedora.rdfns</span> <span class="kn">import</span> <span class="n">relsext</span><span class="p">,</span> <span class="n">oai</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">eulfedora.rdfns</span> <span class="kn">import</span> <span class="n">model</span> <span class="k">as</span> <span class="n">relsextns</span>
<span class="kn">from</span> <span class="nn">django_auth_ldap.backend</span> <span class="kn">import</span> <span class="n">LDAPBackend</span> <span class="k">as</span> <span class="n">EmoryLDAPBackend</span>
<span class="kn">from</span> <span class="nn">eulxml</span> <span class="kn">import</span> <span class="n">xmlmap</span>
<span class="kn">from</span> <span class="nn">eulxml.xmlmap</span> <span class="kn">import</span> <span class="n">mods</span><span class="p">,</span> <span class="n">premis</span><span class="p">,</span> <span class="n">fields</span> <span class="k">as</span> <span class="n">xmlfields</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="kn">import</span> <span class="n">PdfFileReader</span><span class="p">,</span> <span class="n">PdfFileWriter</span>
<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">URIRef</span><span class="p">,</span> <span class="n">RDF</span><span class="p">,</span> <span class="n">RDFS</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">rdflib.graph</span> <span class="kn">import</span> <span class="n">Graph</span> <span class="k">as</span> <span class="n">RdfGraph</span>
<span class="kn">from</span> <span class="nn">rdflib.namespace</span> <span class="kn">import</span> <span class="n">ClosedNamespace</span><span class="p">,</span> <span class="n">Namespace</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">xhtml2pdf</span> <span class="kn">import</span> <span class="n">pisa</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">openemory</span>
<span class="kn">from</span> <span class="nn">django.utils.crypto</span> <span class="kn">import</span> <span class="n">get_random_string</span>
<span class="kn">from</span> <span class="nn">openemory.common.fedora</span> <span class="kn">import</span> <span class="n">DigitalObject</span><span class="p">,</span> <span class="n">ManagementRepository</span><span class="p">,</span> \
    <span class="n">absolutize_url</span>
<span class="kn">from</span> <span class="nn">openemory.rdfns</span> <span class="kn">import</span> <span class="n">DC</span><span class="p">,</span> <span class="n">BIBO</span><span class="p">,</span> <span class="n">FRBR</span><span class="p">,</span> <span class="n">ns_prefixes</span>
<span class="kn">from</span> <span class="nn">openemory.util</span> <span class="kn">import</span> <span class="n">pmc_access_url</span>
<span class="kn">from</span> <span class="nn">openemory.util</span> <span class="kn">import</span> <span class="n">solr_interface</span>
<span class="kn">from</span> <span class="nn">openemory.publication.symp</span> <span class="kn">import</span> <span class="n">SympAtom</span>
<span class="kn">from</span> <span class="nn">openemory.publication.symp_import</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">openemory.common</span> <span class="kn">import</span> <span class="n">romeo</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># Define Special options for embargo duration</span>
<span class="n">NO_LIMIT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;Indefinite&quot;</span><span class="p">,</span> <span class="s2">&quot;display&quot;</span><span class="p">:</span><span class="s2">&quot;Indefinite&quot;</span><span class="p">}</span>
<span class="n">UNKNOWN_LIMIT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;Not Known&quot;</span><span class="p">,</span> <span class="s2">&quot;display&quot;</span><span class="p">:</span><span class="s2">&quot;Unknown&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">journal_suggestion_data</span><span class="p">(</span><span class="n">journal</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">journal</span><span class="o">.</span><span class="n">publisher_romeo</span> <span class="ow">or</span>
                            <span class="s1">&#39;unknown publisher&#39;</span><span class="p">),</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="s1">&#39;issn&#39;</span><span class="p">:</span> <span class="n">journal</span><span class="o">.</span><span class="n">issn</span><span class="p">,</span>
        <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="n">journal</span><span class="o">.</span><span class="n">publisher_romeo</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">publisher_suggestion_data</span><span class="p">(</span><span class="n">publisher</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">publisher</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
                 <span class="k">if</span> <span class="n">publisher</span><span class="o">.</span><span class="n">alias</span> <span class="k">else</span>
                 <span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;romeo_id&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s1">&#39;preprint&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;archiving&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">preprint_archiving</span><span class="p">,</span>
                <span class="s1">&#39;restrictions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">publisher</span><span class="o">.</span><span class="n">preprint_restrictions</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="s1">&#39;postprint&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;archiving&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">postprint_archiving</span><span class="p">,</span>
                <span class="s1">&#39;restrictions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">publisher</span><span class="o">.</span><span class="n">postprint_restrictions</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="s1">&#39;pdf&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;archiving&#39;</span><span class="p">:</span> <span class="n">publisher</span><span class="o">.</span><span class="n">pdf_archiving</span><span class="p">,</span>
                <span class="s1">&#39;restrictions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">publisher</span><span class="o">.</span><span class="n">pdf_restrictions</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">TypedRelatedItem</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">RelatedItem</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if all fields are empty, and no attributes</span>
<span class="sd">        other than **type** or **displayLabel**. False if any fields</span>
<span class="sd">        are not empty.&quot;&quot;&quot;</span>

        <span class="c1"># ignore these fields when checking if a related item is empty</span>
        <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">]</span>  <span class="c1"># type and displayLabel attributes</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="c1"># if this is an XmlObject or NodeListField with an</span>
            <span class="c1"># is_empty method, rely on that</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;is_empty&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="c1"># if this is a list or value field (int, string), check if empty</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">==</span> <span class="p">[]):</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># no non-empty non-ignored fields were found - return True</span>
        <span class="k">return</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">JournalMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:titleInfo/mods:title&#39;</span><span class="p">)</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:publisher&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">issn</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;issn&quot;]&#39;</span><span class="p">)</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;volume&quot;]&#39;</span><span class="p">,</span>
                              <span class="n">mods</span><span class="o">.</span><span class="n">PartDetail</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;number&quot;]&#39;</span><span class="p">,</span>
                              <span class="n">mods</span><span class="o">.</span><span class="n">PartDetail</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:extent[@unit=&quot;pages&quot;]&#39;</span><span class="p">,</span> <span class="n">mods</span><span class="o">.</span><span class="n">PartExtent</span><span class="p">,</span>
                             <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ConferenceMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">conference_start</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:dateOther[@type=&quot;start date&quot;]&#39;</span><span class="p">)</span>
    <span class="n">conference_end</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:dateOther[@type=&quot;end date&quot;]&#39;</span><span class="p">)</span>
    <span class="n">conference_name</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:name[@type=&quot;conference&quot;]/mods:namePart&#39;</span><span class="p">)</span>
    <span class="n">conference_place</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:place/mods:placeTerm[@type=&quot;text&quot;]&#39;</span><span class="p">)</span>
    <span class="n">acceptance_date</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:dateOther[@type=&quot;acceptance date&quot;]&#39;</span><span class="p">)</span>
    <span class="n">issue</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;issue&quot;]/mods:number&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">issn</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;issn&quot;]&#39;</span><span class="p">)</span>
    <span class="n">proceedings_title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:titleInfo/mods:title&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;volume&quot;]&#39;</span><span class="p">,</span>
                              <span class="n">mods</span><span class="o">.</span><span class="n">PartDetail</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:extent[@unit=&quot;pages&quot;]&#39;</span><span class="p">,</span> <span class="n">mods</span><span class="o">.</span><span class="n">PartExtent</span><span class="p">,</span>
                             <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;number&quot;]&#39;</span><span class="p">,</span>
                              <span class="n">mods</span><span class="o">.</span><span class="n">PartDetail</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">BookMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">book_title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:titleInfo/mods:title&#39;</span><span class="p">)</span>
    <span class="c1">#determine where to put this mod</span>
    <span class="n">series</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;series&quot;]/mods:number&#39;</span><span class="p">)</span>
    <span class="n">edition</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:edition&#39;</span><span class="p">)</span>
    <span class="n">isbn13</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;isbn-13&quot;]&#39;</span><span class="p">)</span>
    <span class="n">isbn10</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;isbn-10&quot;]&#39;</span><span class="p">)</span>
    <span class="n">chapters</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:extent[@unit=&quot;chapters&quot;]/mods:total&#39;</span><span class="p">,</span> <span class="n">mods</span><span class="o">.</span><span class="n">PartExtent</span><span class="p">,</span>
                             <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChapterMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:extent[@unit=&quot;pages&quot;]&#39;</span><span class="p">,</span> <span class="n">mods</span><span class="o">.</span><span class="n">PartExtent</span><span class="p">,</span>
                             <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># chapter_num = xmlmap.NodeField(&#39;mods:part/mods:extent[@unit=&quot;chapters&quot;]/mods:number&#39;, mods.PartExtent,</span>
    <span class="c1">#                          required=False)</span>


<span class="k">class</span> <span class="nc">PosterMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">conference_name</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:name[@type=&quot;conference&quot;]/mods:namePart&#39;</span><span class="p">)</span>
    <span class="n">presented_date</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:dateOther[@type=&quot;presented date&quot;]&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ReportMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">report_title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:titleInfo/mods:title&#39;</span><span class="p">)</span>
    <span class="n">report_number</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:part/mods:detail[@type=&quot;report&quot;]/mods:number&#39;</span><span class="p">)</span>
    <span class="n">sponsor</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:publisher&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PresentationMods</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">presentation_place</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:place/mods:placeTerm[@type=&quot;text&quot;]&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FundingGroup</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:namePart&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FundingGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># make sure the role and type are set correctly when creating</span>
        <span class="c1"># a new instance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">Role</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;funder&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;corporate&#39;</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns False unless a namePart value is set; type and role</span>
<span class="sd">        are ignored.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_parts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">AuthorName</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
    <span class="n">family_name</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:namePart[@type=&quot;family&quot;]&#39;</span><span class="p">)</span>
    <span class="n">given_name</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:namePart[@type=&quot;given&quot;]&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AuthorName</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># make sure the role and type are set correctly when creating</span>
        <span class="c1"># a new instance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">Role</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;author&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;personal&#39;</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns False unless a namePart value is set; type and role</span>
<span class="sd">        are ignored.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_parts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AuthorNote</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">TypedNote</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AuthorNote</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;author notes&#39;</span>

<span class="k">class</span> <span class="nc">SponsorNote</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">TypedNote</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SponsorNote</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;sponsor notes&#39;</span>

<span class="k">class</span> <span class="nc">AuthorAddress</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">TypedNote</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AuthorAddress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;author address&#39;</span>

<span class="k">class</span> <span class="nc">AuthorURL</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">TypedNote</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AuthorURL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;author url&#39;</span>

<span class="k">class</span> <span class="nc">PublisherURL</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">TypedNote</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PublisherURL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;publisher url&#39;</span>


<span class="k">class</span> <span class="nc">Keyword</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">Subject</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Keyword</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authority</span> <span class="o">=</span> <span class="s1">&#39;keywords&#39;</span>


<span class="k">class</span> <span class="nc">ResearchField</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">Subject</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResearchField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authority</span> <span class="o">=</span> <span class="s1">&#39;proquestresearchfield&#39;</span>



<span class="k">class</span> <span class="nc">FinalVersion</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;uri&quot;][@displayLabel=&quot;URL&quot;]&#39;</span><span class="p">,</span>
                             <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;doi&quot;][@displayLabel=&quot;DOI&quot;]&#39;</span><span class="p">,</span>
                             <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SupplementalMaterial</span><span class="p">(</span><span class="n">TypedRelatedItem</span><span class="p">):</span>
    <span class="n">xlink_ns</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/1999/xlink&#39;</span>
    <span class="n">ROOT_NAMESPACES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mods&#39;</span><span class="p">:</span>  <span class="n">mods</span><span class="o">.</span><span class="n">MODS_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;xlink&#39;</span><span class="p">:</span> <span class="n">xlink_ns</span><span class="p">}</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@xlink:href&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SupplementalMaterial</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">=</span><span class="s1">&#39;references&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;SupplementalMaterial&#39;</span>


<span class="k">class</span> <span class="nc">MODSLicense</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;license&#39;</span>
    <span class="n">xlink_ns</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/1999/xlink&#39;</span>
    <span class="n">ROOT_NAMESPACES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xlink&#39;</span><span class="p">:</span> <span class="n">xlink_ns</span><span class="p">}</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@xlink:href&#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;text()&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_creative_commons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wraper function for :meth:`~_is_creative_commons`</span>
<span class="sd">        indicates if the license is recognized as a</span>
<span class="sd">        Creative Commons license, based on the URL in the license</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">_is_creative_commons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wraper function for :meth:`~_cc_type`</span>
<span class="sd">        short name for the type of Creative Commons license (e.g.,</span>
<span class="sd">    ``by`` or ``by-nd``), if this license is a Creative Commons</span>
<span class="sd">    license.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">_cc_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MODSCopyright</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;copyright&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;text()&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns False unless a text is populated&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">MODSAdminNote</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;adminNote&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;text()&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns False unless a text is populated&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PublicationMods</span><span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">MODSv34</span><span class="p">):</span>

    <span class="c1">################# generic mods ########################</span>

    <span class="n">ark</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;ark&quot;]&#39;</span><span class="p">)</span>
    <span class="s1">&#39;short for of object ARK&#39;</span>
    <span class="n">license</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:accessCondition[@type=&quot;use and reproduction&quot;][@displayLabel=&quot;license&quot;]&#39;</span><span class="p">,</span> <span class="n">MODSLicense</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="s1">&#39;License information&#39;</span>
    <span class="n">copyright</span> <span class="o">=</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:accessCondition[@type=&quot;use and reproduction&quot;][@displayLabel=&quot;copyright&quot;]&#39;</span><span class="p">,</span> <span class="n">MODSCopyright</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="s1">&#39;copyright statement&#39;</span>
    <span class="n">admin_note</span> <span class="o">=</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:accessCondition[@type=&quot;restrictions on access&quot;][@displayLabel=&quot;RightsNote&quot;]&#39;</span><span class="p">,</span> <span class="n">MODSAdminNote</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="s1">&#39;Admin note for record exceptions and non-standard permissions&#39;</span>
    <span class="n">rights_research_date</span> <span class="o">=</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:accessCondition[@type=&quot;restrictions on access&quot;][@displayLabel=&quot;copyrightStatusDeterminationDate&quot;]&#39;</span><span class="p">)</span>
    <span class="s1">&#39;Date rights research was conducted&#39;</span>
    <span class="n">ark_uri</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:identifier[@type=&quot;uri&quot;]&#39;</span><span class="p">)</span>
    <span class="s1">&#39;full ARK of object&#39;</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:name[@type=&quot;personal&quot;][mods:role/mods:roleTerm=&quot;author&quot;]&#39;</span><span class="p">,</span> <span class="n">AuthorName</span><span class="p">)</span>
    <span class="n">funders</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:name[@type=&quot;corporate&quot;][mods:role/mods:roleTerm=&quot;funder&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">FundingGroup</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Funding Group or Granting Agency&#39;</span><span class="p">)</span>
    <span class="s1">&#39;external funding group or granting agency supporting research for the publication&#39;</span>

    <span class="s1">&#39;information about the journal where the publication was published&#39;</span>
    <span class="n">author_notes</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:note[@type=&quot;author notes&quot;]&#39;</span><span class="p">,</span>
                                        <span class="n">AuthorNote</span><span class="p">)</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:publisher&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">author_address</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:note[@type=&quot;author address&quot;]&#39;</span><span class="p">,</span>
                                        <span class="n">AuthorAddress</span><span class="p">)</span>
    <span class="n">author_url</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:note[@type=&quot;author URL&quot;]&#39;</span><span class="p">,</span>
                                        <span class="n">AuthorURL</span><span class="p">)</span>
    <span class="n">publisher_url</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:note[@type=&quot;publisher URL&quot;]&#39;</span><span class="p">,</span>
                                        <span class="n">PublisherURL</span><span class="p">)</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:subject[@authority=&quot;keywords&quot;]&#39;</span><span class="p">,</span>
                                   <span class="n">Keyword</span><span class="p">)</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:subject[@authority=&quot;proquestresearchfield&quot;]&#39;</span><span class="p">,</span>
                                   <span class="n">ResearchField</span><span class="p">)</span>
    <span class="n">relationship</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:name[@type=&quot;personal&quot;]&#39;</span><span class="p">)</span>
    <span class="n">genre</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:genre[@authority=&quot;marcgt&quot;]&#39;</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:genre[@authority=&quot;local&quot;]&#39;</span><span class="p">,</span>
                                 <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Preprint: Prior to Peer Review&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;Post-print: After Peer Review&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;Final Publisher PDF&#39;</span><span class="p">,</span>
                                     <span class="p">],</span>
                                 <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Preprint: Draft, pre-refereeing.  Version of the paper initially</span>
<span class="s1">                                 submitted to a journal publisher.  Post-Print:  Final draft, post-refereeing.</span>
<span class="s1">                                 Version of the paper including changes made in response to peer review.  Final</span>
<span class="s1">                                 Publisher&#39;s Version/PDF:  Version of the paper with copy editing and formatting done</span>
<span class="s1">                                 by the editor or journal publisher.&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="s1">&#39;version of the publication being submitted (e.g., preprint, post-print, etc)&#39;</span>
    <span class="n">publication_date</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:dateIssued[@encoding=&quot;w3cdtf&quot;][@keyDate=&quot;yes&quot;]&#39;</span><span class="p">)</span>
    <span class="n">publication_place</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:place/mods:placeTerm[@type=&quot;text&quot;]&#39;</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">final_version</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;otherVersion&quot;][@displayLabel=&quot;Final Published Version&quot;]&#39;</span><span class="p">,</span>
                                     <span class="n">FinalVersion</span><span class="p">)</span>
    <span class="c1"># convenience mappings for language code &amp; text value</span>
    <span class="n">language_code</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:language/mods:languageTerm[@type=&quot;code&quot;][@authority=&quot;iso639-2b&quot;]&#39;</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:language/mods:languageTerm[@type=&quot;text&quot;]&#39;</span><span class="p">)</span>

    <span class="c1"># embargo information</span>
    <span class="n">_embargo</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:accessCondition[@type=&quot;restrictionOnAccess&quot;]&#39;</span><span class="p">)</span>
    <span class="n">embargo_end</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;mods:originInfo/mods:dateOther[@type=&quot;embargoedUntil&quot;][@encoding=&quot;w3cdtf&quot;]&#39;</span><span class="p">)</span>

    <span class="n">supplemental_materials</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;references&quot;][@displayLabel=&quot;SupplementalMaterial&quot;]&#39;</span><span class="p">,</span> <span class="n">SupplementalMaterial</span><span class="p">)</span>
    <span class="s1">&#39;link to external supplemental material&#39;</span>

    <span class="n">_embargo_prefix</span> <span class="o">=</span> <span class="s1">&#39;Embargoed for &#39;</span>

    <span class="c1">################# end generic mods ########################</span>


    <span class="c1">################# content type specific mods ########################</span>
    <span class="n">journal</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">JournalMods</span><span class="p">)</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">BookMods</span><span class="p">)</span>
    <span class="n">chapter</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">ChapterMods</span><span class="p">)</span>
    <span class="n">conference</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">ConferenceMods</span><span class="p">)</span>
    <span class="n">poster</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">PosterMods</span><span class="p">)</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">ReportMods</span><span class="p">)</span>
    <span class="n">presentation</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;mods:relatedItem[@type=&quot;host&quot;]&#39;</span><span class="p">,</span>
                               <span class="n">PresentationMods</span><span class="p">)</span>
    <span class="c1">################# end content type specific mods ########################</span>

    <span class="k">def</span> <span class="nf">_get_embargo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embargo</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embargo</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_embargo_prefix</span><span class="p">):]</span>
    <span class="k">def</span> <span class="nf">_set_embargo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embargo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if the value is set to &quot;No embargo&quot; do not add _embargo_prefix</span>
            <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="s2">&quot;No embargo&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_embargo</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_embargo</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_embargo_prefix</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_del_embargo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embargo</span>

    <span class="n">embargo</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_embargo</span><span class="p">,</span> <span class="n">_set_embargo</span><span class="p">,</span> <span class="n">_del_embargo</span><span class="p">,</span>
        <span class="sd">&#39;&#39;&#39;Embargo duration.  Stored internally as &quot;Embargoed for xx&quot;</span>
<span class="sd">        in ``mods:accessCondition[@type=&quot;restrictionOnAccess&quot;], but should be accessed</span>
<span class="sd">        and updated via this attribute with just the duration value.&#39;&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_embargo_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate and store an embargo end date in</span>
<span class="sd">        :attr:`embargo_end` based on the embargo duration set in</span>
<span class="sd">        :attr:`embargo`.</span>

<span class="sd">        The embargo is calculated relative to the publication date set</span>
<span class="sd">        in :attr:`publication_date` if set.  If the date is year or</span>
<span class="sd">        year-month only, embargo will be calculated from the first day</span>
<span class="sd">        of the next year or month (e.g., for a publication date of</span>
<span class="sd">        2012, the embargo will be calculated from 2013-01-01.)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo</span><span class="p">:</span>
            <span class="c1"># no embargo duration is set - nothing to calculate</span>
            <span class="c1"># make sure embargo end date is not set</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo_end</span>
            <span class="k">return</span>


        <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embargo</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="n">NO_LIMIT</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embargo_end</span> <span class="o">=</span> <span class="n">NO_LIMIT</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embargo</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="n">UNKNOWN_LIMIT</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">embargo_end</span> <span class="o">=</span> <span class="n">UNKNOWN_LIMIT</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c1"># parse publication date and convert to a datetime.date</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">publication_date</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">date_parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publication_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="c1"># handle year only, year-month, or year-month day</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">adjustment</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># possible adjustment for partial dates</span>
        <span class="c1"># check for month</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># check for day</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">date_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no day specified - use the first day of the next month</span>
                <span class="n">adjustment</span><span class="p">[</span><span class="s1">&#39;months&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">day</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># no month specified - use the first day of the next year</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adjustment</span><span class="p">[</span><span class="s1">&#39;years&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">day</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">relative_to</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="o">**</span><span class="n">adjustment</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="c1"># generate a relativedelta based on embargo duration</span>

          <span class="n">num</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embargo</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

          <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
              <span class="n">unit</span> <span class="o">+=</span> <span class="s1">&#39;s&#39;</span>
          <span class="n">delta_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">unit</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)}</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="o">**</span><span class="n">delta_info</span><span class="p">)</span>

          <span class="n">embargo_end</span> <span class="o">=</span> <span class="n">relative_to</span> <span class="o">+</span> <span class="n">duration</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">embargo_end</span> <span class="o">=</span> <span class="n">embargo_end</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embargo_end</span><span class="p">)</span>


<div class="viewcode-block" id="NlmAuthor"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.NlmAuthor">[docs]</a><span class="k">class</span> <span class="nc">NlmAuthor</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Minimal wrapper for author in NLM XML&#39;&#39;&#39;</span>
    <span class="n">surname</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;name/surname&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;author surname&#39;&#39;&#39;</span>
    <span class="n">given_names</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;name/given-names&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;author given name(s)&#39;&#39;&#39;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;author email, or None if missing&#39;&#39;&#39;</span>
    <span class="n">aff_ids</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;xref[@ref-type=&quot;aff&quot;]/@rid&#39;</span><span class="p">)</span>
    <span class="n">aff</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;aff&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">affiliation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;author institutional affiliation, or None if missing&#39;&#39;&#39;</span>
        <span class="c1"># affiliation tag inside author name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aff</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aff</span>

        <span class="c1"># if affiliation xreference ids are present, look them up</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aff_ids</span><span class="p">:</span>
            <span class="c1"># an author could have multiple affiliations; just put</span>
            <span class="c1"># them all into one text field for now</span>
            <span class="n">aff</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aff_ids</span><span class="p">:</span>
                <span class="c1"># find the affiliation id by the xref and return the</span>
                <span class="c1"># contents</span>
                <span class="c1"># TODO: remove label from text ?</span>
                <span class="n">aff</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;normalize-space(string(ancestor::front//aff[@id=&quot;</span><span class="si">%s</span><span class="s1">&quot;]))&#39;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
                <span class="c1">#print aff</span>
            <span class="k">return</span> <span class="n">aff</span></div>


<span class="k">class</span> <span class="nc">NlmFootnote</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@fn-type&#39;</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@id&#39;</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NlmAuthorNotes</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="n">corresp</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;corresp&#39;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span> <span class="n">NlmFootnote</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">notes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corresp</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corresp</span><span class="p">))</span>
        <span class="n">n</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">unicode</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">n</span>


<div class="viewcode-block" id="NlmPubDate"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.NlmPubDate">[docs]</a><span class="k">class</span> <span class="nc">NlmPubDate</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Publication date in NLM XML&#39;&#39;&#39;</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;pub-date&#39;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@pub-type&#39;</span><span class="p">)</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">)</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span>
    <span class="c1"># could also have a &quot;season&quot; (e.g., Spring, Third Quarter)</span>
    <span class="c1"># year is required but day and month are optional</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">+=</span> <span class="s1">&#39;-</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">+=</span> <span class="s1">&#39;-</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span>
        <span class="k">return</span> <span class="n">date</span></div>



<div class="viewcode-block" id="NlmSection"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.NlmSection">[docs]</a><span class="k">class</span> <span class="nc">NlmSection</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A group of material with a heading; a section of an article&#39;&#39;&#39;</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;sec&#39;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># zero or more</span>
    <span class="c1"># minimal sections mapping for abstracts; can have other fields,</span>
    <span class="c1"># but we don&#39;t expect them in an abstract</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span></div>


<span class="k">class</span> <span class="nc">NlmAbstract</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;abstract&#39;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span> <span class="c1"># zero or one</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="c1"># zero or one</span>
    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># zero or more</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="n">NlmSection</span><span class="p">)</span> <span class="c1"># zero or more</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert abstract to plain-text, preserving sections and</span>
<span class="sd">        headers where possible with line-breaks.&#39;&#39;&#39;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paragraphs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="n">_cc_prefix</span> <span class="o">=</span> <span class="s1">&#39;http://creativecommons.org/licenses/&#39;</span>
<span class="n">_pd_prefix</span> <span class="o">=</span> <span class="s1">&#39;http://creativecommons.org/publicdomain/&#39;</span>

<span class="k">def</span> <span class="nf">_is_creative_commons</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param url: url of the license</span>
<span class="sd">        :type boolean: indicates if the license is recognized as a</span>
<span class="sd">        Creative Commons license, based on the URL in the license</span>
<span class="sd">        xlink:href attribute, if any.</span>

<span class="sd">        .. Note::</span>

<span class="sd">          Currently only recognizes articles that link directly to a</span>
<span class="sd">          Creative Commons license.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">url</span> <span class="ow">and</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_cc_prefix</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_pd_prefix</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_cc_type</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    :param url: url of the license</span>
<span class="sd">    Short name for the type of Creative Commons license (e.g.,</span>
<span class="sd">    ``by`` or ``by-nd``), if this license is a Creative Commons</span>
<span class="sd">    license.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_is_creative_commons</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_cc_prefix</span><span class="p">):</span>
            <span class="n">license_type</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">_cc_prefix</span><span class="p">):]</span>
        <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_pd_prefix</span><span class="p">):</span>
            <span class="n">license_type</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">_pd_prefix</span><span class="p">):]</span>
        <span class="k">return</span> <span class="n">license_type</span><span class="p">[:</span><span class="n">license_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>



<span class="k">class</span> <span class="nc">NlmLicense</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;license&#39;</span>
    <span class="n">xlink_ns</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/1999/xlink&#39;</span>
    <span class="n">ROOT_NAMESPACES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xlink&#39;</span><span class="p">:</span> <span class="n">xlink_ns</span><span class="p">}</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@license-type&#39;</span><span class="p">)</span>
    <span class="s1">&#39;license type (``@license-type``)&#39;</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;@xlink:href|.//@xlink:href&#39;</span><span class="p">)</span>
    <span class="s1">&#39;license link (``@xlink:href`` or the first xlink:href within the license content)&#39;</span>

    <span class="n">_text</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plain text of the license content, including any link urls.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># iterate through node children in serialization order</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
                <span class="c1"># for now, skip comments &amp; processing instructions</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ext-link&#39;</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="c1"># NOTE: of link has text other than the uri,</span>
                        <span class="c1"># uri will not be displayed anywhere in plain-text version</span>
                        <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}href&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlink_ns</span><span class="p">])</span>

                <span class="c1"># any element (including a comment) could have tail content</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                    <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span>  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text</span>

    <span class="n">_html</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;HTML version of the license content, with embedded</span>
<span class="sd">        ``ext-links`` or ``uri`` converted to as HTML links.&#39;&#39;&#39;</span>
        <span class="c1"># NOTE: some overlap in logic with text property</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_html</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># iterate through node children in serialization order</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
                <span class="c1"># for now, skip comments &amp; processing instructions</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="c1"># special handling for links</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ext-link&#39;</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">]:</span>
                        <span class="n">link</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}href&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">xlink_ns</span><span class="p">]</span>
                        <span class="n">link_text</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="n">link</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link_text</span><span class="p">))</span>

                    <span class="k">elif</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

                <span class="c1"># any element (including a comment) could have tail content</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tail</span><span class="p">:</span>
                    <span class="n">html</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_html</span> <span class="o">=</span>  <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_html</span>


    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_creative_commons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wraper function for :meth:`~_is_creative_commons`</span>
<span class="sd">        indicates if the license is recognized as a</span>
<span class="sd">        Creative Commons license, based on the URL in the license</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">_is_creative_commons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wraper function for :meth:`~_cc_type`</span>
<span class="sd">        short name for the type of Creative Commons license (e.g.,</span>
<span class="sd">    ``by`` or ``by-nd``), if this license is a Creative Commons</span>
<span class="sd">    license.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">_cc_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>



<div class="viewcode-block" id="NlmArticle"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.NlmArticle">[docs]</a><span class="k">class</span> <span class="nc">NlmArticle</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Minimal wrapper for NLM XML article&#39;&#39;&#39;</span>
    <span class="n">ROOT_NAME</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span>

    <span class="n">docid</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;article-id[@pub-id-type=&quot;pmc&quot;]&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;PMC document id from :class:`ESearchResponse`; *not* PMID&#39;&#39;&#39;</span>
    <span class="n">pmid</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;article-id[@pub-id-type=&quot;pmid&quot;]&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;PubMed id of the article&#39;&#39;&#39;</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;article-id[@pub-id-type=&quot;doi&quot;]&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;Digital Object Identifier (DOI) for the article&#39;&#39;&#39;</span>
    <span class="n">journal_title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/journal-meta/journal-title|front/journal-meta/journal-title-group/journal-title&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;title of the journal that published the article&#39;&#39;&#39;</span>
    <span class="n">article_title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/title-group/&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;article-title&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;title of the article, not including subtitle&#39;&#39;&#39;</span>
    <span class="n">article_subtitle</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/title-group/&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;subtitle&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;subtitle of the article&#39;&#39;&#39;</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/contrib-group/&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;contrib[@contrib-type=&quot;author&quot;]&#39;</span><span class="p">,</span> <span class="n">NlmAuthor</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;list of authors contributing to the article (list of</span>
<span class="sd">    :class:`NlmAuthor`)&#39;&#39;&#39;</span>
    <span class="n">corresponding_author_emails</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;author-notes/corresp/email&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;list of email addresses listed in article metadata for correspondence&#39;&#39;&#39;</span>
    <span class="n">abstract</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/abstract&#39;</span><span class="p">,</span> <span class="n">NlmAbstract</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;article abstract&#39;&#39;&#39;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;preliminary mapping to article body (currently used to</span>
<span class="sd">    determine when full-text of the article is available)&#39;&#39;&#39;</span>
    <span class="n">sponsors</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/contract-sponsor&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;Sponsor or funding group&#39;&#39;&#39;</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/volume&#39;</span><span class="p">)</span>
    <span class="s1">&#39;journal volume&#39;</span>
    <span class="n">issue</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/issue&#39;</span><span class="p">)</span>
    <span class="s1">&#39;journal issue&#39;</span>
    <span class="n">first_page</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/fpage&#39;</span><span class="p">)</span>
    <span class="s1">&#39;first page&#39;</span>
    <span class="n">last_page</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/lpage&#39;</span><span class="p">)</span>
    <span class="s1">&#39;last page&#39;</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/journal-meta/publisher/publisher-name&#39;</span><span class="p">)</span>
    <span class="s1">&#39;journal publisher&#39;</span>
    <span class="n">pubdates</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/pub-date&#39;</span><span class="p">,</span>
                                     <span class="n">NlmPubDate</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;Article publication dates as list of :class:`NlmPubDate`.&#39;&#39;&#39;</span>
    <span class="n">pubdate_types</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/pub-date/@pub-type&#39;</span><span class="p">)</span>
    <span class="c1"># publication date types, for selecting first-choice pubdate</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/kwd-group/kwd&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;keywords describing the content of the article&#39;&#39;&#39;</span>
    <span class="n">author_notes</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/author-notes&#39;</span><span class="p">,</span>
                                        <span class="n">NlmAuthorNotes</span><span class="p">)</span>
    <span class="n">copyright</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/permissions/copyright-statement&#39;</span><span class="p">)</span>
    <span class="n">license</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;front/article-meta/permissions/license&#39;</span><span class="p">,</span> <span class="n">NlmLicense</span><span class="p">)</span>


    <span class="n">_publication_date</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">publication_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Article publication date as :class:`NlmPubDate`.  Looks for the</span>
<span class="sd">        article pub-date by type, and takes the first available of these,</span>
<span class="sd">        in this order: `epub-ppub` (both epub and ppub dates), `ppub`</span>
<span class="sd">        (print publication), `epub` (electronic publication).&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publication_date</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># pub-date types, in the order of preference</span>
            <span class="n">pubdatetypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;epub-ppub&#39;</span><span class="p">,</span> <span class="s1">&#39;ppub&#39;</span><span class="p">,</span> <span class="s1">&#39;epub&#39;</span><span class="p">]</span>
            <span class="c1"># determine which type we should use</span>
            <span class="k">for</span> <span class="n">pdtype</span> <span class="ow">in</span> <span class="n">pubdatetypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pdtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubdate_types</span><span class="p">:</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="n">pdtype</span>
                    <span class="k">break</span>
            <span class="c1"># find the right pubdate</span>
            <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubdates</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_publication_date</span> <span class="o">=</span> <span class="n">pd</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_publication_date</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fulltext_available</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;boolean; indicates whether or not the full text of the</span>
<span class="sd">        article is included in the fetched article.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">!=</span> <span class="bp">None</span>

    <span class="n">_identified_authors</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="NlmArticle.identifiable_authors_email"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.NlmArticle.identifiable_authors_email">[docs]</a>    <span class="k">def</span> <span class="nf">identifiable_authors_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">derive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Identify any Emory authors for the article and, if</span>
<span class="sd">        possible, return a list of corresponding</span>
<span class="sd">        :class:`~django.contrib.auth.models.User` objects.</span>
<span class="sd">        If derive is True it will try harder to match,</span>
<span class="sd">        it will try to derive based on netid and name.</span>

<span class="sd">        .. Note::</span>

<span class="sd">          The current implementation is preliminary and has the</span>
<span class="sd">          following **known limitations**:</span>

<span class="sd">            * Ignores authors that are associated with Emory</span>
<span class="sd">              but do not have an Emory email address included in the</span>
<span class="sd">              article metadata</span>
<span class="sd">            * User look-up uses LDAP, which only finds authors who are</span>
<span class="sd">              currently associated with Emory</span>

<span class="sd">        By default, caches the identified authors on the first</span>
<span class="sd">        look-up, in order to avoid unecessarily repeating LDAP</span>
<span class="sd">        queries.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">refresh</span><span class="p">:</span>

            <span class="c1"># find all author emails, either in author information or corresponding author</span>
            <span class="n">emails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">email</span> <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span> <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="n">emails</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corresponding_author_emails</span><span class="p">)</span>

            <span class="c1"># filter to just include the emory email addresses</span>
            <span class="c1"># TODO: other acceptable variant emory emails ? emoryhealthcare.org ?</span>
            <span class="n">emory_emails</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">emails</span> <span class="k">if</span> <span class="s1">&#39;emory.edu&#39;</span> <span class="ow">in</span> <span class="n">e</span> <span class="p">]</span>

            <span class="c1"># generate a list of User objects based on the list of emory email addresses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">em</span> <span class="ow">in</span> <span class="n">emory_emails</span><span class="p">:</span>
                <span class="c1"># if the user is already in the local database, use that</span>
                <span class="n">db_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">em</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">db_user</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db_user</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

                <span class="c1"># otherwise, try to look them up in ldap</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ldap</span> <span class="o">=</span> <span class="n">EmoryLDAPBackend</span><span class="p">()</span>
                    <span class="c1"># log ldap requests; using repr so it is evident when ldap is a Mock</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Looking up user in LDAP by email </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> (using </span><span class="si">%r</span><span class="s1">)&#39;</span> \
                                 <span class="o">%</span> <span class="p">(</span><span class="n">em</span><span class="p">,</span> <span class="n">ldap</span><span class="p">))</span>
                    <span class="n">user_dn</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="n">ldap</span><span class="o">.</span><span class="n">find_user_by_email</span><span class="p">(</span><span class="n">em</span><span class="p">,</span> <span class="n">derive</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span></div>

    <span class="n">_identified_authors</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="NlmArticle.identifiable_authors"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.NlmArticle.identifiable_authors">[docs]</a>    <span class="k">def</span> <span class="nf">identifiable_authors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">derive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Identify any Emory authors for the article and, if</span>
<span class="sd">        possible, return a list of corresponding</span>
<span class="sd">        :class:`~django.contrib.auth.models.User` objects.</span>
<span class="sd">        If derive is True it will try harder to match,</span>
<span class="sd">        it will try to derive based on netid and name.</span>

<span class="sd">        .. Note::</span>

<span class="sd">          The current implementation is preliminary and has the</span>
<span class="sd">          following **known limitations**:</span>

<span class="sd">            * Ignores authors that are associated with Emory</span>
<span class="sd">              but do not have an Emory email address included in the</span>
<span class="sd">              article metadata</span>
<span class="sd">            * User look-up uses LDAP, which only finds authors who are</span>
<span class="sd">              currently associated with Emory</span>

<span class="sd">        By default, caches the identified authors on the first</span>
<span class="sd">        look-up, in order to avoid unecessarily repeating LDAP</span>
<span class="sd">        queries.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">refresh</span><span class="p">:</span>

            <span class="c1"># broken xml in pubmed skips articles because there is not affiliation</span>
            <span class="n">authors_affil</span> <span class="o">=</span> <span class="p">[</span><span class="n">auth</span> <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span> <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">aff_ids</span><span class="p">]</span>

            <span class="n">emory_aff</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">authors_affil</span> <span class="k">if</span> <span class="s1">&#39;Emory University&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">affiliation</span><span class="p">]</span>

            <span class="c1"># generate a list of User objects based on the list of emory email addresses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">af</span> <span class="ow">in</span> <span class="n">emory_aff</span><span class="p">:</span>
                <span class="n">db_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;affiliation&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">db_user</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db_user</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;affiliation&quot;</span><span class="p">,</span><span class="n">first_name</span><span class="o">=</span><span class="s2">&quot;Other&quot;</span><span class="p">,</span><span class="n">last_name</span><span class="o">=</span><span class="s2">&quot;Emory Authors&quot;</span><span class="p">,</span> <span class="n">is_staff</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;affiliation@emory.edu&quot;</span><span class="p">)</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                    <span class="k">break</span>
                

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identified_authors</span></div>

    <span class="k">def</span> <span class="nf">as_article_mods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">amods</span> <span class="o">=</span> <span class="n">PublicationMods</span><span class="p">()</span>
        <span class="c1"># title &amp; subtitle</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">create_title_info</span><span class="p">()</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">article_title</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">article_subtitle</span>
        <span class="c1"># author names</span>
        <span class="n">id_auths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiable_authors</span><span class="p">()</span>
        <span class="c1"># generate a dict of email -&gt; username for identified emory authors</span>
        <span class="n">author_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">author_user</span> <span class="ow">in</span> <span class="n">id_auths</span><span class="p">:</span>
            <span class="n">author_ids</span><span class="p">[</span><span class="n">author_user</span><span class="o">.</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">author_user</span><span class="o">.</span><span class="n">username</span>

        <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">:</span>
            <span class="n">modsauth</span> <span class="o">=</span> <span class="n">AuthorName</span><span class="p">(</span><span class="n">family_name</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">surname</span><span class="p">,</span>
                                           <span class="n">given_name</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">given_names</span><span class="p">)</span>

            <span class="c1"># standardize any Emory affiliation</span>
            <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">affiliation</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;Emory University&#39;</span> <span class="ow">in</span> <span class="n">auth</span><span class="o">.</span><span class="n">affiliation</span><span class="p">:</span>
                    <span class="n">modsauth</span><span class="o">.</span><span class="n">affiliation</span> <span class="o">=</span> <span class="s1">&#39;Emory University&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">modsauth</span><span class="o">.</span><span class="n">affiliation</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">affiliation</span>

            <span class="c1"># if author has an email and it matches a name we</span>
            <span class="c1"># identified, set the username as mods id</span>
            <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">email</span> <span class="ow">in</span> <span class="n">author_ids</span><span class="p">:</span>
                <span class="n">modsauth</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">author_ids</span><span class="p">[</span><span class="n">auth</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># in some cases, corresponding email is not linked to</span>
                <span class="c1"># author name - do a best-guess match</span>
                <span class="k">for</span> <span class="n">idauth</span> <span class="ow">in</span> <span class="n">id_auths</span><span class="p">:</span>

                    <span class="c1"># if last name matches and first name is in given name</span>
                    <span class="c1"># (may have an extra initial, etc.), consider it a match</span>
                    <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">surname</span> <span class="o">==</span> <span class="n">idauth</span><span class="o">.</span><span class="n">last_name</span> <span class="ow">and</span> <span class="n">idauth</span><span class="o">.</span><span class="n">first_name</span> <span class="ow">in</span> <span class="n">auth</span><span class="o">.</span><span class="n">given_names</span><span class="p">:</span>
                        <span class="n">modsauth</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">idauth</span><span class="o">.</span><span class="n">username</span>
                        <span class="k">break</span>

            <span class="n">amods</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modsauth</span><span class="p">)</span>

        <span class="c1"># journal info</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">journals</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_journal_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal_title</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;starts&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">term</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="n">journal_suggestion_data</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span> <span class="k">for</span> <span class="n">journal</span> <span class="ow">in</span> <span class="n">journals</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">journal_title</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">create_journal</span><span class="p">()</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_title</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">publishers</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_publisher_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="n">publisher_suggestion_data</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span> <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_volume</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">issue</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_number</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">issue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_pages</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">publication_date</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">publication_date</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publication_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">create_abstract</span><span class="p">()</span>
            <span class="c1"># nlm abstract may can contain formatting; convert to</span>
            <span class="c1"># text-only for now</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abstract</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doi</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">create_final_version</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="s1">&#39;doi:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">doi</span>

        <span class="c1"># funding groups</span>
        <span class="k">for</span> <span class="n">sponsor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sponsors</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">funders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FundingGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">sponsor</span><span class="p">))</span>

        <span class="c1"># - add corresponding author info and related footnotes</span>
        <span class="c1"># as author individual author notes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">an</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_notes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">an</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
                    <span class="n">amods</span><span class="o">.</span><span class="n">author_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AuthorNote</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">txt</span><span class="p">))</span>

        <span class="c1"># capture article keywords, when available</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">kw</span><span class="p">))</span>

        <span class="c1"># TODO: investigate ext-link (can we determine type? or map to &#39;other links&#39;)</span>

        <span class="n">amods</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
        <span class="c1"># all content should be article;</span>
        <span class="c1"># (could check article/@article-type attribute to confirm...)</span>
        <span class="n">amods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Article&#39;</span>
        <span class="c1"># TODO: what is the &quot;version&quot; of harvested content? (preprint? postprint?)</span>

        <span class="c1"># license</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">license</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">create_license</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">link</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyright</span> <span class="ow">and</span> <span class="s1">&#39;creative commons&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyright</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">create_license</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">license</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyright</span>

        <span class="c1"># copyright</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyright</span><span class="p">:</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">create_copyright</span><span class="p">()</span>
            <span class="n">amods</span><span class="o">.</span><span class="n">copyright</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copyright</span>

        <span class="k">return</span> <span class="n">amods</span></div>

<span class="c1"># expand</span>
<div class="viewcode-block" id="PublicationPremis"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis">[docs]</a><span class="k">class</span> <span class="nc">PublicationPremis</span><span class="p">(</span><span class="n">premis</span><span class="o">.</span><span class="n">Premis</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extend :class:`eulxml.xmlmap.premis.Premis` to add convenience</span>
<span class="sd">    mappings to admin review event, review date, harvest event, harvest date,</span>
<span class="sd">    upload event, date uploaded.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#review event fields</span>
    <span class="n">review_event</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;review&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">date_reviewed</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;review&quot;]/p:eventDateTime&#39;</span><span class="p">)</span>

    <span class="c1">#merge event fields</span>
    <span class="n">merge_event</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;merge&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">date_merged</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;merge&quot;]/p:eventDateTime&#39;</span><span class="p">)</span>

    <span class="c1">#harvest event fields</span>
    <span class="n">harvest_event</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;harvest&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">date_harvested</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;harvest&quot;]/p:eventDateTime&#39;</span><span class="p">)</span>

    <span class="c1">#upload event fields</span>
    <span class="n">upload_event</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;upload&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">date_uploaded</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;upload&quot;]/p:eventDateTime&#39;</span><span class="p">)</span>

    <span class="c1">#withdraw event fields</span>
    <span class="n">withdraw_events</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;withdraw&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">last_withdraw</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;withdraw&quot;][last()]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>

    <span class="c1">#reinstate event fields</span>
    <span class="n">reinstate_events</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;reinstate&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">last_reinstate</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;reinstate&quot;][last()]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>

    <span class="c1">#symplectic-elements event fields</span>
    <span class="n">symp_ingest_event</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;symplectic elements ingest&quot;]&#39;</span><span class="p">,</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span>
    <span class="n">date_symp_ingest</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;p:event[p:eventType=&quot;symplectic elements ingest&quot;]/p:eventDateTime&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">id_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_object</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;p:representation&#39;</span>  <span class="c1"># needs to be in premis namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">id_type</span> <span class="o">=</span> <span class="n">id_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>

<div class="viewcode-block" id="PublicationPremis.premis_event"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.premis_event">[docs]</a>    <span class="k">def</span> <span class="nf">premis_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">detail</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Perform the common logic when creating premeis events. A :class:`~KeyError` Exception will be raised</span>
<span class="sd">        if the type is not in the list of allowed types.</span>

<span class="sd">        :param user: the :class:`~django.contrib.auth.models.User`</span>
<span class="sd">            who is performing the action.</span>

<span class="sd">        :param type: the type of event. Currently the allowed values are:</span>

<span class="sd">            * review</span>
<span class="sd">            * harvest</span>
<span class="sd">            * upload</span>
<span class="sd">            * withdraw</span>
<span class="sd">            * reinstate</span>
<span class="sd">            * merge</span>

<span class="sd">        :param detail: detail message for event`</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#TODO add to this list as types grow</span>
        <span class="n">allowed_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;review&#39;</span><span class="p">,</span> <span class="s1">&#39;harvest&#39;</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="s1">&#39;withdraw&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;reinstate&#39;</span><span class="p">,</span> <span class="s1">&#39;symp_ingest&#39;</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not an allowed type. The allowed types are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_types</span><span class="p">)))</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">event</span><span class="o">.</span><span class="n">id_type</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.ev</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">event</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span>
        <span class="n">event</span><span class="o">.</span><span class="n">agent_type</span> <span class="o">=</span> <span class="s1">&#39;netid&#39;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicationPremis.reviewed"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.reviewed">[docs]</a>    <span class="k">def</span> <span class="nf">reviewed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reviewer</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been</span>
<span class="sd">        reviewed. Wrapper for :meth:`~openemory.publication.models.PublicationPremis.premis_event`</span>

<span class="sd">        :param reviewer: the :class:`~django.contrib.auth.models.User`</span>
<span class="sd">            who reviewed the article</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Reviewed by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reviewer</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">reviewer</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premis_event</span><span class="p">(</span><span class="n">reviewer</span><span class="p">,</span> <span class="s1">&#39;review&#39;</span><span class="p">,</span><span class="n">detail</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="PublicationPremis.merged"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.merged">[docs]</a>    <span class="k">def</span> <span class="nf">merged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_pid</span><span class="p">,</span> <span class="n">element_pid</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been</span>
<span class="sd">        reviewed. Wrapper for :meth:`~openemory.publication.models.PublicationPremis.premis_event`</span>

<span class="sd">        :param reviewer: the :class:`~django.contrib.auth.models.User`</span>
<span class="sd">            who reviewed the article</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> merged with </span><span class="si">%s</span><span class="s1"> by Admininstrator&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">element_pid</span><span class="p">,</span> <span class="n">original_pid</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">premis</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">event</span><span class="o">.</span><span class="n">id_type</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.ev</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">event</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">event</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>   </div>

<div class="viewcode-block" id="PublicationPremis.harvested"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.harvested">[docs]</a>    <span class="k">def</span> <span class="nf">harvested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pmcid</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been</span>
<span class="sd">        harvested. Wrapper for :meth:`~openemory.publication.models.PublicationPremis.premis_event`</span>

<span class="sd">        :param user: the :class:`~django.contrib.auth.models.User`</span>
<span class="sd">            who harvested the article</span>

<span class="sd">        :param pmcid: the pmcid of the article in PubMed Central</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#TODO pmcid will have to change to something more general when more external systems are added</span>

        <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Harvested </span><span class="si">%s</span><span class="s1"> from PubMed Central by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                              <span class="p">(</span><span class="n">pmcid</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premis_event</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;harvest&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicationPremis.symp_ingest"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.symp_ingest">[docs]</a>    <span class="k">def</span> <span class="nf">symp_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been</span>
<span class="sd">        ingested from Symplectic-Elements. Wrapper for :meth:`~openemory.publication.models.PublicationPremis.premis_event`</span>

<span class="sd">        :param id: the id of the article in Symplectic-Elements</span>
<span class="sd">        &#39;&#39;&#39;</span>


        <span class="c1"># no log&#39;d in user available so use OE Bot</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Ingested </span><span class="si">%s</span><span class="s1"> from Symplectic-Elements by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                              <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premis_event</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;symp_ingest&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicationPremis.uploaded"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.uploaded">[docs]</a>    <span class="k">def</span> <span class="nf">uploaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">legal_statement</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been</span>
<span class="sd">        uploaded. Wrapper for :meth:`~openemory.publication.models.PublicationPremis.premis_event`</span>

<span class="sd">        :param user: the :class:`~django.contrib.auth.models.User`</span>
<span class="sd">            who uploaded the file</span>
<span class="sd">        :param legal_statement: string representing form of agreement</span>
<span class="sd">            indicated by user: &#39;AUTHOR&#39; for agreement to author&#39;s Assent to</span>
<span class="sd">            Deposit; &#39;MEDIATED&#39; for agreement to admin Mediated Deposit</span>
<span class="sd">            statement. This value should never be left as the default None:</span>
<span class="sd">            This will generate a statement that the item was uploaded</span>
<span class="sd">            without the user agreeing to a rights statement.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># LEGAL NOTE: We expect legal_statement will always be set to one of</span>
        <span class="c1"># the expected values. We&#39;re leaving an explicit check here to make</span>
        <span class="c1"># the code a little more resistant against future change, since this</span>
        <span class="c1"># addition is intended to represent the user&#39;s explicit agreement to</span>
        <span class="c1"># certain legal statements and will be recorded in long-term</span>
        <span class="c1"># storage.</span>
        <span class="k">if</span> <span class="n">legal_statement</span> <span class="o">==</span> <span class="s1">&#39;AUTHOR&#39;</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Uploaded by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> upon assent to deposit&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">legal_statement</span> <span class="o">==</span> <span class="s1">&#39;MEDIATED&#39;</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Mediated Deposit with Assist Authorization or CC or PD by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Uploaded by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> without confirmed assent to deposit&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span><span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
        <span class="n">detail</span> <span class="o">+=</span> <span class="s1">&#39; under OpenEmory v</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">openemory</span><span class="o">.</span><span class="n">__version__</span><span class="p">,)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">premis_event</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;upload&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicationPremis.withdrawn"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.withdrawn">[docs]</a>    <span class="k">def</span> <span class="nf">withdrawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been withdrawn</span>
<span class="sd">        from the public-facing collection by a site administrator.</span>

<span class="sd">        :param user: the :class:`~django.contrib.auth.models.User` who</span>
<span class="sd">            withdrew the article</span>
<span class="sd">        :param reason: user-entered string explaining the reason for</span>
<span class="sd">            withdrawal, to be included in the event detail</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Withdrawn by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premis_event</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;withdraw&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicationPremis.reinstated"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.PublicationPremis.reinstated">[docs]</a>    <span class="k">def</span> <span class="nf">reinstated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add an event to indicate that this article has been reinstated</span>
<span class="sd">        to the public-facing collection by a site administrator (after a</span>
<span class="sd">        past withdrawal).</span>

<span class="sd">        :param user: the :class:`~django.contrib.auth.models.User` who</span>
<span class="sd">            reinstated the article</span>
<span class="sd">        :param reason: optional user-entered string explaining the reason</span>
<span class="sd">            for reinstatement, to be included in the event detail</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;No reason given.&#39;</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="s1">&#39;Reinstated (from withdrawal) by </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premis_event</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;reinstate&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_make_parsed_author</span><span class="p">(</span><span class="n">mods_author</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generate a solr parsed_author field from a MODS author. Currently</span>
<span class="sd">    that solr field has the format &quot;netid:Published Name&quot;.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">netid</span> <span class="o">=</span> <span class="n">mods_author</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">netid</span><span class="p">,</span> <span class="n">mods_author</span><span class="o">.</span><span class="n">given_name</span><span class="p">,</span>
                         <span class="n">mods_author</span><span class="o">.</span><span class="n">family_name</span><span class="p">)</span>

<div class="viewcode-block" id="year_quarter"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.year_quarter">[docs]</a><span class="k">def</span> <span class="nf">year_quarter</span><span class="p">(</span><span class="n">month</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the quarter the year based on month param.</span>
<span class="sd">    For example month 2 would return 1, month 4 would return 2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Month must be between 1 and 12&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span></div>




<span class="n">SYMPLECTIC_MODEL_NS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="s1">&#39;info:symplectic/symplectic-elements:def/model#&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Publication"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication">[docs]</a><span class="k">class</span> <span class="nc">Publication</span><span class="p">(</span><span class="n">DigitalObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Subclass of :class:`~openemory.common.fedora.DigitalObject` to</span>
<span class="sd">    represent Scholarly Publications.</span>

<span class="sd">    Following `Hydra content model`_ conventions where appropriate;</span>
<span class="sd">    similar to the generic simple Hydra content model</span>
<span class="sd">    `genericContent`_.</span>

<span class="sd">    .. _Hydra content model: https://wiki.duraspace.org/display/hydra/Hydra+objects%2C+content+models+%28cModels%29+and+disseminators</span>
<span class="sd">    .. _genericContent: https://wiki.duraspace.org/display/hydra/Hydra+objects%2C+content+models+%28cModels%29+and+disseminators#Hydraobjects%2Ccontentmodels%28cModels%29anddisseminators-genericContent</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ARTICLE_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedArticle-1.0&#39;</span>
    <span class="n">BOOK_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedBook-1.0&#39;</span>
    <span class="n">CHAPTER_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedChapter-1.0&#39;</span>
    <span class="n">REPORT_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedReport-1.0&#39;</span>
    <span class="n">POSTER_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedPoster-1.0&#39;</span>
    <span class="n">CONFERENCE_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedConference-1.0&#39;</span>
    <span class="n">PUBLICATION_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedPublication-1.0&#39;</span>
    <span class="n">PRESENTATION_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedPresentation-1.0&#39;</span>

    <span class="n">CONTENT_MODELS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#: collection this object belongs to</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">Relation</span><span class="p">(</span><span class="n">relsext</span><span class="o">.</span><span class="n">isMemberOfCollection</span><span class="p">)</span>
    <span class="c1">#: OAI identifier</span>
    <span class="n">oai_itemID</span> <span class="o">=</span> <span class="n">Relation</span><span class="p">(</span><span class="n">oai</span><span class="o">.</span><span class="n">itemID</span><span class="p">)</span>
    <span class="c1">#: symplectic elements public url</span>
    <span class="n">public_url</span> <span class="o">=</span> <span class="n">Relation</span><span class="p">(</span><span class="n">SYMPLECTIC_MODEL_NS</span><span class="o">.</span><span class="n">hasPublicUrl</span><span class="p">)</span>

    <span class="n">allowed_mime_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pdf&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;docx&#39;</span><span class="p">:</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span><span class="s1">&#39;pptx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">,</span><span class="s1">&#39;ppt&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;tiff&#39;</span><span class="p">:</span><span class="s1">&#39;image/tiff&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;xls&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">}</span>
    <span class="n">allowed_mime_conference</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pdf&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;docx&#39;</span><span class="p">:</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span><span class="s1">&#39;pptx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">,</span><span class="s1">&#39;ppt&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;tiff&#39;</span><span class="p">:</span><span class="s1">&#39;image/tiff&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;xls&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">}</span>
    <span class="n">allowed_mime_report</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pdf&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span><span class="s1">&#39;docx&#39;</span><span class="p">:</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span> <span class="s1">&#39;xls&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;tiff&#39;</span><span class="p">:</span><span class="s1">&#39;image/tiff&#39;</span><span class="p">,</span><span class="s1">&#39;pptx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">,</span><span class="s1">&#39;ppt&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">}</span>

    <span class="n">allowed_mime_poster</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pdf&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span><span class="s1">&#39;docx&#39;</span><span class="p">:</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;xls&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">,</span><span class="s1">&#39;tiff&#39;</span><span class="p">:</span><span class="s1">&#39;image/tiff&#39;</span><span class="p">,</span><span class="s1">&#39;pptx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">,</span><span class="s1">&#39;ppt&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">}</span>

    <span class="n">allowed_mime_presentation</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pdf&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span><span class="s1">&#39;docx&#39;</span><span class="p">:</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;xls&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">,</span><span class="s1">&#39;tiff&#39;</span><span class="p">:</span><span class="s1">&#39;image/tiff&#39;</span><span class="p">,</span><span class="s1">&#39;pptx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">,</span><span class="s1">&#39;ppt&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">}</span>

    <span class="n">pdf</span> <span class="o">=</span> <span class="n">FileDatastream</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;PDF content&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">})</span>

    <span class="c1"># file_download = FileDatastream(&#39;content&#39;, &#39;File&#39;, defaults={</span>
        <span class="c1"># &#39;versionable&#39;: True</span>
        <span class="c1"># })</span>

    <span class="c1"># image = FileDatastream(&#39;IMAGE&#39;, &#39;image datastream&#39;, defaults={</span>
                <span class="c1"># &#39;mimetype&#39;: &#39;image/png&#39;})</span>

    <span class="sd">&#39;&#39;&#39;PDF content of a scholarly publication, stored and accessed as a</span>
<span class="sd">    :class:`~eulfedora.models.FileDatastream`; datastream is</span>
<span class="sd">    configured to be versioned and managed; default mimetype is</span>
<span class="sd">    ``application/pdf``.&#39;&#39;&#39;</span>

    <span class="n">descMetadata</span> <span class="o">=</span> <span class="n">XmlDatastream</span><span class="p">(</span><span class="s1">&#39;descMetadata&#39;</span><span class="p">,</span> <span class="s1">&#39;Descriptive Metadata (MODS)&#39;</span><span class="p">,</span>
        <span class="n">PublicationMods</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="c1"># dc = XmlDatastream(&#39;DC&#39;, &#39;Dublin Core Record for this object&#39;)</span>
    <span class="sd">&#39;&#39;&#39;Descriptive Metadata datastream, as :class:`PublicationMods`&#39;&#39;&#39;</span>

    <span class="n">contentMetadata</span> <span class="o">=</span> <span class="n">XmlDatastream</span><span class="p">(</span><span class="s1">&#39;contentMetadata&#39;</span><span class="p">,</span> <span class="s1">&#39;content metadata&#39;</span><span class="p">,</span> <span class="n">NlmArticle</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">})</span>
    <span class="sd">&#39;&#39;&#39;Optional datastream for additional content metadata for a</span>
<span class="sd">    scholarly article that is not the primary descriptive metadata as an</span>
<span class="sd">    :class:`NlmArticle`.&#39;&#39;&#39;</span>


    <span class="n">provenance</span> <span class="o">=</span> <span class="n">XmlDatastream</span><span class="p">(</span><span class="s1">&#39;provenanceMetadata&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;Provenance metadata&#39;</span><span class="p">,</span> <span class="n">PublicationPremis</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">})</span>
    <span class="sd">&#39;&#39;&#39;Optional ``provenanceMetadata`` datastream for PREMIS Event</span>
<span class="sd">    metadata; datastream XML content will be an instance of</span>
<span class="sd">    :class:`PublicationPremis`.&#39;&#39;&#39;</span>
    <span class="c1"># NOTE: datastream naming based on Hydra cnotent model documentation</span>
    <span class="c1"># https://wiki.duraspace.org/display/hydra/Hydra+objects%2C+content+models+%28cModels%29+and+disseminators</span>
    <span class="c1"># 	provenanceMetadata (XML, optional)- this datastream may</span>
    <span class="c1"># 	   contain, for instance, PREMIS premisEvents.</span>

    <span class="n">authorAgreement</span> <span class="o">=</span> <span class="n">FileDatastream</span><span class="p">(</span><span class="s1">&#39;authorAgreement&#39;</span><span class="p">,</span> <span class="s1">&#39;Author agreement&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">})</span>
    <span class="sd">&#39;&#39;&#39;Optional ``authorAgreement`` datastream stores the authors&#39; agreement</span>
<span class="sd">    (if available) with the publisher.&#39;&#39;&#39;</span>
    <span class="c1"># NOTE: authorAgreement isn&#39;t in the Hydra content model. Neither is</span>
    <span class="c1"># anything like it. So we just follow their naming style here.</span>

    <span class="n">sympAtom</span> <span class="o">=</span> <span class="n">XmlDatastream</span><span class="p">(</span><span class="s1">&#39;SYMPLECTIC-ATOM&#39;</span><span class="p">,</span> <span class="s1">&#39;SYMPLECTIC-ATOM&#39;</span><span class="p">,</span>
        <span class="n">SympAtom</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;versionable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="sd">&#39;&#39;&#39;Descriptive Metadata datastream, as :class:`PublicationMods`&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ark_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">ark_uri</span>
        <span class="k">return</span> <span class="n">ark_uri</span> <span class="ow">or</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;publication:view&#39;</span><span class="p">,</span>  <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">number_of_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;The number of pages in the PDF associated with this object&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if this article doesn&#39;t have a content datastream, skip it</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
    		<span class="k">return</span> <span class="bp">None</span>

            <span class="n">pdfreader</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pdfreader</span><span class="o">.</span><span class="n">getNumPages</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RequestFailed</span> <span class="k">as</span> <span class="n">rf</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to determine number of pages for </span><span class="si">%s</span><span class="s1"> : </span><span class="si">%s</span><span class="s1">&#39;</span> \
                         <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">rf</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_mods_to_dc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Maps valies from MOS to DC for use with OAI</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span>

            <span class="c1"># title and subtitle</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span>  <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">title</span>
                <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">title_list</span> <span class="o">=</span>  <span class="p">[</span><span class="n">title</span><span class="p">]</span>


            <span class="c1"># author full names</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">contributor_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">given_name</span><span class="p">,</span> <span class="n">author</span><span class="o">.</span><span class="n">family_name</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="p">]</span>
            <span class="c1"># types and version</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">)</span>
            <span class="n">dc</span><span class="o">.</span><span class="n">type_list</span> <span class="o">=</span>  <span class="n">types</span>

            <span class="c1"># language</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">language</span>

            <span class="c1"># mime type</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">physical_description</span><span class="p">:</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">physical_description</span><span class="o">.</span><span class="n">media_type</span>

            <span class="c1"># abstract</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span>

            <span class="c1"># subject and keywords</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="n">subjects</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">subjects</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">topic</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span>
                <span class="n">dc</span><span class="o">.</span><span class="n">subject_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">k</span><span class="o">.</span><span class="n">topic</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">])</span>


<span class="c1">#            relations = []</span>
<span class="c1">#</span>
<span class="c1">#            # perm link</span>
<span class="c1">#            relations.append(mods.ark_uri)</span>
<span class="c1">#            dc.relation_list = relations</span>

            <span class="c1"># publisher info</span>
            <span class="c1"># Title, Volume, Issue, Publication Date and Pagination</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="p">:</span>
                    <span class="n">volume</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">issue</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                        <span class="n">p_start</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span>
                        <span class="n">p_end</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p_start</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">p_end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="n">pub_info</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Volume </span><span class="si">%s</span><span class="s1"> Issue </span><span class="si">%s</span><span class="s1"> Date </span><span class="si">%s</span><span class="s1"> Pages </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                           <span class="n">volume</span><span class="p">,</span>
                           <span class="n">issue</span><span class="p">,</span>
                           <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="p">,</span>
                           <span class="n">p_start</span><span class="p">,</span> <span class="n">p_end</span><span class="p">)</span>
                    <span class="n">dc</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">pub_info</span>


<div class="viewcode-block" id="Publication.save"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Extend default :meth:`eulfedora.models.DigitalObject.save`</span>
<span class="sd">        to update a few fields before saving to Fedora.</span>

<span class="sd">          * set object owners based on ids from authors set in</span>
<span class="sd">            :attr:`descMetadata` content; if this would result in no owners,</span>
<span class="sd">            the previous value is left as is.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># update owners based on identified emory authors in the metadata</span>
        <span class="n">new_owners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OWNER_ID_SEPARATOR</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">auth</span>
                                                   <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">authors</span>
                                                   <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># only update if there are new owners; don&#39;t clear out an existing owner</span>
        <span class="c1"># without setting a new owner</span>
        <span class="k">if</span> <span class="n">new_owners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">new_owners</span>

        <span class="c1"># Remove control character \r  from abstract</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># map MODS values into DC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mods_to_dc</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Publication</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Publication.as_rdf"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.as_rdf">[docs]</a>    <span class="k">def</span> <span class="nf">as_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Information about this Publication in RDF format.  Currently,</span>
<span class="sd">        makes use of `Bibliographic Ontology`_ and FRBR.</span>

<span class="sd">        .. _Bibliographic Ontology: http://bibliontology.com/</span>

<span class="sd">        :returns: instance of :class:`rdflib.graph.Graph`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uriref</span>

        <span class="n">rdf</span> <span class="o">=</span> <span class="n">RdfGraph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">ns_prefixes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">rdf</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="c1"># some redundancy here, for now</span>
        <span class="n">rdf</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">BIBO</span><span class="o">.</span><span class="n">AcademicArticle</span><span class="p">))</span>
        <span class="n">rdf</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">FRBR</span><span class="o">.</span><span class="n">ScholarlyWork</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_pages</span><span class="p">:</span>
            <span class="n">rdf</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">BIBO</span><span class="o">.</span><span class="n">numPages</span><span class="p">,</span> <span class="n">Literal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_pages</span><span class="p">)))</span>

        <span class="n">pmc_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">pmcid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmcid</span>
        <span class="k">if</span> <span class="n">pmcid</span><span class="p">:</span>
            <span class="n">pmc_url</span> <span class="o">=</span> <span class="n">pmc_access_url</span><span class="p">(</span><span class="n">pmcid</span><span class="p">)</span>
            <span class="n">rdf</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">RDFS</span><span class="o">.</span><span class="n">seeAlso</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">pmc_url</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;identifier&#39;</span> <span class="ow">and</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">==</span> <span class="n">pmc_url</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c1"># PMC url is a RDFS:seeAlso, above. skip it here</span>
            <span class="n">rdf</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">DC</span><span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">Literal</span><span class="p">(</span><span class="n">el</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">rdf</span></div>

<div class="viewcode-block" id="Publication.index_data"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.index_data">[docs]</a>    <span class="k">def</span> <span class="nf">index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Extend the default</span>
<span class="sd">        :meth:`openemory.common.fedora.DigitalObject.index_data` method to</span>
<span class="sd">        include fields needed for search and display of Publication</span>
<span class="sd">        objects.&#39;&#39;&#39;</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Publication</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">index_data</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pid: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;withdrawn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_withdrawn</span>
        <span class="c1"># TODO:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Article&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_article&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Book&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_book&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Chapter&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_chapter&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Conference&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_conference&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Report&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_report&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Poster&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_poster&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Presentation&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_presentation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;publication_article&#39;</span>

        <span class="c1"># following django convention: app_label, model</span>

        <span class="c1"># embargo_end date</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;embargo_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span>


        <span class="c1"># add full document text from pdf if available and not embargoed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_embargoed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fulltext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf_to_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># errors if datastream cannot be read as a pdf</span>
                <span class="c1"># (should be less of an issue after we add format validation)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to read </span><span class="si">%s</span><span class="s1"> pdf datastream content for indexing: </span><span class="si">%s</span><span class="s1">&#39;</span> \
                             <span class="o">%</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>


        <span class="c1"># index descriptive metadata if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>	<span class="c1"># replace title set from dc:title</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">title</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">funders</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;funder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">funders</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="s1">&#39;Article&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;journal_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;journal_title_sorting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;journal_publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">sponsor</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">sponsor</span>

            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">publisher</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">publisher</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;abstract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kw</span><span class="o">.</span><span class="n">topic</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">subjects</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;researchfield_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rf</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">subjects</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;researchfield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rf</span><span class="o">.</span><span class="n">topic</span> <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">subjects</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;researchfield_sorting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">rf</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>
                                                 <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">subjects</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">author_notes</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;author_notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">author_notes</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># index year separately, since all dates should have at least year</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pubyear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pubdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mods</span><span class="o">.</span><span class="n">language</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="p">:</span>
                <span class="n">mods_authors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">family_name</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">given_name</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="p">]</span>
                <span class="n">sorting_authors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">a</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods_authors</span><span class="p">]</span>
                <span class="c1"># *replace* any dc:authors to ensure</span>
                <span class="c1"># we don&#39;t duplicate names in variant forms</span>
                <span class="c1"># check for dc authors and add to them if set</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;creator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods_authors</span>

                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;author_affiliation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">affiliation</span>
                                                      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span>
                                                      <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">affiliation</span><span class="p">))</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;affiliations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affiliations</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;parsed_author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_make_parsed_author</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;creator_sorting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorting_authors</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;division_dept_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">division_dept_id</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;department_shortname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">department_shortname</span>

        <span class="c1"># get contentMetadata (NLM XML) bits</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contentMetadata</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="c1"># some contentMetadata datastreams can&#39;t be loaded - *probably* bogus dev/test data</span>
            <span class="c1"># - but don&#39;t blow up if contentMetadata exists but can&#39;t be loaded</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nxml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contentMetadata</span><span class="o">.</span><span class="n">content</span>
                <span class="k">if</span> <span class="s1">&#39;fulltext&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">nxml</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fulltext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">nxml</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nxml</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">and</span> \
                       <span class="s1">&#39;abstract&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>	<span class="c1"># let MODS abstract take precedence</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;abstract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">nxml</span><span class="o">.</span><span class="n">abstract</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to load </span><span class="si">%s</span><span class="s1"> contentMetadata as xml for indexing: </span><span class="si">%s</span><span class="s1">&#39;</span> \
                             <span class="o">%</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># if provenanceMetadata datastream exists, check for review date</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">date_reviewed</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;review_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">date_reviewed</span>

        <span class="c1"># index the pubmed central id, if we have one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmcid</span><span class="p">:</span>
            <span class="n">pmcid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmcid</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pmcid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmcid</span>
            <span class="k">if</span> <span class="n">pmcid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]:</span>	<span class="c1"># don&#39;t double-index PMC id</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pmcid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">author_netids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">author_esd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">netid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_netids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">netid</span><span class="p">)</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">userprofile</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">esd_data</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">esd</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">affiliations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">aff</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">esd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_esd</span>
                <span class="k">for</span> <span class="n">aff</span> <span class="ow">in</span> <span class="n">esd</span><span class="o">.</span><span class="n">affiliations</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">department_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">esd</span><span class="o">.</span><span class="n">department_name</span> <span class="k">for</span> <span class="n">esd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_esd</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">department_shortname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">esd</span><span class="o">.</span><span class="n">department_shortname</span> <span class="k">for</span> <span class="n">esd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_esd</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">division_dept_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">esd</span><span class="o">.</span><span class="n">division_dept_id</span> <span class="k">for</span> <span class="n">esd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">author_esd</span><span class="p">]</span>

    <span class="c1"># FIXME: this is a pretty ugly way to just call a method on EsdPerson.</span>
    <span class="c1"># it&#39;s so indirect because we want to avoid depending directly on</span>
    <span class="c1"># accounts (where EsdPerson lives) because accounts already depends on</span>
    <span class="c1"># publication. clearly, though, a better dependency structure is needed</span>
    <span class="c1"># here.</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">split_department</span><span class="p">(</span><span class="n">division_dept_id</span><span class="p">):</span>
        <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_PROFILE_MODULE</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">profile_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="n">esd_model</span> <span class="o">=</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">esd_model</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">esd_model</span><span class="o">.</span><span class="n">split_department</span><span class="p">(</span><span class="n">division_dept_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pmcid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">identifier_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;PMC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">id</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">embargo_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return :attr:`PublicationMods.embargo_end` &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">embargo_end_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Access :attr:`PublicationMods.embargo_end` on the local</span>
<span class="sd">        :attr:`descMetadata` datastream as a :class:`datetime.date`</span>
<span class="sd">        instance.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo</span> <span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
              <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">_embargo</span>

            <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="n">NO_LIMIT</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">publication_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                  <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">+</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=+</span><span class="mi">480</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="k">return</span> <span class="n">NO_LIMIT</span><span class="p">[</span><span class="s2">&quot;display&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="n">UNKNOWN_LIMIT</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                  <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">publication_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                  <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">+</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=+</span><span class="mi">6</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                  <span class="k">return</span> <span class="n">UNKNOWN_LIMIT</span><span class="p">[</span><span class="s2">&quot;display&quot;</span><span class="p">]</span>

            <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_embargoed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;boolean indicator that this publication is currently embargoed</span>
<span class="sd">        (i.e., there is an embargo end date set and that date is not</span>
<span class="sd">        in the past).&#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embargo_end_date</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="n">NO_LIMIT</span><span class="p">[</span><span class="s2">&quot;display&quot;</span><span class="p">])</span> <span class="ow">or</span> \
           <span class="n">slugify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embargo_end_date</span><span class="p">)</span> <span class="o">==</span> <span class="n">slugify</span><span class="p">(</span><span class="n">UNKNOWN_LIMIT</span><span class="p">[</span><span class="s2">&quot;display&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">embargo_end</span> <span class="ow">and</span>  \
               <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo_end_date</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_published</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;boolean indicator that this publication is currently published</span>
<span class="sd">        (currently defined as object by object state being **active**).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_withdrawn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;boolean indicator that this publication is currently withdrawn from</span>
<span class="sd">        the public-facing website.&#39;&#39;&#39;</span>

        <span class="c1"># if the publication is active, it&#39;s not withdrawn.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># if there are no withdrawal events, it&#39;s not withdrawn.</span>
        <span class="n">provenance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">content</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provenance</span><span class="o">.</span><span class="n">last_withdraw</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># if there are withdrawals and no reinstates, it *is* withdrawn</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provenance</span><span class="o">.</span><span class="n">last_reinstate</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># if there are both, then most recent one wins.</span>
        <span class="k">return</span> <span class="n">provenance</span><span class="o">.</span><span class="n">last_withdraw</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">provenance</span><span class="o">.</span><span class="n">last_reinstate</span><span class="o">.</span><span class="n">date</span>

<div class="viewcode-block" id="Publication.statistics"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.statistics">[docs]</a>    <span class="k">def</span> <span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quarter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the :class:`ArticleStatistics` for this object on the given</span>
<span class="sd">        year and / or quarter. If no year is specified, use the current year.</span>
<span class="sd">        If no quarter is specified, use the current quarter.</span>
<span class="sd">        Returns None if this article does not yet have a PID.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="k">if</span> <span class="n">quarter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">quarter</span> <span class="o">=</span> <span class="n">year_quarter</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="c1">#get the quarter 1, 2, 3, 4</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">stats</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">ArticleStatistics</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span> <span class="n">quarter</span><span class="o">=</span><span class="n">quarter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>

<div class="viewcode-block" id="Publication.statistics_queryset"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.statistics_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">statistics_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a :class:`~django.db.models.query.QuerySet` for all this</span>
<span class="sd">        article&#39;s :class:`ArticleStatistics`. Returns None if this article</span>
<span class="sd">        does not yet have a PID.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">ArticleStatistics</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span></div>

         


<div class="viewcode-block" id="Publication.aggregate_statistics"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.aggregate_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get statistics for this article, aggregated across all available</span>
<span class="sd">        :class:`ArticleStatistics` objects.</span>

<span class="sd">        :returns: a dictionary with ``num_views`` and ``num_downloads``</span>
<span class="sd">                  members</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_queryset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">qs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">num_views</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;num_views&#39;</span><span class="p">),</span>
                                <span class="n">num_downloads</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;num_downloads&#39;</span><span class="p">))</span></div>

    <span class="c1">### PDF generation methods for Article cover page ###</span>


<div class="viewcode-block" id="Publication.pdf_cover"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.pdf_cover">[docs]</a>    <span class="k">def</span> <span class="nf">pdf_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate a PDF cover page based on the MODS descriptive</span>
<span class="sd">        metadata associated with this article (:attr:`descMetadata`),</span>
<span class="sd">        using :mod:`xhtml2pdf`.</span>

<span class="sd">        :returns: a :class:`cStringIO.StringIO` with PDF content</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;publication/coverpage.html&#39;</span><span class="p">)</span>
        <span class="c1"># full URLs are required for external links in pisa PDF documents</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">base_url</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
            <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s1">&#39;BASE_URL&#39;</span><span class="p">:</span> <span class="n">base_url</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="c1"># NOTE: to include images &amp; css, pisa requires a filename path.</span>
        <span class="c1"># Setting path relative to sitemedia directory so STATIC_URL paths will (generally) work.</span>
        
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">pisaDocument</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)),</span> <span class="n">result</span><span class="p">,</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;sitemedia&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf.html&#39;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generated cover page for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%f</span><span class="s1"> sec &#39;</span> <span class="o">%</span> \
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Publication.image_cover"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.image_cover">[docs]</a>    <span class="k">def</span> <span class="nf">image_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate a PDF cover page based on the MODS descriptive</span>
<span class="sd">        metadata associated with this article (:attr:`descMetadata`),</span>
<span class="sd">        using :mod:`xhtml2pdf`.</span>

<span class="sd">        :returns: a :class:`cStringIO.StringIO` with PDF content</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tpl</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;publication/imagepage.html&#39;</span><span class="p">)</span>
        <span class="n">my_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">content</span>
        <span class="n">img_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">my_image</span><span class="p">)</span>
        <span class="n">img_str</span> <span class="o">=</span> <span class="s1">&#39;data:image/png;base64,&#39;</span> <span class="o">+</span> <span class="n">img_str</span>
        <span class="c1"># full URLs are required for external links in pisa PDF documents</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">base_url</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
            <span class="s1">&#39;article&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s1">&#39;BASE_URL&#39;</span><span class="p">:</span> <span class="n">base_url</span><span class="p">,</span><span class="s1">&#39;img_str&#39;</span><span class="p">:</span> <span class="n">img_str</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">tpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="c1"># NOTE: to include images &amp; css, pisa requires a filename path.</span>
        <span class="c1"># Setting path relative to sitemedia directory so STATIC_URL paths will (generally) work.</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">pisaDocument</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)),</span> <span class="n">result</span><span class="p">,</span>
                                <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;sitemedia&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf.html&#39;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generated cover page for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%f</span><span class="s1"> sec &#39;</span> <span class="o">%</span> \
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">what_mime_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mime_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">all_allowed_mime</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pdf&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;docx&#39;</span><span class="p">:</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span><span class="s1">&#39;pptx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">,</span><span class="s1">&#39;ppt&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">,</span><span class="s1">&#39;jpeg&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span><span class="s1">&#39;png&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span><span class="s1">&#39;tiff&#39;</span> <span class="p">:</span> <span class="s1">&#39;image/tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;xls&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">}</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mime_ds_list</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mime_ds_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mimeType</span> <span class="ow">in</span> <span class="n">all_allowed_mime</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>


        <span class="k">if</span> <span class="n">mime_ds_list</span><span class="p">:</span>
            <span class="c1"># sort by DS timestamp does not work yet asks for global name obj because of lambda function</span>
            <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">mime_ds_list</span><span class="p">:</span>
                <span class="c1"># print &quot;Got Here&quot;</span>
                <span class="n">new_dict</span><span class="p">[</span><span class="n">mime</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDatastreamObject</span><span class="p">(</span><span class="n">mime</span><span class="p">)</span>


            <span class="n">sorted_mimes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># sorted_mimes = sorted(mime_ds_list, key=lambda p: str(obj.getDatastreamObject(p).last_modified()))</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="n">sorted_mimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># most recent</span>
            <span class="c1"># print mime</span>
            <span class="k">if</span> <span class="n">mime</span><span class="p">:</span>

                <span class="n">mime_type</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ds_list</span><span class="p">[</span><span class="n">mime</span><span class="p">]</span><span class="o">.</span><span class="n">mimeType</span>

                <span class="k">if</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span> <span class="ow">or</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;word&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span> <span class="ow">or</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.ms-excel&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;excel&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.presentationml.presentation&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;powerpoint&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/vnd.ms-powerpoint&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;powerpoint2&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;image/png&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;png&#39;</span>
                <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;image/tiff&#39;</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;tiff&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mymime</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>



                <span class="k">return</span> <span class="n">mymime</span>


<div class="viewcode-block" id="Publication.image_with_cover"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.image_with_cover">[docs]</a>    <span class="k">def</span> <span class="nf">image_with_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the PDF associated with this image (the contents</span>
<span class="sd">        of the :attr:`png,jpeg` datastream) with a custom cover page</span>
<span class="sd">        (generated by :meth:`pdf_cover`). &#39;&#39;&#39;</span>
        <span class="n">coverdoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_cover</span><span class="p">()</span>
        <span class="n">imagedoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_cover</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pdfstream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>  <span class="c1"># io buffer for pdf datastream content</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create a new pdf file writer to merge cover &amp; pdf into</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">PdfFileWriter</span><span class="p">()</span>
            <span class="c1"># load and add cover page first</span>
            <span class="n">cover</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">coverdoc</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">imagedoc</span><span class="p">)</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">addPage</span><span class="p">(</span><span class="n">cover</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">addPage</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># write the resulting pdf to a buffer and return it</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="c1"># seek to beginning for re-use (e.g., django httpresponse content)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added cover page to PDF for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%f</span><span class="s1"> sec &#39;</span> <span class="o">%</span> \
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">coverdoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># delete xsl-fo</span>
            <span class="n">pdfstream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close iostream for pdf content</span></div>


<div class="viewcode-block" id="Publication.zip_with_cover"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.zip_with_cover">[docs]</a>    <span class="k">def</span> <span class="nf">zip_with_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the zip associated with this publication (the contents</span>
<span class="sd">        of the zip is `excel,powerpoint,word` datastream) with a custom cover page</span>
<span class="sd">        (generated by :meth:`pdf_cover`). &#39;&#39;&#39;</span>

        <span class="n">coverdoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_cover</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">datastream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">zip_subdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>
        <span class="c1"># load pdf datastream contents into a file-like object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">get_chunked_content</span><span class="p">():</span>
                <span class="n">datastream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">mime_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">what_mime_type</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;powerpoint&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;pptx&#39;</span>
            <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;word&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;docx&#39;</span>
            <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;powerpoint2&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;ppt&#39;</span>
            <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;excel&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;xlsx&#39;</span>
            <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;png&#39;</span>
            <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;jpg&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;jpg&#39;</span>
            <span class="k">elif</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;tiff&#39;</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;tiff&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>

                <span class="c1"># mime = &#39;pdf&#39;</span>
            <span class="c1"># write the resulting pdf to a buffer and return it</span>
            <span class="n">zip_subdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="c1"># doc.write(result)</span>
            <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">zip_subdir</span> <span class="o">+</span> <span class="s1">&#39;coverpage.pdf&#39;</span><span class="p">,</span> <span class="n">coverdoc</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">zip_subdir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">mime</span><span class="p">,</span> <span class="n">datastream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="c1"># seek to beginning for re-use (e.g., django httpresponse content)</span>
            <span class="c1"># result.seek(0)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added cover page to PDF for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%f</span><span class="s1"> sec &#39;</span> <span class="o">%</span> \
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">coverdoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># delete xsl-fo</span>
            <span class="n">datastream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close iostream for pdf content</span>
            <span class="n">zf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close zip for content</span></div>

<div class="viewcode-block" id="Publication.pdf_with_cover"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.pdf_with_cover">[docs]</a>    <span class="k">def</span> <span class="nf">pdf_with_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the PDF associated with this article (the contents</span>
<span class="sd">        of the :attr:`pdf` datastream) with a custom cover page</span>
<span class="sd">        (generated by :meth:`pdf_cover`).</span>

<span class="sd">        .. Note::</span>
<span class="sd">          This method currently does **not** trap for errors such as \</span>
<span class="sd">          :class:`pyPdf.util.PdfReadError` or \</span>
<span class="sd">          :class:`eulfedora.util.RequestFailed` (e.g., if the \</span>
<span class="sd">          datastream does not exist or cannot be accessed, or the \</span>
<span class="sd">          datastream exists but the PDF is unreadable with \</span>
<span class="sd">          :mod:`pyPdf`).</span>

<span class="sd">        :returns: :class:`cStringIO.StringIO` instance with the \</span>
<span class="sd">        merged pdf content</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># NOTE: pyPdf PdfFileWrite currently does not supply a</span>
        <span class="c1"># mechanism to set document info / metadata (title, author, etc.)</span>
        <span class="c1"># Cover page PDF is being generated with embedded metadata.</span>
        <span class="c1"># When/if it becomes possible, use coverdoc info to set the</span>
        <span class="c1"># docinfo for the merged pdf.</span>

        <span class="n">coverdoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_cover</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pdfstream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>  <span class="c1"># io buffer for pdf datastream content</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># create a new pdf file writer to merge cover &amp; pdf into</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">PdfFileWriter</span><span class="p">()</span>
            <span class="c1"># load and add cover page first</span>
            <span class="n">cover</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">coverdoc</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">addPage</span><span class="p">(</span><span class="n">cover</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># print &quot;Got Here&quot;</span>
            <span class="c1"># load pdf datastream contents into a file-like object</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">get_chunked_content</span><span class="p">():</span>

                <span class="n">pdfstream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

            <span class="c1"># load pdf content into a pdf reader and add all pages</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">pdfstream</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># print content.numPages</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">numPages</span><span class="p">):</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">addPage</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                <span class="c1"># print content.pages[p]</span>

            <span class="c1"># write the resulting pdf to a buffer and return it</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="c1"># seek to beginning for re-use (e.g., django httpresponse content)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added cover page to PDF for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%f</span><span class="s1"> sec &#39;</span> <span class="o">%</span> \
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">coverdoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># delete xsl-fo</span>
            <span class="n">pdfstream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close iostream for pdf content</span></div>



    <span class="k">def</span> <span class="nf">_prep_dc_for_oai</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes namespaces that cause OAI a problem&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;xsi&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="c1"># Remove SchemaLocation Attribute</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">nsmap</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">],</span> <span class="s1">&#39;schemaLocation&#39;</span><span class="p">)]</span>

            <span class="c1"># Remove namespace declaration</span>
            <span class="n">nsmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">nsmap</span>
            <span class="k">del</span> <span class="n">nsmap</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">]</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">nsmap</span><span class="o">=</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="n">new_node</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">new_node</span>

<div class="viewcode-block" id="Publication.as_symp"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.as_symp">[docs]</a>    <span class="k">def</span> <span class="nf">as_symp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes an optional source param that will set the source in the :class:`SympRelation` objects.</span>
<span class="sd">        source_id param that will set the source-id in the :class:`SympRelation` objects.</span>
<span class="sd">        Returns a :class:`OESympImportPublication` object</span>
<span class="sd">        and a list of :class:`SympRelation` objects</span>
<span class="sd">        for use with Symplectic-Elements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># build article xml</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span>
        <span class="n">symp_pub</span> <span class="o">=</span> <span class="n">OESympImportPublication</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">title</span>
            <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">mods</span><span class="o">.</span><span class="n">title_info</span><span class="o">.</span><span class="n">subtitle</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span> <span class="ow">and</span> <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span><span class="p">:</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;doi:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="p">:</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span> <span class="ow">and</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span>  <span class="k">else</span> <span class="bp">None</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span> <span class="ow">and</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="p">:</span>
            <span class="n">day</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
            <span class="n">date_info</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>

            <span class="c1"># order day, month, year is required</span>
            <span class="n">pub_date</span> <span class="o">=</span> <span class="n">SympDate</span><span class="p">()</span>
            <span class="n">pub_date</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">day</span>
            <span class="n">pub_date</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">month</span>
            <span class="n">pub_date</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pub_date</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">symp_pub</span><span class="o">.</span><span class="n">publication_date</span> <span class="o">=</span> <span class="n">pub_date</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmcid</span><span class="p">:</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">pmcid</span> <span class="o">=</span> <span class="s2">&quot;PMC</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmcid</span>

        <span class="n">symp_pub</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">mods</span><span class="o">.</span><span class="n">language</span> <span class="k">if</span> <span class="n">mods</span><span class="o">.</span><span class="n">languages</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">symp_pub</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">topic</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span><span class="p">]</span>
        <span class="n">symp_pub</span><span class="o">.</span><span class="n">notes</span> <span class="o">=</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">author_notes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">text</span><span class="p">])</span>

        <span class="n">pub_id</span> <span class="o">=</span> <span class="n">source_id</span> <span class="k">if</span> <span class="n">source_id</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="p">:</span>
            <span class="n">fam</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">family_name</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">family_name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">given</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">given_name</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">given_name</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">symp_pub</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SympPerson</span><span class="p">(</span><span class="n">last_name</span><span class="o">=</span><span class="n">fam</span><span class="p">,</span> <span class="n">initials</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">given</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">fam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())))</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">rel</span> <span class="o">=</span> <span class="n">SympRelation</span><span class="p">()</span>
                <span class="n">rel</span><span class="o">.</span><span class="n">from_object</span><span class="o">=</span><span class="s2">&quot;publication(source-</span><span class="si">%s</span><span class="s2">,pid-</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pub_id</span><span class="p">)</span>
                <span class="n">rel</span><span class="o">.</span><span class="n">to_object</span><span class="o">=</span><span class="s2">&quot;user(username-</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span>
                <span class="n">rel</span><span class="o">.</span><span class="n">type_name</span><span class="o">=</span><span class="n">SympRelation</span><span class="o">.</span><span class="n">PUB_AUTHOR</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">symp_pub</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">ark_uri_from_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># generate ark uri based on the object pid</span>
        <span class="c1"># NOTE: ideally, we shouldn&#39;t have to reconstruct the ARK yuri like this</span>
        <span class="c1"># but presumably the stub objects we get from symplectic don&#39;t</span>
        <span class="c1"># store the full ARK anywhere in the metadata that we can access</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">ark:/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PIDMAN_HOST</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">PID_NAAN</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">noid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># if DEV_ENV is configured and pidman is not, use absolute local</span>
            <span class="c1"># url as a stand-in for the ARK</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;DEV_ENV&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">absolutize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
            <span class="c1"># otherwise, re-raise the errro</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">ark_identifier_from_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># short-form ark identifier, starting with just ark:/</span>
        <span class="n">ark_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ark_uri_from_pid</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;ark:&#39;</span> <span class="ow">in</span> <span class="n">ark_uri</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ark_uri</span><span class="p">[</span><span class="n">ark_uri</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ark:&#39;</span><span class="p">):]</span>

<div class="viewcode-block" id="Publication.from_symp"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.Publication.from_symp">[docs]</a>    <span class="k">def</span> <span class="nf">from_symp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Modifies the current object and datastreams to be a :class:`Publication`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">ManagementRepository</span><span class="p">()</span>
        <span class="c1"># Collection to which all articles will belong for use with OAI</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">PID_ALIASES</span><span class="p">[</span><span class="s1">&#39;oe-collection&#39;</span><span class="p">])</span>

        <span class="n">symp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sympAtom</span><span class="o">.</span><span class="n">content</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">content</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
        <span class="c1"># object attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">coll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descMetadata</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;descMetadata(MODS)&#39;</span>

        <span class="c1"># determine ark uri based on the pid</span>
        <span class="n">ark_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ark_uri_from_pid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">identifier_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ark_uri</span><span class="p">)</span>
        <span class="c1"># full ark</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">ark_uri</span> <span class="o">=</span> <span class="n">ark_uri</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">ark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ark_identifier_from_pid</span><span class="p">()</span>

        <span class="n">mods</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">publisher</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">publication_place</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pub_place</span>

        <span class="c1">#RELS-EXT attributes</span>
        <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;journal article&quot;</span><span class="p">:</span>
            <span class="c1"># changed because we can&#39;t use this in tandem with adding adding a collection to relsext</span>

            
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PUBLICATION_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>

            <span class="c1"># for cmodel in getattr(Article, &#39;CONTENT_MODELS&#39;, ()):</span>
            <span class="c1">#     self.rels_ext.content.add((self.uriref, relsextns.hasModel,</span>
            <span class="c1">#                            URIRef(cmodel)))</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Article&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_journal</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_volume</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_number</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_final_version</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">issue</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="s1">&#39;doi:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">symp</span><span class="o">.</span><span class="n">doi</span>
            <span class="c1"># self.dc.content.identifier_list.extend([self.access_url,</span>
            <span class="c1">#                                    &#39;PMC%d&#39; % self.pmcid])</span>

            <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_pages</span><span class="p">()</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">begin_page</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end_page</span> <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end_page</span> <span class="k">else</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">begin_page</span>

            <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">publisher</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">journal</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">journals</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_journal_title</span><span class="p">(</span><span class="n">symp</span><span class="o">.</span><span class="n">journal</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;starts&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">journal</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="n">journal_suggestion_data</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span> <span class="k">for</span> <span class="n">journal</span> <span class="ow">in</span> <span class="n">journals</span><span class="p">]</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">publishers</span> <span class="o">=</span> <span class="n">romeo</span><span class="o">.</span><span class="n">search_publisher_name</span><span class="p">(</span><span class="n">symp</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span> <span class="n">versions</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[</span><span class="n">publisher_suggestion_data</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span> <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">]</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">elif</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;book&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BOOK_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>
            
            <span class="c1"># for cmodel in getattr(Book, &#39;CONTENT_MODELS&#39;, ()):</span>
            <span class="c1">#     self.rels_ext.content.add((self.uriref, relsextns.hasModel,</span>
            <span class="c1">#                            URIRef(cmodel)))</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Book&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_book</span><span class="p">()</span>
            <span class="c1"># until we figure out where to put series mods</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">series</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">edition</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">edition</span>


        <span class="k">elif</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;chapter&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHAPTER_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>
            
            <span class="c1"># for cmodel in getattr(Chapter, &#39;CONTENT_MODELS&#39;, ()):</span>
            <span class="c1">#     self.rels_ext.content.add((self.uriref, relsextns.hasModel,</span>
            <span class="c1">#                            URIRef(cmodel)))</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Chapter&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_book</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_chapter</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">series</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">series</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">edition</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">edition</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">book_title</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">book_title</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">chapter</span><span class="o">.</span><span class="n">chapter_num</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">chapter_num</span>
            <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">chapter</span><span class="o">.</span><span class="n">create_pages</span><span class="p">()</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">chapter</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">begin_page</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">chapter</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end_page</span> <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end_page</span> <span class="k">else</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">begin_page</span>

        <span class="k">elif</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;conference&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONFERENCE_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>
            
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Conference&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_conference</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">conference_name</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">conference_name</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">conference_start</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">conference_start</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">conference_end</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">conference_end</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">conference_place</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">conference_place</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">issue</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">issue</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">proceedings_title</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">journal</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">create_volume</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">create_number</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_final_version</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">volume</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">issue</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="s1">&#39;doi:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">symp</span><span class="o">.</span><span class="n">doi</span>
            <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">create_pages</span><span class="p">()</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">begin_page</span>
                <span class="n">mods</span><span class="o">.</span><span class="n">conference</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end_page</span> <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">end_page</span> <span class="k">else</span> <span class="n">symp</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">begin_page</span>


        <span class="k">elif</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;poster&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTER_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>
            
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Poster&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_poster</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">poster</span><span class="o">.</span><span class="n">conference_name</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">conference_name</span>

        <span class="k">elif</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPORT_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>
            
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Report&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_report</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">sponsor</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">sponsor</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_title</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">report_title</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_number</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">report_number</span>

        <span class="k">elif</span> <span class="n">symp</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;presentation&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PRESENTATION_CONTENT_MODEL</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rels_ext</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">uriref</span><span class="p">,</span> <span class="n">relsextns</span><span class="o">.</span><span class="n">hasModel</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ARTICLE_CONTENT_MODEL</span><span class="p">)))</span>
            
            <span class="n">mods</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="s1">&#39;Presentation&#39;</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">create_presentation</span><span class="p">()</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">presentation</span><span class="o">.</span><span class="n">presentation_place</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">presentation_place</span>


        <span class="c1"># DS mapping for all content types</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">create_abstract</span><span class="p">()</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">create_final_version</span><span class="p">()</span>
        <span class="c1"># mods ARK set above when ARK is added to dc:identifier</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">title</span>
        <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">doi</span><span class="p">:</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">final_version</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://dx.doi.org/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">symp</span><span class="o">.</span><span class="n">doi</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">abstract</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">language_code</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">language</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">language</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">symp</span><span class="o">.</span><span class="n">pubdate</span><span class="p">:</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">publication_date</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">pubdate</span><span class="o">.</span><span class="n">date_str</span>


        <span class="n">mods</span><span class="o">.</span><span class="n">embargo</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">embargo</span>

        <span class="n">mods</span><span class="o">.</span><span class="n">calculate_embargo_end</span><span class="p">()</span>

        <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">symp</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">kw</span><span class="p">))</span>

        <span class="n">mods</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">affiliation</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;openemory/world_universities_and_domains.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">symp</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">AuthorName</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">affiliation</span><span class="o">=</span><span class="s1">&#39;Emory University&#39;</span><span class="p">,</span> <span class="n">given_name</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">family_name</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">symp</span><span class="o">.</span><span class="n">authors</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">symp</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">last_name</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">last_name</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">AuthorName</span><span class="p">(</span><span class="n">affiliation</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">affiliation</span><span class="p">,</span> <span class="n">given_name</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">initials</span><span class="p">,</span> <span class="n">family_name</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1">#adding all people involved in the article regardless Emory affiliation. Waiting for input from symplectic</span>

        <span class="c1"># for person in symp.people:</span>
        <span class="c1">#     for result in data1:</span>
        <span class="c1">#         if re.match(result[&#39;domain&#39;], person.email):</span>
        <span class="c1">#             affiliation = result[&#39;name&#39;]</span>
        <span class="c1">#             break</span>
        <span class="c1">#     if person.email:</span>
        <span class="c1">#         if re.match(&quot;@emory.edu&quot;, person.email):</span>
        <span class="c1">#             b = AuthorName(id=person.username.lower(), affiliation=&#39;Emory University&#39;, given_name=u.first_name, family_name=u.last_name)</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             b = AuthorName(id=person.username.lower(), affiliation=affiliation, given_name=u.first_name, family_name=u.last_name)</span>
        <span class="c1">#     mods.authors.append(b)</span>


        <span class="n">mods</span><span class="o">.</span><span class="n">create_admin_note</span><span class="p">()</span>
        <span class="n">mods</span><span class="o">.</span><span class="n">admin_note</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">symp</span><span class="o">.</span><span class="n">comment</span></div></div>


<span class="c1"># expand</span>
<span class="c1"># class Book(Publication):</span>
<span class="c1">#      BOOK_CONTENT_MODEL = &#39;info:fedora/emory-control:PublishedBook-1.0&#39;</span>
<span class="c1">#      CONTENT_MODELS = [ BOOK_CONTENT_MODEL ]</span>
<span class="c1">#      # CONTENT_MODELS = [ Publication.PUBLICATION_CONTENT_MODEL, BOOK_CONTENT_MODEL ]</span>

<span class="c1"># class Chapter(Publication):</span>
<span class="c1">#      CHAPTER_CONTENT_MODEL = &#39;info:fedora/emory-control:PublishedChapter-1.0&#39;</span>
<span class="c1">#      CONTENT_MODELS = [ CHAPTER_CONTENT_MODEL ]</span>
<span class="c1">#      # CONTENT_MODELS = [ Publication.PUBLICATION_CONTENT_MODEL, CHAPTER_CONTENT_MODEL ]</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">Publication</span><span class="p">):</span>
     <span class="n">ARTICLE_CONTENT_MODEL</span> <span class="o">=</span> <span class="s1">&#39;info:fedora/emory-control:PublishedArticle-1.0&#39;</span>
     <span class="n">CONTENT_MODELS</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ARTICLE_CONTENT_MODEL</span> <span class="p">]</span>
     <span class="c1"># CONTENT_MODELS = [ Publication.PUBLICATION_CONTENT_MODEL, ARTICLE_CONTENT_MODEL ]</span>

<div class="viewcode-block" id="ArticleRecord"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.ArticleRecord">[docs]</a><span class="k">class</span> <span class="nc">ArticleRecord</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># place-holder class for custom permissions</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># add, change, delete are avilable by default</span>
            <span class="p">(</span><span class="s1">&#39;review_article&#39;</span><span class="p">,</span> <span class="s1">&#39;Can review articles&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;view_embargoed&#39;</span><span class="p">,</span> <span class="s1">&#39;Can view embargoed content&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;view_admin_metadata&#39;</span><span class="p">,</span> <span class="s1">&#39;Can view admin metadata content&#39;</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ArticleStatistics"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.ArticleStatistics">[docs]</a><span class="k">class</span> <span class="nc">ArticleStatistics</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Aggregated access statistics for a single :class:`Article`.</span>
<span class="sd">    Subdivided by year and quarter to allow quarterly reporting.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># stats are collected (currently) for a particular pid in a particular</span>
    <span class="c1"># year and quarter. if we ever calculate them, e.g., per-month, then that&#39;ll go here</span>
    <span class="c1"># too (and below in unique_together)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">quarter</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span> <span class="c1">#1, 2, 3, 4</span>

    <span class="c1"># the things we store for this pid/year/quarter</span>
    <span class="n">num_views</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;metadata view page loads&#39;</span><span class="p">)</span>
    <span class="n">num_downloads</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;article PDF downloads&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;pid&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s1">&#39;Article Statistics&#39;</span></div>


<span class="c1">### simple XmlObject mapping to access LOC codelist document for MARC</span>
<span class="c1">### language names &amp; codes</span>

<span class="n">CODELIST_NS</span> <span class="o">=</span> <span class="s2">&quot;info:lc/xmlns/codelist-v1&quot;</span>

<span class="k">class</span> <span class="nc">CodeListBase</span><span class="p">(</span><span class="n">xmlmap</span><span class="o">.</span><span class="n">XmlObject</span><span class="p">):</span>
    <span class="c1"># base class for CodeList xml objects</span>
    <span class="n">ROOT_NS</span> <span class="o">=</span> <span class="n">CODELIST_NS</span>
    <span class="n">ROOT_NAMESPACES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">CODELIST_NS</span> <span class="p">}</span>

<span class="k">class</span> <span class="nc">CodeListLanguage</span><span class="p">(</span><span class="n">CodeListBase</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:name&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:code&#39;</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:uri&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CodeList</span><span class="p">(</span><span class="n">CodeListBase</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:codelistId&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:title&#39;</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:author&#39;</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;c:uri&#39;</span><span class="p">)</span>
    <span class="n">languages</span> <span class="o">=</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">NodeListField</span><span class="p">(</span><span class="s1">&#39;c:languages/c:language&#39;</span><span class="p">,</span>
                                     <span class="n">CodeListLanguage</span><span class="p">)</span>

<div class="viewcode-block" id="marc_language_codelist"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.marc_language_codelist">[docs]</a><span class="k">def</span> <span class="nf">marc_language_codelist</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Initialize and return :class:`CodeList` instance from the MARC</span>
<span class="sd">    languages Code List.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">marc_languages_xml</span> <span class="o">=</span> <span class="s1">&#39;http://www.loc.gov/standards/codelists/languages.xml&#39;</span>
    <span class="c1"># NOTE: for now, rely on HTTP caching as we do for XML Schemas</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading MARC language code list from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">marc_languages_xml</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xmlmap</span><span class="o">.</span><span class="n">load_xmlobject_from_file</span><span class="p">(</span><span class="n">marc_languages_xml</span><span class="p">,</span>
                                           <span class="n">xmlclass</span><span class="o">=</span><span class="n">CodeList</span><span class="p">)</span></div>


<span class="c1"># SKOS namespace for UMI/ProQuest research fields</span>

<span class="c1"># classes &amp; properties copied from http://www.w3.org/2009/08/skos-reference/skos.html</span>
<span class="n">skos_terms</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Collection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Concept&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ConceptSchema&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OrderedCollection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;altLabel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;broadMatch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;broder&#39;</span><span class="p">,</span>
    <span class="s1">&#39;broaderTransitive&#39;</span><span class="p">,</span>
    <span class="s1">&#39;changeNote&#39;</span><span class="p">,</span>
    <span class="s1">&#39;closeMatch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;definition&#39;</span><span class="p">,</span>
    <span class="s1">&#39;editorialNote&#39;</span><span class="p">,</span>
    <span class="s1">&#39;exactMatch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;example&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hasTopConcept&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hiddenLabel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;historyNote&#39;</span><span class="p">,</span>
    <span class="s1">&#39;inSchema&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mappingRelation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;member&#39;</span><span class="p">,</span>
    <span class="s1">&#39;memberlist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;narrowMatch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;narrow&#39;</span><span class="p">,</span>
    <span class="s1">&#39;notation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;note&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prefLabel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;related&#39;</span><span class="p">,</span>
    <span class="s1">&#39;relatedMatch&#39;</span><span class="p">,</span>
    <span class="s1">&#39;scopeNote&#39;</span><span class="p">,</span>
    <span class="s1">&#39;semanticRelation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;topConceptOf&#39;</span>
<span class="p">]</span>


<span class="n">SKOS</span> <span class="o">=</span> <span class="n">ClosedNamespace</span><span class="p">(</span><span class="s1">&#39;http://www.w3.org/2004/02/skos/core#&#39;</span><span class="p">,</span>
                          <span class="n">skos_terms</span><span class="p">)</span>

<div class="viewcode-block" id="ResearchFields"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.ResearchFields">[docs]</a><span class="k">class</span> <span class="nc">ResearchFields</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper-class for access to UMI/ProQuest research fields (also</span>
<span class="sd">    known as Subject Categories).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># for now, use local copy; may move to http://pid.emory.edu/ns/ or similar</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;publication&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;fixtures&#39;</span><span class="p">,</span> <span class="s1">&#39;umi-researchfields.xml&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">rff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">parse_rdf</span><span class="p">(</span><span class="n">rff</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># loop through all collections to get hierarchy information</span>
        <span class="c1"># and find the top-level collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">subjects</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="n">SKOS</span><span class="o">.</span><span class="n">Collection</span><span class="p">):</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">subjects</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="n">SKOS</span><span class="o">.</span><span class="n">member</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parents</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># error if toplevel is not found ?</span>

    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">URIRef</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>


<div class="viewcode-block" id="ResearchFields.as_field_choices"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.ResearchFields.as_field_choices">[docs]</a>    <span class="k">def</span> <span class="nf">as_field_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate and a list of choices, based on the SKOS</span>
<span class="sd">        collection hierarchy, that can be used with a</span>
<span class="sd">        :class:`django.forms.ChoiceField`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_choices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_choices</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_flatten_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sort and flatten a nested list of choices (as returned by</span>
<span class="sd">        :meth:`_get_choices`) into a two-level format that can be used</span>
<span class="sd">        as the choices for a :class:`django.forms.ChoiceField`.</span>

<span class="sd">        Groups that *only* contain sublists will be added to the</span>
<span class="sd">        flattened list as an empty group; nested group labels will</span>
<span class="sd">        have a prefix added to indicate the hierarchy.</span>

<span class="sd">        :param choices: list of [id,val] entries OR a list of [label,</span>
<span class="sd">             [choices]], where sublists may recurse :param prefix:</span>
<span class="sd">             optional prefix; add to subgroup labels to indicate</span>
<span class="sd">             hierarchy in the flattened list (should only be used when</span>
<span class="sd">             recursing to flatten a sublist)</span>

<span class="sd">        :returns: a list with at most two-levels of nesting, for use</span>
<span class="sd">             as choices value for a :class:`django.forms.ChoiceField`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">flat_choices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">choices</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># this group only has sublists; add empty group marker</span>
                    <span class="n">flat_choices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">choice</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[]])</span>
                    <span class="c1"># prefix sublabels with &#39;-&#39; and recurse</span>
                    <span class="n">flattened</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flatten_choices</span><span class="p">(</span><span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">flattened</span><span class="p">:</span>
                        <span class="n">flat_choices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flattened</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">val</span><span class="p">,</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># this group only has values, no list - add as-is</span>
                    <span class="n">flat_choices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">choice</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># group has a mixture of subchoices and sublists</span>
                    <span class="c1"># gather all the values and add them</span>
                    <span class="n">subchoices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                            <span class="n">subchoices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">label</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>
                    <span class="n">flat_choices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">choice</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">subchoices</span><span class="p">])</span>

                    <span class="c1"># add each of the sublists with a &#39;-&#39; prefix</span>
                    <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">flat_choices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">sublist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sublist</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

        <span class="k">return</span> <span class="n">flat_choices</span>

    <span class="k">def</span> <span class="nf">_get_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert the SKOS collection hierarchy into nested</span>
<span class="sd">        lists. The nested list structure generated roughly follows the</span>
<span class="sd">        format needed for specifing choice options to a</span>
<span class="sd">        :class:`django.forms.ChoiceField`, except that the return</span>
<span class="sd">        result nests as deeply as the SKOS hierarchy goes</span>
<span class="sd">        (:class:`~django.forms.ChoiceField` only supports one level of</span>
<span class="sd">        nesting).</span>

<span class="sd">        :param id: optional id of the collection to get choices for;</span>
<span class="sd">           if none is specified, the top-level collection id will be</span>
<span class="sd">           used.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_choices</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span><span class="p">]]</span>
        <span class="c1"># check if item has members</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="nb">id</span><span class="p">]:</span>
            <span class="c1"># find all the members that don&#39;t themselves have children</span>
            <span class="n">member_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_choices</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="nb">id</span><span class="p">]]</span>

            <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="nb">id</span><span class="p">)),</span> <span class="n">member_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="nb">id</span><span class="p">))]</span>


<div class="viewcode-block" id="ResearchFields.as_category_completion"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.ResearchFields.as_category_completion">[docs]</a>    <span class="k">def</span> <span class="nf">as_category_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Flatten the SKOS hierarchy into a list of dictionaries that</span>
<span class="sd">        can be used as the basis for a category-based jQueryUI</span>
<span class="sd">        autocomplete (see http://jqueryui.com/demos/autocomplete/#categories ).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_category_data</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_category_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Recursive function to generate a category list for</span>
<span class="sd">        :meth:`as_category_completion`.</span>

<span class="sd">        :param id: id for the portion of the hierarchy to handle;</span>
<span class="sd">            if not specified, assumes top-level</span>
<span class="sd">        :param category: category prefix to be applied to items at the</span>
<span class="sd">            current level of the hierarchy.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">category_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># recurse from top-level of hierarchy with no label</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span><span class="p">]:</span>
                <span class="n">category_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_category_data</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">category_list</span>

        <span class="c1"># item with members</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="nb">id</span><span class="p">]:</span>
            <span class="c1"># add current heading to subcategory</span>
            <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">subcategory</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subcategory</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="c1"># recurse with subcategory label</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy</span><span class="p">[</span><span class="nb">id</span><span class="p">]:</span>
                <span class="n">category_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_category_data</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">subcategory</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">category_list</span>

        <span class="c1"># single item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itemdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s2">&quot;id</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="nb">id</span><span class="p">))}</span>
            <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">itemdata</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">itemdata</span><span class="p">]</span></div>

<div class="viewcode-block" id="FeaturedArticle"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.FeaturedArticle">[docs]</a><span class="k">class</span> <span class="nc">FeaturedArticle</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    List of pid associated with article that are marked as Featured. One of these is</span>
<span class="sd">    selected at random and displayed on the homepage in the</span>
<span class="sd">    Slider.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">solr</span> <span class="o">=</span> <span class="n">solr_interface</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">field_limit</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">title</span></div>

<div class="viewcode-block" id="License"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.License">[docs]</a><span class="k">class</span> <span class="nc">License</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">short_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span>  <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()</span></div>


<div class="viewcode-block" id="LastRun"><a class="viewcode-back" href="../../../apidocs.html#openemory.publication.models.LastRun">[docs]</a><span class="k">class</span> <span class="nc">LastRun</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">OpenEmory 2.2.8-dev documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2011, Emory University Libraries.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>